{% load static %}
<style>
  .warning-message {
    color: darkorange !important;
    display: none; /* Hide by default */
    margin-top: 10px;
  }
  .confirmation-btns {
    margin-top: 10px;
  }
  .confirmation-btns a {
    padding: 5px 10px;
    cursor: pointer;
  }
  .accept-btn {
    background-color: #28a745;
    color: white;
    border-radius: 5px;
  }
  .cancel-btn {
    background-color: #dc3545;
    color: white;
    border-radius: 5px;
  }

  .remove-user-btn {
    background-color: red;
    color: white;
    padding: 5px;
    margin-left: 10px;
    cursor: pointer;
    border-radius: 3px;
  }

  .permission-column {
    width: 60%; /* Adjust default width */
    transition: width 0.3s ease;
  }

  .permission-column.expanded {
    width: 80%; /* Adjust width when warning message is shown */
  }
</style>

<div class="row">
  <div class="col-12">
    <div class="content-header">Workflow</div>
  </div>
</div>

<!-- Wizard Starts -->
<section id="multiple-select2">
  <div class="row">
    <div class="col-xl-12 col-lg-12">
      <div class="card">
        <div class="card-header">
          <h4 class="card-title">Shipping Order</h4>
        </div>
        <div class="card-body">
          <div class="card-content">
            <div class="row">
              <div class="col-6">
                <div class="table-responsive">
                  <table class="table table-striped table-bordered" id="rental-workflow">
                    <tbody>
                      {% for permission in permissions %}
                      <tr>
                        <th scope="row">{{ permission.name }}</th>
                        <td class="permission-column" id="permissionColumn_{{ permission.id }}">
                          <select class="select2-list form-control" multiple id="permission_{{ permission.id }}">
                            {% for user in users %}
                              <option value="{{ user.id }}"
                                {% if user in permission.user_permissions.all %}selected{% endif %}>
                                {{ user.full_name }}
                              </option>
                            {% endfor %}
                          </select>

                          <span id="warningMessage_{{ permission.id }}" class="warning-message">
                            <i class="ft-alert-triangle"></i> This person does not have access,
                            <a class="" onclick="confirmPermissionChange({{ permission.id }}, true)">
                              <i class="ft-check success"></i>
                            </a>
                            <a class="" onclick="confirmPermissionChange({{ permission.id }}, false)">
                              <i class="ft-x danger"></i>
                            </a>
                          </span>
                        </td>
                      </tr>
                      {% endfor %}
                    </tbody>
                  </table>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
</section>

<script src="{% static 'app/js/jquery.min.js' %}"></script>
<script src="{% static 'vendors/js/select2.full.min.js' %}"></script>
<script src="{% static 'app/js/select2.min.js' %}"></script>

<script>
  $(document).ready(function () {
    const initialPermissionUsers = {};

    {% for permission in permissions %}
        initialPermissionUsers[{{ permission.id }}] = [
            {% for user in permission.user_permissions.all %}
                "{{ user.id }}",
            {% endfor %}
        ];
    {% endfor %}

    function handlePermissionChange(permissionId) {
        const $permissionSelect = $("#permission_" + permissionId);
        const currentSelection = $permissionSelect.val() || [];
        const initialSelection = initialPermissionUsers[permissionId] || [];

        const removedUsers = initialSelection.filter(userId => !currentSelection.includes(userId));
        const addedUsers = currentSelection.filter(userId => !initialSelection.includes(userId));

        const $warningMessage = $(`#warningMessage_${permissionId}`);
        const $permissionColumn = $(`#permissionColumn_${permissionId}`);

        if (removedUsers.length > 0) {
            showWarningMessage(permissionId, "remove");
        } else if (addedUsers.length > 0) {
            showWarningMessage(permissionId, "add");
        } else {
            $warningMessage.hide();
        }
    }

    function showWarningMessage(permissionId, action) {
        const $warningMessage = $(`#warningMessage_${permissionId}`);
        const actionText = action === 'remove' ?
            `Are you sure you want to remove these users?` :
            `These persons do not have access, <br><small style="color: cadetblue;">Give Access?</small>`;

        $warningMessage.html(`
            <i class="ft-alert-triangle"></i>
            ${actionText}
            <a onclick="confirmPermissionChange(${permissionId}, true, '${action}')">
                <i class="ft-check success"></i>
            </a>
            <a onclick="confirmPermissionChange(${permissionId}, false)">
                <i class="ft-x danger"></i>
            </a>
        `);
        $warningMessage.show();
    }

    $(".select2-list").select2({
        width: "100%",
        multiple: true,
    });

    $(".select2-list").on("change", function () {
        const permissionId = $(this).attr("id").split("_")[1];
        handlePermissionChange(permissionId);
    });

    window.confirmPermissionChange = function (permissionId, accept, action) {
        if (accept) {
            const updatedUsers = $("#permission_" + permissionId).val() || [];
            $.ajax({
                url: "{% url 'rental:rental_workflow:workflow' %}",
                method: "POST",
                data: {
                    permission_id: permissionId,
                    selected_users: updatedUsers.join(","),
                    action: action,
                    csrfmiddlewaretoken: "{{ csrf_token }}",
                },
                success: function () {
                    window.location.reload();
                },
                error: function (xhr) {
                    console.error("Error updating permission: " + xhr.responseText);
                }
            });
        } else {
            $("#permission_" + permissionId).val(initialPermissionUsers[permissionId]).trigger("change");
        }

        $(`#warningMessage_${permissionId}`).hide();
    };
});

</script>