{% load static %}
<style>
  /* Adjust column widths */
  .order-item-row td:nth-child(2) { /* Equipment ID */
      min-width: 150px; 
      max-width: 180px;
  }

  .order-item-row td:nth-child(3) { /* Equipment Name */
      min-width: 220px; /* Wider than Equipment ID */
      max-width: 280px;
  }

  /* Reduce width of other columns */
  .order-item-row td:nth-child(4), /* Quantity */
  .order-item-row td:nth-child(5) { /* Per Unit Price */
      width: 100px;
  }

  /* Button column should not take too much space */
  .order-item-row td:last-child {
      width: 80px;
      text-align: center;
  }

  /* Ensure Select2 adapts */
  .select2-container {
      width: 100% !important;
  }

  
</style>

{% load crispy_forms_tags %}
<form method="post" hx-post="{% url 'rental:rent_process:order-create' %}" enctype="multipart/form-data">
  {% csrf_token %}
  <div class="modal-body">
    <div class="row">
      <div class="col-6">
        {% if permission.customer %}
        <label>Customer<span class="asteriskField text-danger">*</span></label>
        {% else %}
        <label>Customer</label>
        {% endif %}
        <div class="form-group">
          {{ form.customer }}
        </div>
      </div>

      <div class="col-6">
        {% if permission.link_netsuite %}
          <label>Link NetSuite<span class="asteriskField text-danger">*</span></label>
        {% else %}
          <label>Link NetSuite</label>
        {% endif %}
        <div class="form-group">
          {{ form.link_netsuite }}
        </div>
      </div>

      <div class="col-6">
        {% if permission.account_manager %}
          <label>Account Manager<span class="asteriskField text-danger">*</span></label>
        {% else %}
          <label>Account Manager</label>
        {% endif %}
        <div class="form-group">
          {{ form.account_manager }}
        </div>
      </div>

      <div class="col-6">
        {% if permission.region %}
          <label>Region<span class="asteriskField text-danger">*</span></label>
        {% else %}
          <label>Region</label>
        {% endif %}
        <div class="form-group">
          {{ form.region }}
        </div>
      </div>

      <div class="col-6">
        {% if permission.customer_email %}
          <label>Customer Email<span class="asteriskField text-danger">*</span></label>
        {% else %}
          <label>Customer Email</label>
        {% endif %}
        <div class="form-group">
          {{ form.customer_email }}
        </div>
      </div>

      <div class="col-6">
        {% if permission.pick_up_location %}
          <label>Pick-Up Location<span class="asteriskField text-danger">*</span></label>
        {% else %}
          <label>Pick-Up Location</label>
        {% endif %}
        <div class="form-group">
          {{ form.pick_up_location }}
        </div>
      </div>

      <div class="col-6">
        {% if permission.delivery_location %}
          <label>Delivery Location<span class="asteriskField text-danger">*</span></label>
        {% else %}
          <label>Delivery Location</label>
        {% endif %}
        <div class="form-group">
          {{ form.delivery_location }}
        </div>
      </div>

      <div class="col-6">
        {% if permission.water_source %}
          <label>Water Source<span class="asteriskField text-danger">*</span></label>
        {% else %}
          <label>Water Source</label>
        {% endif %}
        <div class="form-group">
          {{ form.water_source }}
        </div>
      </div>

      <div class="col-12">
        {% if permission.crop %}
          <label>Crop<span class="asteriskField text-danger">*</span></label>
        {% else %}
          <label>Crop</label>
        {% endif %}
        <div class="form-group">
          {{ form.crop }}
        </div>
      </div>

      <div class="col">
        <table id="tableBody" class="table">
          {{ order_item_formset.management_form }}
          <thead>
            <tr>
              {% if permission.equipment_id %}
                <th>Item No<span class="asteriskField text-danger">*</span></th>
              {% else %}
                <th>Item No</th>
              {% endif %}
              {% if permission.equipment_name %}
                <th>Item<span class="asteriskField text-danger">*</span></th>
              {% else %}
                <th>Item</th>
              {% endif %}
              {% if permission.quantity %}
                <th>Quantity<span class="asteriskField text-danger">*</span></th>
              {% else %}
                <th>Quantity</th>
              {% endif %}
              {% if permission.per_unit_price %}
                <th>Per Unit Price<span class="asteriskField text-danger">*</span></th>
              {% else %}
                <th>Per Unit Price</th>
              {% endif %}
              <th></th>
            </tr>
          </thead>
          <tbody id="order-item-formset">
            {% for item_form in order_item_formset %}
            <tr class="order-item-row">
              <td class="d-none">{{ item_form.product }}</td>
              <td>{{ item_form.equipment_id }}</td>
              <td>{{ item_form.equipment_name }}</td>
              <td>{{ item_form.quantity }}</td>
              <td>{{ item_form.per_unit_price }}</td>
              <td class="d-flex">
                <button type="button" class="btn btn-danger mr-2" onclick="removeRow(this)">
                  <i class="fa fa-trash"></i>
                </button>
                <button type="button" class="btn btn-primary" onclick="addNewRow()">
                  <i class="fa fa-plus"></i>
                </button>
              </td>
            </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>
      <div class="col-6">
        {% if permission.rent_amount %}
          <label>Rent Amount<span class="asteriskField text-danger">*</span></label>
        {% else %}
          <label>Rent Amount</label>
        {% endif %}
        <div class="form-group">
          {{ form.rent_amount }}
        </div>
      </div>

      <div class="col">
        {% if permission.rental_period %}
          <label class="form-label font-weight-bold"><span class="asteriskField text-danger">*</span>Rental Period</label>
        {% else %}
          <label class="form-label font-weight-bold">Rental Period</label>
        {% endif %}
        <div class="reportrange form-control" id="daterangepicker">
          <i class="fa fa-calendar"></i>&nbsp;
          <span id="rentalPeriod">Select Date Range</span> <!-- Value set karna -->
          <i class="fa fa-caret-down"></i>
        </div>
      </div>
      {{ form.rental_start_date }}
      {{ form.rental_end_date }}

      <div class="col-5">
        {% if permission.rent_per_month %}
          <label>Rent Per Month<span class="asteriskField text-danger">*</span></label>
        {% else %}
          <label>Rent Per Month</label>
        {% endif %}
        <div class="form-group">
          {{ form.rent_per_month }}
        </div>
      </div>

      <div class="col-12">
        <div class="form-group">
          <div class="row mb-2 pl-2">
            <div class="d-flex flex-row-reverse align-items-center h-100">
              {{ form.recurring_order }}
              {% if permission.recurring_order %}
                <label for="recurring-checkbox" class="ml-1 mr-3 mb-0">Recurring Order<span class="asteriskField text-danger">*</span></label>
              {% else %}
                <label for="recurring-checkbox" class="ml-1 mr-3 mb-0">Recurring Order</label>
              {% endif %}
            </div>
          </div>
        </div>
      </div>

      <div class="card recurring" style="border: 1px solid darkgray; padding: 0px 0px 0px 20px;">
        <div class="card-header">
          <h6 class="mt-2"><i class="ft-check-circle mr-2"></i>Recurring</h6>
        </div>
        <div class="card-content">
          <div class="card-body">
            <div class="row">
              <div class="col-4">
                <div class="d-flex mb-2" style="gap: 10px;">
                  {% if permission.repeat_type %}
                    <label class="form-label">Repeats:<span class="asteriskField text-danger">*</span></label>
                  {% else %}
                    <label class="form-label">Repeats:</label>
                  {% endif %}
                  {{ form.repeat_type }}
                </div>
              </div>
              <div class="col-6">
                <div class="d-flex mb-2" style="gap: 10px;">
                  {% if permission.repeat_value %}
                    <label class="form-label">For :<span class="asteriskField text-danger">*</span></label>
                  {% else %}
                    <label class="form-label">For :</label>
                  {% endif %}
                  {{ form.repeat_value }}
                  <span id="timeUnit"></span>
                </div>
              </div>
              <div class="col-12 mb-2">
                <div class="d-flex mb-2" style="gap: 10px;">
                  {% if permission.repeat_start_date %}
                    <label class="form-label">From :<span class="asteriskField text-danger">*</span></label>
                  {% else %}
                    <label class="form-label">From :</label>
                  {% endif %}
                  {{ form.repeat_start_date }}
                  {% if permission.repeat_end_date %}
                    <label class="form-label">To :<span class="asteriskField text-danger">*</span></label>
                  {% else %}
                    <label class="form-label">To :</label>
                  {% endif %}
                  {{ form.repeat_end_date }}
                  <input type="hidden" id="hidden_endDate" name="repeat_end_date">
                </div>
              </div>
              <div class="col-12">
                <small id="message"></small>
              </div>
            </div>
          </div>
        </div>
      </div>

    </div>
  </div>
  <div class="modal-footer">
    <input type="reset" class="btn bg-light-secondary" data-dismiss="modal" value="Close">
    <button type="submit" class="btn btn-primary">Add Order</button>
  </div>
</form>
<!-- Js Start -->

<!-- Load Select2 CSS and JS -->
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/daterangepicker/daterangepicker.css" />
<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/js/select2.min.js"></script>
<script type="text/javascript" src="{% static 'datepicker/moment.min.js' %}"></script>
<script type="text/javascript" src="{% static 'datepicker/daterangepicker.min.js' %}" defer></script>
<script src="https://cdn.jsdelivr.net/npm/moment/min/moment.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/daterangepicker/moment.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/daterangepicker/daterangepicker.min.js"></script>
<script src="{% static 'app/js/ex-component-upload.min.js' %}"></script>
<!-- Js End -->

<!-- Date picker End -->
<!-- Add Selecet 2 -->
<script>
  $(document).ready(function() {
    
    
    if ($.fn.select2 && $.fn.select2.amd) {
      $.fn.select2.amd.define('select2/compat/matcher', [], function () {
        return function(params, data) {
          if ($.trim(params.term) === '') {
            return data;
          }
          if (typeof data.text === 'undefined') {
            return null;
          }
          if (data.text.toLowerCase().indexOf(params.term.toLowerCase()) > -1) {
            return data;
          }
          return null;
        };
      });
    }
    var $customerSelect = $("#id_customer");
    var initialData = [];
    
    $customerSelect.find("option").each(function() {
      var val = $(this).attr("value");
      var text = $(this).text();
      if(val) { 
        initialData.push({ id: val, text: text });
      }
    });
    
    console.log("Initial Data:", initialData);
    var customer_search_url =  "{% url 'rental:rent_process:search_customers' %}"
    $customerSelect.select2({
      data: initialData,  
      ajax: {
        url: customer_search_url, 
        dataType: "json",
        delay: 250,
        data: function(params) {
          return { q: params.term };
        },
        processResults: function(data) {
          return { results: data.results };
        },
        cache: true
      },
      placeholder: "Search for a customer",
      allowClear: true,
      minimumInputLength: 0,      
      minimumResultsForSearch: 0,   
      width: '100%'
    });

    var $accountManagerSelect = $("#id_account_manager");
    var initialAccountManagerData = [];
    $accountManagerSelect.find("option").each(function() {
      var val = $(this).attr("value");
      var text = $(this).text();
      if(val) {  
        initialAccountManagerData.push({ id: val, text: text });
      }
    });
    console.log("Account Manager Initial Data:", initialAccountManagerData);
    
    var accountManagerSearchUrl = "{% url 'rental:rent_process:search_account_managers' %}";
    
    $accountManagerSelect.select2({
      data: initialAccountManagerData, 
      ajax: {
        url: accountManagerSearchUrl,  
        dataType: "json",
        delay: 250,
        data: function(params) {
          return { q: params.term };
        },
        processResults: function(data) {
          return { results: data.results };
        },
        cache: true
      },
      placeholder: "Search for an account manager",
      allowClear: true,
      minimumInputLength: 0,      
      minimumResultsForSearch: 0,   
      width: '100%'
    });

    var $pick_up_locationSelect = $("#id_pick_up_location");
    var pick_up_locationData = [];
    $pick_up_locationSelect.find("option").each(function() {
      var val = $(this).attr("value");
      var text = $(this).text();
      if (val) { 
        pick_up_locationData.push({ id: val, text: text });
      }
    });
    console.log("Pick Up Location Initial Data:", pick_up_locationData);

    var pickUpLocationSearchUrl = "{% url 'rental:rent_process:search_pick_up_location' %}";

    $pick_up_locationSelect.select2({
      data: pick_up_locationData, 
      ajax: {
        url: pickUpLocationSearchUrl,  
        dataType: "json",
        delay: 250,
        data: function(params) {
          return { q: params.term };
        },
        processResults: function(data) {
          return { results: data.results };
        },
        cache: true
      },
      placeholder: "Search for a pick-up location",
      allowClear: true,
      minimumInputLength: 0,      
      minimumResultsForSearch: 0,   
      width: '100%'
    });

    var $equipmentIdSelect = $(".order_item_equipment_id");
    var equipmentIdData = [];

    $equipmentIdSelect.find("option").each(function() {
      var val = $(this).attr("value");
      var text = $(this).text();
      if (val) {  
        equipmentIdData.push({ id: val, text: text });
      }
    });
    console.log("Equipment ID Initial Data:", equipmentIdData);

    var equipment_id_SearchUrl = "{% url 'rental:rent_process:search_rental_product_id' %}";

    $equipmentIdSelect.select2({
      data: equipmentIdData,  
      ajax: {
        url: equipment_id_SearchUrl,
        dataType: "json",
        delay: 250,
        data: function(params) {
          return { q: params.term };
        },
        processResults: function(data) {
          return { results: data.results };
        },
        cache: true
      },
      placeholder: "Search for equipment (ID)",
      allowClear: true,
      minimumInputLength: 0,
      minimumResultsForSearch: 0,
    });
    

    var equipment_name_SearchUrl = "{% url 'rental:rent_process:search_rental_product_name' %}";
    var $equipmentNameSelect = $(".order_item_equipment_name");
    var equipmentNameData = [];
    $equipmentNameSelect.find("option").each(function() {
      var val = $(this).attr("value");
      var text = $(this).text();
      if (val) {  
        equipmentNameData.push({ id: val, text: text });
      }
    });
    console.log("Equipment Name Initial Data:", equipmentNameData);
    
   
    $equipmentNameSelect.select2({
      data: equipmentNameData,
      ajax: {
        url: equipment_name_SearchUrl,
        dataType: "json",
        delay: 250,
        data: function(params) {
          return { q: params.term };
        },
        processResults: function(data) {
          return { results: data.results };
        },
        cache: true
      },
      placeholder: "Search for equipment (Name)",
      allowClear: true,
      minimumInputLength: 0,
      minimumResultsForSearch: 0,
    });
  });
</script>
<!-- Add Selecet 2 -->
 <!--Dynamic Data Of Selecet 2 -->
<script>
  var item_code_changed = false; // Prevents infinite loops

  // ðŸ”¹ Select Equipment ID â†’ Fetch Equipment Name
  $(document).on('select2:select', '.order_item_equipment_id', function (e) {
    console.log('item_code_changed: ', item_code_changed);
      if (item_code_changed) return; // Prevent looping
      item_code_changed = true;
  
      var selectedValue = $(this).val();
      var rowIndex = this.name.split('-')[1];
      var $nameSelect = $("#id_orders-" + rowIndex + "-equipment_name");
  
      console.log("Equipment ID selected:", selectedValue);
  
      $.ajax({
          url: "{% url 'rental:rent_process:search_rental_product_name' %}",
          type: "GET",
          data: { q: selectedValue },
          dataType: "json",
          success: function (data) {
              console.log("Response for Equipment ID:", data);
              if (data.results.length > 0) {
                  updateDropdown($nameSelect, data.results);
              }
          },
          error: function (xhr, status, error) {
              console.error("Error fetching Equipment Name:", xhr.responseText);
          },
          complete: function () {
              setTimeout(() => { item_code_changed = false; }, 200); // ðŸ”¹ Delay reset to prevent race conditions
          }
      });
  });
  
  // ðŸ”¹ Select Equipment Name â†’ Fetch Equipment ID
  $(document).on('select2:select', '.order_item_equipment_name', function (e) {
    console.log('item_code_changed: ', item_code_changed);
      if (item_code_changed) return; // Prevent looping
      item_code_changed = true;
  
      var selectedValue = $(this).val();
      var rowIndex = this.name.split('-')[1];
      var $idSelect = $("#id_orders-" + rowIndex + "-equipment_id");
  
      console.log("Equipment Name selected:", selectedValue);
  
      $.ajax({
          url: "{% url 'rental:rent_process:search_rental_product_id' %}",
          type: "GET",
          data: { q: selectedValue },
          dataType: "json",
          success: function (data) {
              console.log("Response for Equipment Name:", data);
              if (data.results.length > 0) {
                  updateDropdown($idSelect, data.results);
              }
          },
          error: function (xhr, status, error) {
              console.error("Error fetching Equipment ID:", xhr.responseText);
          },
          complete: function () {
              setTimeout(() => { item_code_changed = false; }, 200); // ðŸ”¹ Delay reset to prevent race conditions
          }
      });
  });
  
  // ðŸ”¹ Generic Dropdown Updater Function
  function updateDropdown($select, results) {
      console.log("Updating dropdown:", results);
      $select.empty(); // Clear old options
  
      results.forEach(item => {
          var newOption = new Option(item.text, item.id, false, false);
          $select.append(newOption);
      });
  
      if (results.length > 0) {
          $select.val(results[0].id).trigger('change'); // ðŸ”¹ Set first result as selected
      }
  }
</script>
<!-- Dynamic Data Of Selecet 2 -->

<!-- CheckBox And DatePicker -->
<script type="text/javascript">
  $(document).ready(function() {
    var recurringCheckbox = $('#recurring-checkbox');
    var rentalPeriod = $('.reportrange');

    toggleRentalPeriod(recurringCheckbox.is(':checked'));

    recurringCheckbox.on('change', function() {
      toggleRentalPeriod(this.checked);
    });

    function toggleRentalPeriod(isRecurring) {
      if (isRecurring) {
        rentalPeriod.prop('disabled', true);
        rentalPeriod.closest('.col').hide();
      } else {
        rentalPeriod.prop('disabled', false);
        rentalPeriod.closest('.col').show();
      }
    }
    setTimeout(function () {
        $('#daterangepicker').daterangepicker({
          locale: { format: 'MMMM D, YYYY' },  // Format changed to "January 16, 2025"
          startDate: moment().startOf('month'),
          endDate: moment().endOf('month'),
          opens: 'left'
        }, function(start, end) {
          $('#rentalPeriod').html(start.format('MMMM D, YYYY') + ' - ' + end.format('MMMM D, YYYY')); // Updated format
          $('#id_rental_start_date').val(start.format('YYYY-MM-DD'));
          $('#id_rental_end_date').val(end.format('YYYY-MM-DD'));
          calculateRentPerMonth(start, end);
      });
    }, 500);  // 500ms delay

    $('#daterangepicker').on('apply.daterangepicker', function(ev, picker) {
      $('#rentalPeriod').html(
          picker.startDate.format('MMMM D, YYYY') + ' - ' + picker.endDate.format('MMMM D, YYYY')
      );
      $('#id_rental_start_date').val(picker.startDate.format('YYYY-MM-DD'));
      $('#id_rental_end_date').val(picker.endDate.format('YYYY-MM-DD'));
      calculateRentPerMonth(picker.startDate, picker.endDate);
  });

    $('#rentAmount').on('change', function() {
      console.log("Rent amount input changed. New value:", $(this).val());
      var picker = $('#daterangepicker').data('daterangepicker');
      calculateRentPerMonth(picker.startDate, picker.endDate);
    });

    //$('#rentAmount').on('input', calculateRentPerMonth);

    
  });
</script>
<!-- CheckBox And DatePicker -->

<!-- Calculate Rent Per Month -->
<script>
  function calculateRentPerMonth(start, end) {
    // If start/end not provided, parse from displayed text
    if (!start || !end) {
        var period = $('#rentalPeriod').text().split(' - ');
        if (period.length !== 2) {
            console.log("Date range not set properly.");
            return;
        }
        start = moment(period[0], "MMMM D, YYYY");
        end = moment(period[1], "MMMM D, YYYY");
    }
    
    // Parse rent amount; if invalid, set to 0
    var rentAmount = parseFloat($('#rentAmount').val());
    if (isNaN(rentAmount)) {
        console.log("Rent amount is not valid. Setting to 0.");
        rentAmount = 0;
    }
    
    console.log("Calculating rent per month with amount:", rentAmount);
    console.log("From:", start.format('MMMM D, YYYY'), "to:", end.format('MMMM D, YYYY'));
    
    // Build array of month strings in the selected range
    var months = [];
    var currentMonthStart = start.clone().startOf('month');
    while (currentMonthStart <= end) {
        months.push(currentMonthStart.format('YYYY-MM'));
        currentMonthStart.add(1, 'month').startOf('month');
    }
    
    var numberOfMonths = months.length;
    var rentPerMonth = rentAmount / numberOfMonths;
    console.log("Number of months:", numberOfMonths);
    console.log("Calculated Rent per Month:", rentPerMonth.toFixed(2));
    
    var rentPerMonthText = '';
    months.forEach(function(month) {
        var formattedMonth = moment(month, "YYYY-MM").format('MMMM YYYY');
        rentPerMonthText += formattedMonth + ': ' + rentPerMonth.toFixed(2) + '\n';
        console.log("Month:", formattedMonth, "Rent:", rentPerMonth.toFixed(2));
    });
    
    // Update the Rent Per Month field
    $('#rentPerMonth').val(rentPerMonthText);
    console.log("Updated #rentPerMonth field with:\n" + rentPerMonthText);
}
</script>
<!-- Calculate Rent Per Month -->

<!-- Rant amount calculate -->
 <script>
  function updateRentAmount() {
    let totalAmount = 0;
    // Get all rows in the table body
    const rows = document.querySelectorAll('#tableBody tbody tr');
  
    rows.forEach(row => {
      const quantityInput = row.querySelector('.quantity');
      const priceInput = row.querySelector('.price');
      const quantity = parseFloat(quantityInput.value) || 0;
      const price = parseFloat(priceInput.value) || 0;
      totalAmount += quantity * price;
    });
  
    // Update the rent amount input field
    document.getElementById('rentAmount').value = totalAmount.toFixed(2);
    console.log("updateRentAmount() setting value:", totalAmount.toFixed(2));
  
    // Attempt to get the daterangepicker instance
    var picker = $('#daterangepicker').data('daterangepicker');
    if (picker && picker.startDate && picker.endDate) {
      // Pass the moment objects directly
      calculateRentPerMonth(picker.startDate, picker.endDate);
    } else {
      // Fallback: parse the displayed date range
      var period = $('#rentalPeriod').text().split(' - ');
      if (period.length === 2) {
        var start = moment(period[0], "MMMM D, YYYY");
        var end = moment(period[1], "MMMM D, YYYY");
        calculateRentPerMonth(start, end);
      } else {
        console.log("Unable to parse the date range from #rentalPeriod.");
      }
    }
    // Trigger the change event (if needed by delegated handlers)
    $('#rentAmount').trigger('change');
  }
  
  $('#rentAmount').on('input', function() {
    console.log("Rent amount input (on input) changed. New value:", $(this).val());
  });
  
 </script>
 <!-- Rant amount calculate -->

<!-- Add Row And Remove Row -->
<script>
// Generic function to update a Select2 dropdown with new options.
function updateDropdown($select, results) {
  console.log("Updating dropdown with results:", results);
  $select.empty(); // Clear existing options.
  results.forEach(function(item) {
      var newOption = new Option(item.text, item.id, false, false);
      $select.append(newOption);
  });
  if (results.length > 0) {
      $select.val(results[0].id).trigger('change');
  }
}
function addNewRow() {
  console.log("=== addNewRow() called ===");

  var formsetTable = document.getElementById("order-item-formset");
  var totalFormsInput = document.getElementById("id_orders-TOTAL_FORMS");
  var totalForms = parseInt(totalFormsInput.value, 10);

  var firstRow = formsetTable.querySelector(".order-item-row");
  if (!firstRow) {
      console.error("No row found to clone!");
      return;
  }

  console.log("Original row HTML:", firstRow.outerHTML);

  var newRow = firstRow.cloneNode(true);

  // Remove stale Select2 attributes and instances
  $(newRow).find("[data-select2-id]").removeAttr("data-select2-id");
  $(newRow).find(".select2-container").remove();
  var originalEquipmentIdWidth = $(firstRow).find(".order_item_equipment_id").next(".select2-container").width();
  var originalEquipmentNameWidth = $(firstRow).find(".order_item_equipment_name").next(".select2-container").width();
  // Update name, id attributes and reset values
  $(newRow).find("input, select").each(function() {
      if (this.name) this.name = this.name.replace(/\d+/, totalForms);
      if (this.id) this.id = this.id.replace(/\d+/, totalForms);

      if (this.tagName.toLowerCase() === "input") {
          this.value = "";
      } else if (this.tagName.toLowerCase() === "select") {
          $(this).val(null).trigger("change");
      }
  });

  // Append the new row
  formsetTable.appendChild(newRow);
  totalFormsInput.value = totalForms + 1;

  // Reinitialize Select2
  var $newEquipmentIdSelect = $(newRow).find(".order_item_equipment_id");
  var $newEquipmentNameSelect = $(newRow).find(".order_item_equipment_name");

  console.log("Reinitializing Select2 for new fields");
  initializeSelect2ForEquipmentId($newEquipmentIdSelect);
  initializeSelect2ForEquipmentName($newEquipmentNameSelect);

  //  Apply original widths to cloned Select2 fields
  $newEquipmentIdSelect.next(".select2-container").css("width", originalEquipmentIdWidth + "px");
  $newEquipmentNameSelect.next(".select2-container").css("width", originalEquipmentNameWidth + "px");
  console.log("New row added and Select2 reinitialized.");
}

// Initialize Select2 for Equipment ID
function initializeSelect2ForEquipmentId($select) {
  $select.select2({
      ajax: {
          url: "{% url 'rental:rent_process:search_rental_product_id' %}",
          dataType: "json",
          delay: 250,
          data: function(params) {
              return { q: params.term };
          },
          processResults: function(data) {
              return { results: data.results };
          },
          cache: true
      },
      placeholder: "Search for equipment (ID)",
      allowClear: true,
      width: "100%",
      dropdownParent: $select.parent()
  }).on("select2:select", function(e) {
      var selectedId = $(this).val();
      var $equipmentNameSelect = $(this).closest("tr").find(".order_item_equipment_name");
      updateEquipmentNameSelect($equipmentNameSelect, selectedId);
  });
}

// Initialize Select2 for Equipment Name
function initializeSelect2ForEquipmentName($select) {
  $select.select2({
      ajax: {
          url: "{% url 'rental:rent_process:search_rental_product_name' %}",
          dataType: "json",
          delay: 250,
          data: function(params) {
              return { q: params.term };
          },
          processResults: function(data) {
              return { results: data.results };
          },
          cache: true
      },
      placeholder: "Search for equipment (Name)",
      allowClear: true,
      width: "100%",
      dropdownParent: $select.parent()
  }).on("select2:select", function(e) {
      var selectedValue = $(this).val();
      var $equipmentIdSelect = $(this).closest("tr").find(".order_item_equipment_id");
      updateEquipmentIdSelect($equipmentIdSelect, selectedValue);
  });
}

// Update Equipment Name based on selected Equipment ID
function updateEquipmentNameSelect($select, equipmentId) {
  $.ajax({
      url: "{% url 'rental:rent_process:search_rental_product_name' %}",
      type: "GET",
      data: { q: equipmentId },
      dataType: "json",
      success: function (data) {
          console.log("Response for Equipment ID:", data);
          if (data.results.length > 0) {
              $select.empty();
              $.each(data.results, function(index, item) {
                  $select.append(new Option(item.text, item.id, false, false));
              });
              $select.trigger("change");
          }
      },
      error: function (xhr, status, error) {
          console.error("Error fetching Equipment Name:", xhr.responseText);
      }
  });
}

// Update Equipment ID based on selected Equipment Name
function updateEquipmentIdSelect($select, equipmentName) {
  $.ajax({
      url: "{% url 'rental:rent_process:search_rental_product_id' %}",
      type: "GET",
      data: { q: equipmentName },
      dataType: "json",
      success: function (data) {
          console.log("Response for Equipment Name:", data);
          if (data.results.length > 0) {
              $select.empty();
              $.each(data.results, function(index, item) {
                  $select.append(new Option(item.text, item.id, false, false));
              });
              $select.trigger("change");
          }
      },
      error: function (xhr, status, error) {
          console.error("Error fetching Equipment ID:", xhr.responseText);
      }
  });
}

function removeRow(button) {
  const row = button.closest("tr");
  row.remove();
  updateRentAmount(); // Call your update function if needed.
}

// Fix issue with dynamically added select2 fields
$(document).on('select2:select', '.order_item_equipment_id, .order_item_equipment_name', function (e) {
  console.log('Select2 change detected:', e.target);
});
</script>
<!-- Add Row And Remove Row -->

<!-- CheckBox Modal -->
<script>
  $(document).ready(function () {
    // Get the modal
    // var modal = $('#recurring_modal');
    var fildset = $(".recurring")

    // Get the checkbox
    var checkbox = $('#recurring-checkbox');
    var clsbtn = $('.recurring-close');

    // Default hidden
    fildset.hide();

    // When the checkbox is changed
    checkbox.on('change', function() {
      if (this.checked) {
        fildset.show();
      }else{
        fildset.hide();
      }
    });
  });
</script>
<!-- CheckBox Modal -->

<!-- Script For reccuring types -->
<script>
  document.addEventListener('DOMContentLoaded', function () {
    const repeatType = document.getElementById('repeatType');
    const repeatValue = document.getElementById('repeatValue');
    const timeUnit = document.getElementById('timeUnit');
    const startDateInput = document.getElementById('startDate');
    const endDateInput = document.getElementById('endDate');
    const message = $('#message');

    repeatType.addEventListener('change', updateMessage);
    repeatValue.addEventListener('input', updateMessage);
    startDateInput.addEventListener('change', updateMessage);
    endDateInput.addEventListener('change', updateMessage);

    function updateMessage() {
      const selectedValue = repeatType.value;
      const value = repeatValue.value;
      const startDateValue = startDateInput.value;
      const endDateValue = endDateInput.value;

      let dateRange = '';
      if (startDateValue && endDateValue) {
        dateRange = `from ${startDateValue} to ${endDateValue}`;
      }

      switch (selectedValue) {
        case 'Week':
          timeUnit.textContent = 'Week(s)';
          if (value) {
            message.html(`Occurs every week for ${value} week${value > 1 ? 's' : ''}, ${dateRange}`);
          } else {
            message.html(`Occurs every week, ${dateRange}`);
          }
          break;
        case 'Month':
          timeUnit.textContent = 'Month(s)';
          if (value) {
            message.html(`Occurs every month for ${value} month${value > 1 ? 's' : ''}, ${dateRange}`);
          } else {
            message.html(`Occurs every month, ${dateRange}`);
          }
          break;
        case 'Year':
          timeUnit.textContent = 'Year(s)';
          if (value) {
            message.html(`Occurs every year for ${value} year${value > 1 ? 's' : ''}, ${dateRange}`);
          } else {
            message.html(`Occurs every year, ${dateRange}`);
          }
          break;
        default:
          timeUnit.textContent = '';
          message.html('');
      }
    }
  });
</script>

<!-- Script For reccuring types -->

<!-- Script For disabled state of the "Rental Period" section: -->
<!-- <script>
  $(document).ready(function() {
    // Get the modal and elements
    var rentalPeriod = $('.reportrange'); // Adjust this if needed
    var recurringCheckbox = $('#recurring-checkbox');

    // Initially hide the rental period if the checkbox is checked
    toggleRentalPeriod(recurringCheckbox.is(':checked'));

    // Toggle rental period visibility based on the checkbox state
    recurringCheckbox.on('change', function() {
      toggleRentalPeriod(this.checked);
    });

    function toggleRentalPeriod(isRecurring) {
      if (isRecurring) {
        rentalPeriod.prop('disabled', true);
        rentalPeriod.closest('.col').hide(); // Hide the entire column
      } else {
        rentalPeriod.prop('disabled', false);
        rentalPeriod.closest('.col').show(); // Show the entire column
      }
    }
  });
</script> -->

<!-- This will calculate rant par month -->

<!-- <script>
  $(function() {
    $('#daterangepicker').daterangepicker({
      locale: { format: 'YYYY-MM-DD' },
      startDate: moment().startOf('month'),
      endDate: moment().endOf('month'),
      opens: 'left'
    }, function(start, end) {
      $('#rentalPeriod').html(start.format('YYYY-MM-DD') + ' to ' + end.format('YYYY-MM-DD'));
      calculateRentPerMonth();
    });

    $('#rentAmount').on('input', calculateRentPerMonth);

    function calculateRentPerMonth() {
      var rentAmount = parseFloat($('#rentAmount').val());
      var period = $('#rentalPeriod').text().split(' to ');

      if (!rentAmount || period.length !== 2) return;

      var startDate = moment(period[0]);
      var endDate = moment(period[1]);

      // Calculate the total number of months in the rental period
      var months = [];
      var currentMonthStart = startDate.clone().startOf('month');

      while (currentMonthStart <= endDate) {
        months.push(currentMonthStart.format('YYYY-MM'));
        currentMonthStart.add(1, 'month').startOf('month');
      }

      var numberOfMonths = months.length;
      var rentPerMonth = rentAmount / numberOfMonths;

      var rentPerMonthText = '';
      months.forEach(function(month) {
        rentPerMonthText += moment(month).format('MMMM YYYY') + ': ' + rentPerMonth.toFixed(2) + '\n';
      });

      $('#rentPerMonth').val(rentPerMonthText);
    }
  });
</script> -->


<script>
  $(document).ready(function () {
    $(".disable-first-option").each(function () {
      $(this).find("option:first").prop("disabled", true);
    });
  });
</script>
<script>
  document.body.addEventListener('htmx:beforeSwap', function(evt) {
    if(evt.detail.xhr.status === 200){
        if(evt.detail.requestConfig.verb != 'get')
        {
            evt.detail.shouldSwap = false;
            window.location.reload();
        }
    }
  });
</script>
<script>
  $(document).ready(function () {
    $("#endDate").prop("disabled", true);  

    function updateEndDate() {
        console.log("Function triggered");

        let repeatType = $("#id_repeat_type").val();  
        let repeatValue = parseInt($("#id_repeat_value").val(), 10);
        let startDate = $("#startDate").val();  

        console.log("Repeat Type:", repeatType);
        console.log("Repeat Value:", repeatValue);
        console.log("Start Date:", startDate);

        if (!repeatType || isNaN(repeatValue) || !startDate) {
            console.log("Missing required fields");
            $("#endDate").val("");  
            return;
        }

        let startMoment = moment(startDate, "YYYY-MM-DD");
        if (!startMoment.isValid()) {
            console.log("Invalid Start Date");
            $("#endDate").val("");  
            return;
        }

        console.log("Parsed Start Date:", startMoment.format("YYYY-MM-DD"));

        let daysToAdd = 0;

        if (repeatType.toLowerCase() === "weekly") {
            daysToAdd = repeatValue * 7;
        } else if (repeatType.toLowerCase() === "monthly") {
            daysToAdd = repeatValue * 30; 
        } else if (repeatType.toLowerCase() === "yearly") {
            daysToAdd = repeatValue * 365;
        }

        console.log("Days to Add Before Adjusting:", daysToAdd);

        let endMoment = startMoment.add(daysToAdd - 1, "days");

        let formattedEndDate = endMoment.format("YYYY-MM-DD");
        console.log("Calculated End Date:", formattedEndDate);

        $("#endDate").val(formattedEndDate);

        $("#hidden_endDate").val(formattedEndDate);
    }

    $("#id_repeat_type, #id_repeat_value, #startDate").on("change keyup", updateEndDate);

  });
</script>
<style>
  .loading-form {
    display : none;
  }
  .loading-form-2 {
    display : none;
  }
</style>
<script>
  $(document).ready(function(){
    $('#id_customer').on('change', function(){
        var customerId = $(this).val();
        if (customerId) {
            $.ajax({
                url: "{% url 'rental:rent_process:customer-address-ajax' %}",
                data: { customer_id: customerId },
                dataType: 'json',
                success: function(data) {
                    $('#id_delivery_location').val(data.address);
                },
                error: function(xhr, status, error) {
                    console.error("AJAX Error:", error);
                }
            });
        } else {
            $('#id_delivery_location').val('');
        }
    });
  });
</script>
