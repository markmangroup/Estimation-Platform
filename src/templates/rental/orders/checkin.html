{% load static %}
<style>
  #check-in-table{
    width: 100% !important;
  }
</style>
<!-- Print Button Start -->
<div class="float-left my-2 mt-3">
  <button type="button" class="btn btn-primary print-button" data-table-id="table7">Print</button>
</div>
<!-- Print Button End -->

<!-- New Table View Start-->
<div class="mt-5">
    <table id="check-in-table" class="table table-striped table-bordered">
      <thead>
        <tr>
          <th style="max-width:100px">Delivery ID</th>
          <th style="max-width:100px">Total Quantity</th>
          <th style="max-width:100px">CheckIn Date</th> 
        </tr>
      </thead>
      <tbody>

      </tbody>
    </table>
</div>

{% comment %} <div id="stockform">
      
</div> {% endcomment %}



<script src="https://cdn.jsdelivr.net/npm/bootstrap@4.6.2/dist/js/bootstrap.bundle.min.js"></script>

<script>
  var csrf_token = "{{ csrf_token }}";
  var order_obj_pk = "{{order.order_id}}"
  var update_check_in_status_url = "{% url 'rental:rent_process:update_check_in_status' order_id='ORDER_pk' %}".replace('ORDER_pk', order_obj_pk);
  
  $(document).ready(function () {

    
    if ($.fn.dataTable.isDataTable('#check-in-table')) {
        $('#check-in-table').DataTable().clear().destroy();
    }
    var order_obj_id = "{{order.order_id}}"
    console.log('order_obj_id: ', order_obj_id);
    var url = "{% url 'rental:rent_process:check-in-list-ajax' order_id='ORDER_ID' %}".replace('ORDER_ID', order_obj_id);
    
    let table = $("#check-in-table").DataTable({
        processing: true,
        serverSide: true,
        ajax: {
            url: url,
            type: "GET",
        },
        columns: [
            { data: "return_id" },
            { data: "total_qty" },
            { data: "returned_pickup_date" },
            //{ data: "actions", orderable: false, searchable: false },
        ],
        rowCallback: function (row, data, index) {
          if (data.products) {
              let totalQtyCell = $(row).find('td:eq(1)');
              let checkoutCell = $(row).find('td:eq(2)');

              // Merge the columns to fit all data in one row
              totalQtyCell.attr('colspan', 3).css({ "vertical-align": "top" });

              let summaryRow = `
                 <table class="table table-striped table-bordered">
                    <tbody>
                        <tr>
                            <td style="width: 28.5%;">${data.total_qty}</td>
                            <td style="width: 29.1%;">${data.returned_pickup_date}</td>
                        </tr>
                    </tbody>
                </table>
              `;

              totalQtyCell.html(`
                  ${summaryRow}
                  <div>${data.products}</div>
              `);

              checkoutCell.hide();
              //actionsCell.hide();
          }
      }

    });

    setInterval(function () {
        table.ajax.reload(null, false);
    }, 60000);


  let isUpdating = false;

  $(document).off("change", ".check-in-date").on("change", ".check-in-date", function () {
    if (isUpdating) return; // Don't allow another request if one is already in progress
    isUpdating = true;

    let selectedDate = $(this).val();
    console.log('selectedDate: ', selectedDate);
    let deliveryId = $(this).data("delivery-id");
    console.log('deliveryId: ', deliveryId);
    let successMessage = $(this).siblings(".success-message");
    let errorMessage = $(this).siblings(".error-message");
    var update_check_in_date_url = "{% url 'rental:rent_process:update_check_in_date' %}";

    console.log(`Updating delivery ${deliveryId} with date: ${selectedDate}`);

    $.ajax({
        url: update_check_in_date_url,
        type: "POST",
        headers: {
            "X-CSRFToken": csrf_token,
        },
        data: JSON.stringify({
            delivery_id: deliveryId,
            check_in_date: selectedDate,
        }),
        contentType: "application/json",
        dataType: "json",
        success: function (response) {
            isUpdating = false; // Reset the flag when the request is complete

            if (response.success) {
                toastr.success("Date Updated Successfully!", 'Success', {
                    closeButton: true,
                    progressBar: true,
                    positionClass: 'toast-bottom-right',
                    timeOut: 6000
                });
            } else {
                errorMessage.text(response.error).show().delay(2000).fadeOut();
            }
        },
        error: function (xhr, status, error) {
            isUpdating = false; // Reset the flag even in case of error
            console.log("Error:", error);
            errorMessage.text("Failed to update date.").show().delay(2000).fadeOut();
        },
    });
  });


});
</script>
<!-- Calculation of stock adjustment -->
<script>
    $(document).ready(function() {
        // Function to validate quantity
        function validateQuantity(input, expected) {
            var value = input.val().trim();
            if (value === "") {
                input.removeClass('match-quantity mismatch-quantity focused-quantity').addClass('empty-quantity');
                return false;
            }
            var numberValue = parseInt(value);
            if (isNaN(numberValue) || numberValue < 0 || numberValue > expected) {
                input.removeClass('match-quantity focused-quantity').addClass('mismatch-quantity');
                return false;
            } else if (numberValue === expected) {
                input.removeClass('mismatch-quantity focused-quantity').addClass('match-quantity');
                return true;
            } else {
                input.removeClass('match-quantity focused-quantity').addClass('mismatch-quantity');
                return false;
            }
        }
    
        // Function to prepopulate Plus/Minus Quantity (for dynamic updates)
        function prepopulateQuantities() {
            $(".check-in-qty").each(function() {
                var currentStock = $(this).data("current-stock");
                var revisedQuantity = $(this).val() || currentStock; // Use input value or current stock
                var plusInput = $(".PluseQuantity");
                var minusInput = $(".minusQuantity");
    
                if (revisedQuantity > currentStock) {
                    plusInput.val(revisedQuantity - currentStock);  // Increased => Plus
                    minusInput.val(0);
                } else if (revisedQuantity < currentStock) {
                    minusInput.val(currentStock - revisedQuantity);  // Decreased => Minus
                    plusInput.val(0);
                } else {
                    plusInput.val(0);
                    minusInput.val(0);
                }
    
                $(".revisedQuantity").val(revisedQuantity); // Update revised quantity field
            });
        }
    
        // Input focus and blur events for .check-in-qty
        $(document).on('focus', '.check-in-qty', function() {
            $('.check-in-qty').removeClass('focused-quantity');
            $(this).addClass('focused-quantity');
        }).on('blur', '.check-in-qty', function() {
            var qtyValue = $(this).data('value');
            console.log("On blur - qtyValue:", qtyValue);
            $(this).removeClass('focused-quantity');
            validateQuantity($(this), qtyValue);
        });
    
        // On input change for .check-in-qty
        $(document).on('input', '.check-in-qty', function() {
            var inputValue = $(this).val();
            var numberValue = parseInt(inputValue);
            var outputText = $(this).siblings('small');
    
            var qtyValue = $(this).data('value');
            var currentStock = $(this).data('current-stock');
    
            console.log("On input change - inputValue:", inputValue);
            console.log("qtyValue:", qtyValue);
            console.log("currentStock:", currentStock);
    
            var missing_qty = qtyValue - numberValue;
            $(".minusQuantity").val(missing_qty);
            $(".revisedQuantity").val(currentStock - missing_qty);
    
            // Update dynamic Plus/Minus quantities
            prepopulateQuantities();
    
            // Show message if quantity is less than expected
            if (parseInt(inputValue) < qtyValue) {
                outputText.html(`
                    <span class="warning"><i class="ft-alert-triangle"></i> Quantity does not match, ${missing_qty} qty is missing!! </span><br>
                    <span style="color:darkslateblue;">Do stock adjustment?</span> 
                    <a href="#" class="adjust-stock" data-stock-id="${$(this).data('stock-id')}" data-pick-up-ticket-items-pk="${$(this).data('pick-up-ticket-items-pk')}" data-mismatched-quantity="${missing_qty}">
                        <i class="ft-check success"></i>
                    </a>
                    <a href="#" class="adjust-stock-cancel-button"><i class="ft-x danger"></i></a>
                `);
                
            } else {
                outputText.text('');
            }
        });
    
        // Click event for stock adjustment (opens modal and loads form via HTMX)
        $(document).off("click", ".adjust-stock").on("click", ".adjust-stock", function(e) {
            e.preventDefault();
            
            let stockId = $(this).data("stock-id");
            // Retrieve the ReturnDeliveryItem pk from a custom data attribute
            let pickUpTicketItemPk = $(this).data("pick-up-ticket-items-pk");
            console.log('pick_up_ticket_items_pk:', pickUpTicketItemPk);
            
            // mismatchedQuantity is positive if the input quantity is less than expected
            let mismatchedQuantity = parseInt($(this).data("mismatched-quantity"));
            console.log('mismatchedQuantity:', mismatchedQuantity);
            
            console.log("Stock Adjustment Clicked - Stock ID:", stockId, "Mismatched Quantity:", mismatchedQuantity);
        
            // Check for Bootstrap modal availability
            if (typeof $.fn.modal === "undefined") {
                console.error("Bootstrap modal function is not available. Check your Bootstrap JS.");
                return;
            }
        
            $("#stockform").html('<div class="text-center"><i class="fa fa-spinner fa-spin"></i> Loading...</div>');
        
            if ($("#adjust_stock_details").length > 0) {
                $("#adjust_stock_details").modal("show");
            } else {
                console.error("Modal element not found in DOM.");
            }
        
            // Build the URL using Django's url template tag with a dummy value replaced by stockId
            var update_stock_url = `{% url 'rental:stock_management:rental-stock-management-edit' 0 %}`.replace("0", stockId);
        
            // Load the stock adjustment form via HTMX
            htmx.ajax("GET", update_stock_url, {
                target: "#stockform",
                swap: "innerHTML"
            }).then(function() {
                // After the form is loaded, update the Plus/Minus fields based on mismatchedQuantity.
                if (mismatchedQuantity > 0) {
                    // Here, a positive mismatchedQuantity means the actual quantity is less than expected.
                    // So, update the Minus Quantity field.
                    $("#minusQuantity").val(mismatchedQuantity);
                    $("#PluseQuantity").val(0);
                } else if (mismatchedQuantity < 0) {
                    // A negative mismatchedQuantity means the revised quantity is higher than expected.
                    $("#PluseQuantity").val(Math.abs(mismatchedQuantity));
                    $("#minusQuantity").val(0);
                } else {
                    $("#PluseQuantity").val(0);
                    $("#minusQuantity").val(0);
                }
                // Populate the hidden fields for the secondary update.
                $("#updatedMismatch").val(mismatchedQuantity);
                $("#returnDeliveryItemPk").val(pickUpTicketItemPk);
            });
        });
    
        // Initial validation on page load for each .check-in-qty
        $(".check-in-qty").each(function() {
            var qtyValue = $(this).data("value");
            console.log("Initial validation - qtyValue:", qtyValue);
            validateQuantity($(this), qtyValue);
        });
    
        // Prepopulate Plus/Minus Quantities on page load
        prepopulateQuantities();
    
        window.returnDeliveryUpdateFired = false;

        document.body.addEventListener('htmx:afterRequest', function(event) {
            console.log("htmx:afterRequest fired.");
            console.log("Event detail:", event.detail);
            
            if (event.detail.target && event.detail.target.id === 'stockform') {
                var contentType = event.detail.xhr.getResponseHeader("Content-Type");
                console.log("Response Content-Type:", contentType);
                
                if (contentType && contentType.indexOf("application/json") !== -1) {
                    console.log("Detected a JSON response. Likely a POST form submission.");
                    
                    if (!window.returnDeliveryUpdateFired) {
                        window.returnDeliveryUpdateFired = true;
                        
                        var itemPk = $("#returnDeliveryItemPk").val();
                        var updatedMismatch = $("#updatedMismatch").val();
                        console.log('ReturnDeliveryItem PK:', itemPk);
                        console.log('Updated Mismatch:', updatedMismatch);
                        var pulse_quantity = $("#PluseQuantity").val();
                        console.log('pulse_quantity: ', pulse_quantity);
                        var minus_quantity = $("#minusQuantity").val();
                        console.log('pulse_quantity: ', pulse_quantity);
                        
                        if (itemPk && updatedMismatch !== undefined) {
                            var updateItemUrl = `{% url 'rental:rent_process:return-delivery-item-update' 0 %}`.replace("0", itemPk);
                            console.log("Update URL:", updateItemUrl);
                            
                            htmx.ajax("POST", updateItemUrl, {
                                target: "#dummy",
                                swap: "none",
                                headers: { "X-CSRFToken": "{{ csrf_token }}" },
                                values: { 
                                    "pulse_quantity":pulse_quantity,
                                    "minus_quantity":minus_quantity
                                 }
                            }).then(function(response) {
                                console.log("Update POST succeeded.", response);
                                $("#stock_management_list").DataTable().ajax.reload(null, false);
                                $("#check-in-table").DataTable().ajax.reload(null, false);
                                $("#inspection-table").DataTable().ajax.reload(null, false);
                                
                            }).catch(function(error) {
                                console.error("Update POST failed.", error);
                            }).finally(function() {
                                setTimeout(function() {
                                    window.returnDeliveryUpdateFired = false;
                                }, 1000);
                            });
                        } else {
                            console.log("Hidden field values missing; update not triggered.");
                        }
                    } else {
                        console.log("Update already triggered; skipping duplicate update.");
                    }
                } else {
                    console.log("Response is not JSON; ignoring update.");
                }
            } else {
                console.log("Target is not stockform; ignoring update.");
            }
        });

    });
    </script>
    <script>
        $(document).off("click", ".adjust-stock-cancel-button").on("click", ".adjust-stock-cancel-button", function(e) {
            $("#check-in-table").DataTable().ajax.reload(null, false);
        });
    </script>