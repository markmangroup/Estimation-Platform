{% load static %}
<style>
  #inspection-table{
    width: 100% !important;
  }
  .hidden{
    display: none !important;
  }
</style>
<!-- Print Button Start -->
<div class="float-left my-2 mt-3">
  <button type="button" class="btn btn-primary print-button" data-table-id="table8">Print</button>
</div>
<!-- Print Button End -->

<!-- New Table View Start -->
<div class="mt-5">
    <table id="inspection-table" class="table table-striped table-bordered">
      <thead>
        <tr>
          <th style="max-width:100px">Delivery ID</th>
          <th style="max-width:100px">Total Quantity</th>
          <th style="max-width:100px">CheckIn Date</th> 
          <th style="max-width:100px">Inspection Date</th> 
        </tr>
      </thead>
      <tbody>
      </tbody>
    </table>
</div>
<!-- New Table View End -->



<!-- Stock Adjustment Modal Start -->
{% comment %} <div id="inspection-stockform">
  <!-- The form will be loaded here -->
</div> {% endcomment %}
<!-- Stock Adjustment Modal End -->
<script src="https://cdn.jsdelivr.net/npm/bootstrap@4.6.2/dist/js/bootstrap.bundle.min.js"></script>

<script>
  var csrf_token = "{{ csrf_token }}";
  
  $(document).ready(function () {

    
    if ($.fn.dataTable.isDataTable('#inspection-table')) {
        $('#inspection-table').DataTable().clear().destroy();
    }
    var order_obj_id = "{{order.order_id}}"
    var url = "{% url 'rental:rent_process:inspection-list-ajax' order_id='ORDER_ID' %}".replace('ORDER_ID', order_obj_id);
    let table = $("#inspection-table").DataTable({
        processing: true,
        serverSide: true,
        ajax: {
            url: url,
            type: "GET",
        },
        columns: [
            { data: "return_id" },
            { data: "total_qty" },
            { data: "check_in_date" },
            { data: "inspection_date" },
        ],
        rowCallback: function (row, data, index) {
          if (data.products) {
              let totalQtyCell = $(row).find('td:eq(1)');
              let checkoutCell = $(row).find('td:eq(2)');
              let inspectiondateCell = $(row).find('td:eq(3)');

              // Merge the columns to fit all data in one row
              totalQtyCell.attr('colspan', 3).css({ "vertical-align": "top" });

              let summaryRow = `
                 <table class="table table-striped table-bordered">
                    <tbody>
                        <tr>
                            <td style="width: 29.1%;">${data.total_qty}</td>
                            <td style="width: 29.7%;">${data.check_in_date}</td>
                            <td style="width: 28.9%;">${data.inspection_date}</td>
                        </tr>
                    </tbody>
                </table>
              `;

              totalQtyCell.html(`
                  ${summaryRow}
                  <div>${data.products}</div>
              `);

              checkoutCell.hide();
              inspectiondateCell.hide();
              //actionsCell.hide();
          }
      }

    });

    setInterval(function () {
        table.ajax.reload(null, false);
    }, 60000);


  let isUpdating = false;

  $(document).off("change", ".inspection-date").on("change", ".inspection-date", function () {
    if (isUpdating) return; // Don't allow another request if one is already in progress
    isUpdating = true;

    let selectedDate = $(this).val();
    console.log('selectedDate: ', selectedDate);
    let deliveryId = $(this).data("delivery-id");
    console.log('deliveryId: ', deliveryId);
    let successMessage = $(this).siblings(".success-message");
    let errorMessage = $(this).siblings(".error-message");
    var update_inspection_date_url = "{% url 'rental:rent_process:update_inspection_date' %}";

    console.log(`Updating delivery ${deliveryId} with date: ${selectedDate}`);

    $.ajax({
        url: update_inspection_date_url,
        type: "POST",
        headers: {
            "X-CSRFToken": csrf_token,
        },
        data: JSON.stringify({
            delivery_id: deliveryId,
            inspection_date: selectedDate,
        }),
        contentType: "application/json",
        dataType: "json",
        success: function (response) {
            isUpdating = false; // Reset the flag when the request is complete

            if (response.success) {
                toastr.success("Date Updated Successfully!", 'Success', {
                    closeButton: true,
                    progressBar: true,
                    positionClass: 'toast-bottom-right',
                    timeOut: 6000
                });
            } else {
                errorMessage.text(response.error).show().delay(2000).fadeOut();
            }
        },
        error: function (xhr, status, error) {
            isUpdating = false; // Reset the flag even in case of error
            console.log("Error:", error);
            errorMessage.text("Failed to update date.").show().delay(2000).fadeOut();
        },
    });
  });


});
</script>

<script>
  $(document).ready(function() {
    // Helper to get CSRF token from cookie
    function getCookie(name) {
        var cookieValue = null;
        if (document.cookie && document.cookie !== '') {
            var cookies = document.cookie.split(';');
            for (var i = 0; i < cookies.length; i++) {
                var cookie = $.trim(cookies[i]);
                if (cookie.substring(0, name.length + 1) === (name + '=')) {
                    cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                    break;
                }
            }
        }
        return cookieValue;
    }
    var csrftoken = getCookie('csrftoken');
    
    // Attach click event for the "mark inspection" link
    $(document).off("click", "a.marked").on("click", "a.marked", function(e) {
        e.preventDefault();
        var url = $(this).data('url');  // Read URL from data attribute
        console.log("AJAX URL:", url);
        
        $.ajax({
            url: url,
            type: 'POST',
            headers: { "X-CSRFToken": csrftoken },
            success: function(response) {
                console.log("Inspection update success:", response);
                toastr.success("Inspection Updated Successfully!", 'Success', {
                  closeButton: true,
                  progressBar: true,
                  positionClass: 'toast-bottom-right',
                  timeOut: 6000
              });
              $("#inspection-table").DataTable().ajax.reload(null, false);
            },
            error: function(xhr, status, error) {
                console.error("Error updating inspection:", status, error);
            }
        });
    });
});
</script>
<script>
  $(document).ready(function() {
      // Function to validate quantity
      function validateQuantity(input, expected) {
          var value = input.val().trim();
          if (value === "") {
              input.removeClass('match-quantity mismatch-quantity focused-quantity').addClass('empty-quantity');
              return false;
          }
          var numberValue = parseInt(value);
          if (isNaN(numberValue) || numberValue < 0 || numberValue > expected) {
              input.removeClass('match-quantity focused-quantity').addClass('mismatch-quantity');
              return false;
          } else if (numberValue === expected) {
              input.removeClass('mismatch-quantity focused-quantity').addClass('match-quantity');
              return true;
          } else {
              input.removeClass('match-quantity focused-quantity').addClass('mismatch-quantity');
              return false;
          }
      }
  
      // Function to prepopulate Plus/Minus Quantity (for dynamic updates)
      function prepopulateQuantities() {
          $(".inspection-qty").each(function() {
              var currentStock = $(this).data("current-stock");
              var revisedQuantity = $(this).val() || currentStock; // Use input value or current stock
              var plusInput = $(".PluseQuantity");
              var minusInput = $(".minusQuantity");
  
              if (revisedQuantity > currentStock) {
                  plusInput.val(revisedQuantity - currentStock);  // Increased => Plus
                  minusInput.val(0);
              } else if (revisedQuantity < currentStock) {
                  minusInput.val(currentStock - revisedQuantity);  // Decreased => Minus
                  plusInput.val(0);
              } else {
                  plusInput.val(0);
                  minusInput.val(0);
              }
  
              $(".revisedQuantity").val(revisedQuantity); // Update revised quantity field
          });
      }
  
      // Input focus and blur events for .inspection-qty
      $(document).on('focus', '.inspection-qty', function() {
          $('.inspection-qty').removeClass('focused-quantity');
          $(this).addClass('focused-quantity');
      }).on('blur', '.inspection-qty', function() {
          var qtyValue = $(this).data('value');
          console.log("On blur - qtyValue:", qtyValue);
          $(this).removeClass('focused-quantity');
          validateQuantity($(this), qtyValue);
      });
  
      // On input change for .inspection-qty
      $(document).on('input', '.inspection-qty', function() {
          var inputValue = $(this).val();
          var numberValue = parseInt(inputValue);
          var outputText = $(this).siblings('small');
  
          var qtyValue = $(this).data('value');
          var currentStock = $(this).data('current-stock');
  
          console.log("On input change - inputValue:", inputValue);
          console.log("qtyValue:", qtyValue);
          console.log("currentStock:", currentStock);
  
          var missing_qty = qtyValue - numberValue;
          $(".minusQuantity").val(missing_qty);
          $(".revisedQuantity").val(currentStock - missing_qty);
  
          // Update dynamic Plus/Minus quantities
          prepopulateQuantities();
  
          // Show message if quantity is less than expected
          if (parseInt(inputValue) < qtyValue) {
              outputText.html(`
                  <span class="warning"><i class="ft-alert-triangle"></i> Quantity does not match, ${missing_qty} qty is missing!! </span><br>
                  <span style="color:darkslateblue;">Do stock adjustment?</span> 
                  <a href="#" class="adjust-stock" data-stock-id="${$(this).data('stock-id')}" data-pick-up-ticket-items-pk="${$(this).data('pick-up-ticket-items-pk')}" data-mismatched-quantity="${missing_qty}">
                      <i class="ft-check success"></i>
                  </a>
                  <a href="#" class="inspection-update-stock-cancel-button"><i class="ft-x danger"></i></a>
              `);
              var markComplete = $(this).siblings('span.mark-completed');
              markComplete.hide();
          } else {
              outputText.text('');
          }
      });
  
      // Click event for stock adjustment (opens modal and loads form via HTMX)
      $(document).off("click", ".adjust-stock").on("click", ".adjust-stock", function(e) {
          e.preventDefault();
          
          let stockId = $(this).data("stock-id");
          // Retrieve the ReturnDeliveryItem pk from a custom data attribute
          let pickUpTicketItemPk = $(this).data("pick-up-ticket-items-pk");
          console.log('pick_up_ticket_items_pk:', pickUpTicketItemPk);
          
          // mismatchedQuantity is positive if the input quantity is less than expected
          let mismatchedQuantity = parseInt($(this).data("mismatched-quantity"));
          console.log('mismatchedQuantity:', mismatchedQuantity);
          
          console.log("Stock Adjustment Clicked - Stock ID:", stockId, "Mismatched Quantity:", mismatchedQuantity);
      
          // Check for Bootstrap modal availability
          if (typeof $.fn.modal === "undefined") {
              console.error("Bootstrap modal function is not available. Check your Bootstrap JS.");
              return;
          }
      
          $("#stockform").html('<div class="text-center"><i class="fa fa-spinner fa-spin"></i> Loading...</div>');
      
          console.log('$("#adjust_stock_details").length: ', $("#adjust_stock_details").length);
          if ($("#adjust_stock_details").length > 0) {
              $("#adjust_stock_details").modal("show");
          } else {
              console.error("Modal element not found in DOM.");
          }
      
          // Build the URL using Django's url template tag with a dummy value replaced by stockId
          var update_stock_url = `{% url 'rental:stock_management:rental-stock-management-edit' 0 %}`.replace("0", stockId);
          console.log('update_stock_url: ', update_stock_url);
      
          // Load the stock adjustment form via HTMX
          htmx.ajax("GET", update_stock_url, {
              target: "#stockform",
              swap: "innerHTML"
          }).then(function() {
              // After the form is loaded, update the Plus/Minus fields based on mismatchedQuantity.
              if (mismatchedQuantity > 0) {
                  // Here, a positive mismatchedQuantity means the actual quantity is less than expected.
                  // So, update the Minus Quantity field.
                  $("#minusQuantity").val(mismatchedQuantity);
                  $("#PluseQuantity").val(0);
              } else if (mismatchedQuantity < 0) {
                  // A negative mismatchedQuantity means the revised quantity is higher than expected.
                  $("#PluseQuantity").val(Math.abs(mismatchedQuantity));
                  $("#minusQuantity").val(0);
              } else {
                  $("#PluseQuantity").val(0);
                  $("#minusQuantity").val(0);
              }
              // Populate the hidden fields for the secondary update.
              $("#updatedMismatch").val(mismatchedQuantity);
              $("#returnDeliveryItemPk").val(pickUpTicketItemPk);
          });
      });
  
      // Initial validation on page load for each .inspection-qty
      $(".inspection-qty").each(function() {
          var qtyValue = $(this).data("value");
          console.log("Initial validation - qtyValue:", qtyValue);
          validateQuantity($(this), qtyValue);
      });
  
      // Prepopulate Plus/Minus Quantities on page load
      prepopulateQuantities();
  
      window.returnDeliveryUpdateFired = false;

      document.body.addEventListener('htmx:afterRequest', function(event) {
          console.log("htmx:afterRequest fired.");
          console.log("Event detail:", event.detail);
          
          if (event.detail.target && event.detail.target.id === 'stockform') {
              var contentType = event.detail.xhr.getResponseHeader("Content-Type");
              console.log("Response Content-Type:", contentType);
              
              if (contentType && contentType.indexOf("application/json") !== -1) {
                  console.log("Detected a JSON response. Likely a POST form submission.");
                  
                  if (!window.returnDeliveryUpdateFired) {
                      window.returnDeliveryUpdateFired = true;
                      
                      var itemPk = $("#returnDeliveryItemPk").val();
                      var pulse_quantity = $("#PluseQuantity").val();
                      console.log('pulse_quantity: ', pulse_quantity);
                      var minus_quantity = $("#minusQuantity").val();
                      console.log('pulse_quantity: ', pulse_quantity);
                      var updatedMismatch = $("#updatedMismatch").val();
                      console.log('ReturnDeliveryItem PK:', itemPk);
                      console.log('Updated Mismatch:', updatedMismatch);
                      
                      if (itemPk && updatedMismatch !== undefined) {
                          var updateItemUrl = `{% url 'rental:rent_process:return-delivery-item-update' 0 %}`.replace("0", itemPk);
                          console.log("Update URL:", updateItemUrl);
                          
                          htmx.ajax("POST", updateItemUrl, {
                              target: "#dummy",
                              swap: "none",
                              headers: { "X-CSRFToken": "{{ csrf_token }}" },
                              values: { 
                                "pulse_quantity":pulse_quantity,
                                "minus_quantity":minus_quantity
                             }
                          }).then(function(response) {
                              console.log("Update POST succeeded.", response);
                              $("#stock_management_list").DataTable().ajax.reload(null, false);
                              $("#check-in-table").DataTable().ajax.reload(null, false);
                              $("#inspection-table").DataTable().ajax.reload(null, false);
                              
                          }).catch(function(error) {
                              console.error("Update POST failed.", error);
                          }).finally(function() {
                              setTimeout(function() {
                                  window.returnDeliveryUpdateFired = false;
                              }, 1000);
                          });
                      } else {
                          console.log("Hidden field values missing; update not triggered.");
                      }
                  } else {
                      console.log("Update already triggered; skipping duplicate update.");
                  }
              } else {
                  console.log("Response is not JSON; ignoring update.");
              }
          } else {
              console.log("Target is not stockform; ignoring update.");
          }
      });

  });
</script>
<script>
    // Variable to ensure the event is only bound once
    var isHandlerBound = false;

    $(document).on("click", ".inspection-adjust-stock-cancel", function(e) {
        // If handler is already bound, prevent it from being re-executed
        if (isHandlerBound) return;

        // Prevent further events while processing
        isHandlerBound = true;

        e.preventDefault();

        // Check if the modal is already open.
        if ($("#adjust_stock_details").hasClass("show")) {
            console.log("Modal is already open. Aborting duplicate open.");
            // Reset the handler for next time
            isHandlerBound = false;
            return;
        }

        let stockId = $(this).data("stock-id");
        // Retrieve the ReturnDeliveryItem pk from a custom data attribute
        let pickUpTicketItemPk = $(this).data("pick-up-ticket-items-pk");
        console.log('pick_up_ticket_items_pk:', pickUpTicketItemPk);

        // mismatchedQuantity is positive if the input quantity is less than expected
        let mismatchedQuantity = parseInt($(this).data("mismatched-quantity"));
        console.log('mismatchedQuantity:', mismatchedQuantity);

        console.log("Stock Adjustment Clicked - Stock ID:", stockId, "Mismatched Quantity:", mismatchedQuantity);

        $("#stockform").html('<div class="text-center"><i class="fa fa-spinner fa-spin"></i> Loading...</div>');

        console.log('$("#adjust_stock_details").length: ', $("#adjust_stock_details").length);
        if ($("#adjust_stock_details").length > 0) {
            $("#adjust_stock_details").modal("show");
        } else {
            console.error("Modal element not found in DOM.");
        }

        // Build the URL using Django's url template tag with a dummy value replaced by stockId
        var update_stock_url = `{% url 'rental:stock_management:rental-stock-management-edit' 0 %}`.replace("0", stockId);
        console.log('update_stock_url: ', update_stock_url);

        // Load the stock adjustment form via HTMX
        htmx.ajax("GET", update_stock_url, {
            target: "#stockform",
            swap: "innerHTML"
        }).then(function() {
            // After the form is loaded, update the Plus/Minus fields based on mismatchedQuantity.
            if (mismatchedQuantity > 0) {
                // Here, a positive mismatchedQuantity means the actual quantity is less than expected.
                // So, update the Minus Quantity field.
                $("#minusQuantity").val(mismatchedQuantity);
                $("#PluseQuantity").val(0);
            } else if (mismatchedQuantity < 0) {
                // A negative mismatchedQuantity means the revised quantity is higher than expected.
                $("#PluseQuantity").val(Math.abs(mismatchedQuantity));
                $("#minusQuantity").val(0);
            } else {
                $("#PluseQuantity").val(0);
                $("#minusQuantity").val(0);
            }
            // Populate the hidden fields for the secondary update.
            $("#updatedMismatch").val(mismatchedQuantity);
            $("#returnDeliveryItemPk").val(pickUpTicketItemPk);

            // Reset the handler flag once processing is complete
            isHandlerBound = false;
        });
    });
</script>

<script>
    $(document).off("click", ".inspection-update-stock-cancel-button").on("click", ".inspection-update-stock-cancel-button", function(e) {
        $("#inspection-table").DataTable().ajax.reload(null, false);
    });
</script>

