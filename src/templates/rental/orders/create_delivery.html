{% load static %}
<style>
  .checkout-qty {
      width: 100px;
  }

  / Custom striped table effect /
  .table-striped tbody tr:nth-of-type(odd) {
      background-color: rgba(0, 0, 0, 0.05) !important;
  }

  .table-dark.table-striped tbody tr:nth-of-type(odd) {
      background-color: #342E49 !important;
  }

  / Ensure table borders and spacing /
  .table-bordered {
      border: 1px solid #ddd;
  }

  .table-bordered th, .table-bordered td {
      border: 1px solid #ddd;
      padding: 8px;
  }

  .table {
      width: 100%;
      border-collapse: collapse;
  }
</style>
<link rel="stylesheet" href="{% static 'vendors/css/sweetalert2.min.css' %}">
<div class="card-header">
  <ul class="nav nav-tabs mb-2">
    <li class="nav-item">
      <a class="nav-link active font-weight-bold fs-5" id="base-tab11" data-toggle="tab" aria-controls="tab1" href="#order-detail"
        aria-expanded="true">Delivery Tab</a>
    </li>
    <li class="nav-item">
      <a class="nav-link overview font-weight-bold fs-5" id="base-tab13" data-toggle="tab" aria-controls="tab3" href="#order-overview"
      data-url="{% url 'rental:rent_process:overview_model' order.order_id %}"
        aria-expanded="false">Order Overview</a>
    </li>
  </ul>
</div>

<!-- Print Button Start -->
<div class="float-left my-2 mt-3">
  <button type="button" class="btn btn-primary print-button" data-table-id="table1">Print</button>
</div>
<!-- Print Button End -->
<!-- Create Delivery Button Start -->
<div class="float-right my-2 mt-3">
  <a href="{% url 'rental:rent_process:create_delivery_modal' order.order_id %}"
    class="btn bg-light-primary open-modal" data-backdrop="false" data-toggle="modal" data-target="#show">
    <i class="ft-plus font-medium-5"></i> Create Delivery
  </a>
  {% include "rental/rent_process/drag_and_select.html" %}
</div>
<!-- Create Delivery Button End -->
<div class="tab-content">
  <div class="tab-pane" id="order-overview" aria-labelledby="base-tab13">
    {% include "rental/rent_process/order_detail_overview.html" %}
</div>


  <div class="tab-pane active" id="order-detail" aria-labelledby="base-tab11">

    <div>
      <div class="mt-5">
        <table id="createdelivery" class="table table-bordered" style="width:100% !important;">
          <thead>
              <tr>
                  <th>Delivery ID</th>
                  <th>Total Quantity</th>
                  <th>Contract Start Date</th>
                  <th>Delivery Date</th>
                  <th>Action</th>
              </tr>
          </thead>
          <tbody></tbody>
      </table>
    </div>


</div>
</div>

<!-- Create Delivery model Start -->
<div class="modal fade text-left" id="create_delivery" tabindex="-1" role="dialog" aria-labelledby="myModalLabel5"
  aria-hidden="true">
  <div class="modal-dialog modal-lg modal-dialog-centered" role="document">
    <div class="modal-content">
      <div class="modal-header">
        <h4 class="modal-title" id="myModalLabel5">Create Delivery</h4>
        <button type="button" class="close" data-dismiss="modal" aria-label="Close">
          <span aria-hidden="true"><i class="ft-x font-medium-2 text-bold-700"></i></span>
        </button>
      </div>
      <div class="modal-body">
        <section id="multiple-select2">
          <div class="card">
            <div class="card-content">
              <div class="card-body">
                <div class="row">
                  <div class="col-6">
                    <label for="" class="form-label">PickUp Date</label>
                    <input type="date" name="" id="" class="form-control">
                  </div>
                  <div class="col-6 mb-2">
                    <label for="" class="form-label">Delivery Date</label>
                    <input type="date" name="" id="" class="form-control">
                  </div>
                  <div class="col-12">
                    <div class="form-group">
                      <table id="tableBody" class="table table-bordered">
                        <thead>
                          <th>Material name</th>
                          <th>Requested Qty</th>
                          <th>Loaded Quantity</th>
                          <th>Quantity</th>
                          <th></th>
                        </thead>
                        <tbody>
                          <tr id="newProduct">
                            <td>
                              <select class="select2 form-control">
                                <option selected disabled>Select Material Name</option>
                                <option value="Air Vent Assembly">Air Vent Assembly</option>
                                <option value="Air Vent Installation">Air Vent Installation</option>
                                <option value="Automation: Backflush, Clock, Injector">Automation: Backflush, Clock,
                                  Injector</option>
                              </select>
                            </td>
                            <td class="text-center">3</td>
                            <td class="text-center"> - </td>
                            <td class="text-nowrap">
                              <input type="text" class="form-control">
                            </td>
                            <td class="d-flex">
                              <button class="btn btn-danger mr-2"><i class="fa fa-trash"></i></button>
                              <button type="button" class="btn btn-primary" onclick="CopyTableRow()"><i
                                  class="fa fa-plus"></i></button>
                            </td>
                          </tr>
                        </tbody>

                      </table>
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </section>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn bg-light-secondary" data-dismiss="modal">
          Close
        </button>
        <button id="addProductRow" type="button" class="btn bg-light-primary" data-backdrop="false" data-toggle="modal"
          data-target="#addProduct" onclick="copyLaborRow()" data-dismiss="modal">
          <em class="ft-plus font-medium-5"></em> Add
        </button>
      </div>
    </div>
  </div>
</div>
<!-- Create Delivery model End -->

<!-- Script Start -->
<script src="{% static 'vendors/js/sweetalert2.all.min.js' %}"></script>
<script src="{% static 'vendors/js/select2.full.min.js' %}"></script>
<script src="{% static 'app/js/select2.min.js' %}"></script>
<!-- Script End -->

<!-- Copy Table Js Start -->
<script>
  function CopyTableRow() {

    var tableBody = document.getElementById("tableBody");
    // console.log("Table Body:", tableBody);

    var rowToCopy = document.getElementById("newProduct");
    // console.log("Row to Copy:", rowToCopy);

    totalRows = 1;

    for (var i = 0; i < totalRows; i++) {
      // console.log("Copying row", i + 1);
      // Clone the row
      var clonedRow = rowToCopy.cloneNode(true);
      // console.log("Cloned Row:", clonedRow);
      tableBody.appendChild(clonedRow);
      // console.log("Row appended to table body");
    }
  }
</script>
<!-- Copy Table Js End -->

<!-- Print Script Start -->
<script>
  // Print Script Start
  document.querySelectorAll('.print-button').forEach(button => {
    button.addEventListener('click', function() {
        // Get the ID of the table to print from the button's data-table-id attribute
        var tableId = this.getAttribute('data-table-id');
        var table = document.getElementById(tableId);

        if (table) {
            // Hide print-ignore elements
            var printIgnoreElements = table.querySelectorAll('.print-ignore');
            printIgnoreElements.forEach(el => el.style.display = 'none');

            // Find the table HTML to print
            var tableHtml = table.outerHTML;

            // Create a new window or tab for printing
            var printWindow = window.open('', '', 'height=600,width=800');

            // URL for CSS (adjust this if needed)
            var url = "{% static 'vendors/css/sweetalert2.min.css' %}";

            // Construct the HTML for the print window
            printWindow.document.write('<html><head><title>Print Table</title>');
            printWindow.document.write(`<link rel="stylesheet" href="${url}">`); // Include your CSS file
            printWindow.document.write('<style>table { width: 100%; border-collapse: collapse; } th, td { border: 1px solid #ddd; padding: 8px; } th { background-color: #f2f2f2; }</style>'); // Inline styles for print
            printWindow.document.write('</head><body>');
            printWindow.document.write('<h1>Table Print</h1>');
            printWindow.document.write(tableHtml);
            printWindow.document.write('</body></html>');

            // Close the document and trigger print
            printWindow.document.close();
            printWindow.focus();
            printWindow.print();

            // Restore the print-ignore elements
            printIgnoreElements.forEach(el => el.style.display = '');
        } else {
            console.error("Table with ID " + tableId + " not found.");
        }
    });
  });
</script>
<!-- Print Script End -->
<script>
  $(document).ready(function () {
    $(".open-modal").click(function (e) {
        e.preventDefault();
        var url = $(this).attr("href");

        $.get(url, function (data) {
            $("#show .modal-body");
            $("#show").modal("show");
        });
    });
});
</script>
<script>
  $(document).ready(function () {
    if ($.fn.dataTable.isDataTable('#createdelivery')) {
        $('#createdelivery').DataTable().clear().destroy();
    }
    var order_obj_id = "{{order.order_id}}"
    var url = "{% url 'rental:rent_process:create_delivery_list_ajax' order_id='ORDER_ID' %}".replace('ORDER_ID', order_obj_id);

    let table = $("#createdelivery").DataTable({
        processing: true,
        serverSide: true,
        ajax: {
            url: url,
            type: "GET",
        },
        columns: [
            { data: "delivery_id" },
            { data: "total_qty" },
            { data: "contract_start_date" },
            { data: "delivery_date" },

        ],
        rowCallback: function (row, data, index) {
          if (data.products) {
              let totalQtyCell = $(row).find('td:eq(1)'); // Total Quantity Column
              let checkoutCell = $(row).find('td:eq(2)'); // Checkout Date Column
              let deliveryCell = $(row).find('td:eq(3)'); // Delivery Date Column
              let actionsCell = $(row).find('td:eq(4)'); // Actions Column

              totalQtyCell.attr('colspan', 4).css({ "vertical-align": "top" });
              let summaryRow = `
                 <table class="table table-striped table-bordered">
                    <tbody>
                        <tr>
                            <td style="width: 27.2%;">${data.total_qty}</td>
                            <td style="width: 35.3%;">${data.contract_start_date}</td>
                            <td style="width: 26.1%;">${data.delivery_date}</td>
                            <td style="width: 27.7%;">${data.actions}</td>
                        </tr>
                    </tbody>
                </table>
              `;
              totalQtyCell.html(`
                  ${summaryRow}
                  <div>${data.products}</div>
              `);

              checkoutCell.hide();
              deliveryCell.hide();
              actionsCell.hide();
          }
      }

    });
    setInterval(function () {
        table.ajax.reload(null, false);
    }, 60000);
});

</script>



<script>
  $(document).ready(function () {
    $(".open-modal").click(function (event) {
      event.preventDefault();
      let url = $(this).attr("href");
      console.log('02-12 url: ', url);

      $.ajax({
        url: url,
        type: "GET",
        dataType: "json",
        success: function (data) {
          $("#modal-body").html(data.html);
          $("#show").modal("show");
        },
        error: function () {
          alert("Error loading modal data!");
        },
      });
    });
  });
</script>
<script>
  $(document).ready(function () {
    $(".overview").click(function (event) {
      event.preventDefault();
      let url = $(this).attr("data-url");
      console.log('02-12 url: ', url);

      $.ajax({
        url: url,
        type: "GET",
        dataType: "json",
        success: function (data) {
          $("#order-overview").html(data.html);
        },
        error: function () {
          alert("Error loading modal data!");
        },
      });
    });
  });
</script>
{% comment %} <script>
  $(document).ready(function() {

    var stageMapping = {
      1 : "Create Delivery",
      2 : "Pick Up Ticket",
      3 : "Check Out",
      4 : "Delivered To Customer",
      5 : "Create Return Delivery",
      6 : "Return Pick Up Ticket",
      7 : "Check In",
      8 : "Inspection Completed"
    };

    $('.steps a').on('click', function(event) {
      event.preventDefault();
      var stepNumber = $(this).find('.step').text();
      var stageKey = stageMapping[stepNumber];
      var newUrl = window.location.protocol + "//" + window.location.host + window.location.pathname + "?stage=" + stageKey;
      history.pushState({ path: newUrl }, '', newUrl);
      $("#deliveryTable").DataTable().ajax.reload(null, false);
    });

    $("a[href='#next']").on("click", function(e) {
      var foundElements = $(".steps li").find(".current");
      if (foundElements){
        value = $(".current a span.step").text();

        var stageKey = stageMapping[value];
        const url = new URL(window.location.href);

        url.searchParams.set('stage', stageKey);
        window.history.pushState({}, '', url);
        $("#deliveryTable").DataTable().ajax.reload(null, false);

        $.ajax({
          url: '{% url "rental:rent_process:update-stages" %}',
          type: 'POST',
          contentType: 'application/json',
          data: JSON.stringify({
            order_id: "{{order_obj.order_id}}",
            stage: `STAGE_${value}`,
          }),
          headers: {
              'X-CSRFToken': "{{ csrf_token }}",
          },
          success: function(response) {
              if (response.error) {
                // console.log("Error!!",response.error);
              } else {
                  // console.log("");
              }
          },
          error: function(xhr, status, error) {
              console.error('Error:', error);
          }
        });
      }
      else{
        // console.log("Not found elements:");
      }
    });

    $("a[href='#previous']").on("click", function(e) {
      // console.log("Previous Clicked");

      var foundElements = $(".steps li").find(".current");
      $("#deliveryTable").DataTable().ajax.reload(null, false);
      if (foundElements){
        value = $(".current a span.step").text();
        
        var stageKey = stageMapping[value];
        const url = new URL(window.location.href);
        

        url.searchParams.set('stage', stageKey);
        window.history.pushState({}, '', url);
        for (const [key, stageName] of Object.entries(stageMapping)) {
          if (stageKey === stageName) {
              rental_stageMapping[currentStage] = key - 1 ;
              break;  
          }
      }
      console.log('foundElements: ', foundElements);
      console.log('stageKey: ', stageKey);
      console.log('url: ', url);
      console.log('Updated rental_stageMapping: ', rental_stageMapping);
      }
      else{
        // console.log("Not found elements:");
      }
    });

    
  });
</script>

<script>
  console.log("jQuery is ready==========>>>!");
  var stageMapping = {
      1: "Create Delivery",
      2: "Pick Up Ticket",
      3: "Check Out",
      4: "Delivered To Customer",
      5: "Create Return Delivery",
      6: "Return Pick Up Ticket",
      7: "Check In",
      8: "Inspection Completed"
  };

  var rental_stageMapping = {}; // Store current stage

  function updateStage(stageKey) {
      $.each(stageMapping, function (key, stageName) {
          if (stageKey.includes(stageName)) {  // Match stage text
              rental_stageMapping["currentStage"] = key - 1;
              console.log("üîÑ Updated rental_stageMapping:", rental_stageMapping);
              return false; // Stop loop
          }
      });
  }

  // Handle clicks on wizard steps
  $("ul").on("click", "a[aria-controls^='steps']", function (event) {
      event.preventDefault(); // Prevent default behavior
      let clickedStageText = $(this).text().trim();
      console.log("üñ±Ô∏è Clicked Stage:", clickedStageText);
      updateStage(clickedStageText);
  });


</script> {% endcomment %}

<script>
  $(document).ready(function () {
      console.log(" jQuery is ready!");

      var stageMapping = {
          1: "Create Delivery",
          2: "Pick Up Ticket",
          3: "Check Out",
          4: "Delivered To Customer",
          5: "Create Return Delivery",
          6: "Return Pick Up Ticket",
          7: "Check In",
          8: "Inspection Completed"
      };

      var currentStageIndex = 0; // Default to first stage

      function updateURLAndReload(stageIndex) {
          var stageName = stageMapping[stageIndex + 1]; // Get stage name from mapping
          if (!stageName) return; // If no valid stage, exit
      
          //  Update rental_stageMapping
          rental_stageMapping[currentStage] = stageIndex;
          
          console.log(" Updating Stage:", stageName, "| Index:", stageIndex);
          console.log(" rental_stageMapping[currentStage]:", rental_stageMapping[currentStage]);
          console.log("All Keys in rental_stageMapping:", Object.keys(rental_stageMapping));
      
          // Update URL
          const url = new URL(window.location.href);
          url.searchParams.set('stage', stageName);
          window.history.pushState({}, '', url);
      
          // Reload DataTable
          $("#deliveryTable").DataTable().ajax.reload(null, false);
      }

      // üîπ Click on Steps (Direct Navigation)
      $(".steps a").on("click", function (event) {
          event.preventDefault();
          var stepNumber = parseInt($(this).find(".step").text()); // Get step number
          if (!isNaN(stepNumber)) {
              currentStageIndex = stepNumber - 1; // Update index
              updateURLAndReload(currentStageIndex);
          }
      });

      // üîπ Click on Next Button
      $("a[href='#next']").on("click", function (e) {
          if (currentStageIndex < Object.keys(stageMapping).length - 1) {
              currentStageIndex++; // Move to next stage
              //updateURLAndReload(currentStageIndex);

              // üîπ Send AJAX request
              $.ajax({
                  url: '{% url "rental:rent_process:update-stages" %}',
                  type: 'POST',
                  contentType: 'application/json',
                  data: JSON.stringify({
                      order_id: "{{order_obj.order_id}}",
                      stage: `STAGE_${currentStageIndex + 1}`, // Adjusting to 1-based index
                  }),
                  headers: {
                      'X-CSRFToken': "{{ csrf_token }}",
                  },
                  success: function (response) {
                      console.log(" Stage Updated:", response);
                  },
                  error: function (xhr, status, error) {
                      console.error(" Error:", error);
                  }
              });
          }
      });

      // üîπ Click on Previous Button
      $("a[href='#previous']").on("click", function (e) {
          if (currentStageIndex > 0) {
              currentStageIndex--; // Move to previous stage
              updateURLAndReload(currentStageIndex);
          }
      });

  });
</script>
