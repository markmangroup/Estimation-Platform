{% load static %}
<!-- Custom CSS start -->
<style>
  .delivered-to-customer-qty {
      width: 100px;
  }

  /* Custom striped table effect */
  .table-striped tbody tr:nth-of-type(odd) {
      background-color: rgba(0, 0, 0, 0.05) !important;
  }

  .table-dark.table-striped tbody tr:nth-of-type(odd) {
      background-color: #342E49 !important;
  }

  /* Ensure table borders and spacing */
  .table-bordered {
      border: 1px solid #ddd;
  }

  .table-bordered th, .table-bordered td {
      border: 1px solid #ddd;
      padding: 8px;
  }

  .table {
      width: 100%;
      border-collapse: collapse;
  }
  #delivered-to-customer-table{
    width: 100% !important;
  }
</style>
<!-- Print Button Start -->
<div class="float-left my-2 mt-3">
  <button type="button" class="btn btn-primary print-button" data-table-id="table4">Print</button>
</div>
<br>
<div class="" style="margin-left: 85%;">
  <label for="" class="form-label font-weight-bold">Global Status</label> 
  <select name="status" class="select2 form-control wizard-required" id="global-select-template-delivery">
    <option value="" disabled selected>None</option>
    <option value="Delivered To Customer">Delivered</option>
  </select>
</div>
<!-- Print Button End -->

<!-- New Table View Start -->
<div class="mt-5">
    <table id="delivered-to-customer-table" class="table table-striped table-bordered">
      <thead>
        <tr>
          <th style="max-width:100px">Delivery ID</th>
          <th style="max-width:100px">Total Quantity</th>
          <th style="max-width:100px">Contract Start Date</th> 
          <th style="max-width:100px">Delivery Date</th> 
        </tr>
      </thead>
      <tbody>
      </tbody>
    </table>
</div>
<!-- New Table View End-->

<!-- Old Table View Start -->
<!-- <div class="table-responsive mt-4">
    <table class="table table-stripted file-export">
        <thead>
            <th>Delivery ID</th>
            <th>CheckOut Date</th>
            <th>Deliveriy Date</th>
            <th>Total Quantity</th>
            <th>Status</th>
        </thead>
        <tbody>
            <tr>
                <td><a href="#" data-toggle="modal" data-target="#delivery_detail">DLI-1</a></td>
                <td>2 Apr,2024</td>
                <td>3 Apr,2024</td>
                <td>28</td>
                <td><button class="btn btn-success">Delivered</button></td>
            </tr>

            <tr>
                <td><a href="#" data-toggle="modal" data-target="#delivery_detail">DLI-2</a></td>
                <td>2 Apr,2024</td>
                <td>3 Apr,2024</td>
                <td>28</td>
                <td><button class="btn btn-success">Delivered</button></td>
            </tr>

            
        </tbody>
    </table>
</div> -->
<!-- Old Table View End-->

<!-- Delivery Detail Start -->
<!-- <div class="modal fade text-left" id="delivery_detail" tabindex="-1" role="dialog" aria-labelledby="myModalLabel33" aria-hidden="true" data-backdrop="false">
    <div class="modal-dialog modal-lg modal-dialog-centered" role="document">
        <div class="modal-content">
            <div class="modal-header">
            <h4 class="modal-title" id="myModalLabel5">DIL-1 : Customer Delivery Detail</h4>
            <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                <span aria-hidden="true"><i class="ft-x font-medium-2 text-bold-700"></i></span>
            </button>
        </div>
        <div class="modal-body">
            <table class="table table-striped table-bordered">
            <thead>
                <th>Internal ID</th>
                <th>Item</th>
                <th>Quantity</th>
            </thead>
                <tbody>
                    <tr>
                        <td>20315</td>
                        <td>Rental: 10" Plain Coupler</td>
                        <td>14</td>
                    </tr>
                    </tr>
                        <tr>
                        <td>20314</td>
                        <td>Rental: 10" Tapped Coupler</td>
                        <td>14</td>
                    </tr>
                </tbody>
            </table>
        </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-danger" data-dismiss="modal" aria-label="Close">Cancel</button>
                <button type="button" class="btn btn-success">OK</button>
            </div>
        </div>
    </div>
</div> -->
<!-- Delivery Detail End-->
<script>
  // Get the select element by its ID
  var selectElement = document.getElementById('global-select-template-delivery');
  $("#global-select-template-delivery").on("change", function (e){
    selectedValue = ($(this).val()) 
    if (selectedValue === "Delivered To Customer") {
      $(".another-select-delivered-to-customer").val("Delivered To Customer").trigger('change');
  } else {
      $(".another-select-delivered-to-customer").val("").trigger('change');
  }
  })

</script>
<script>
  var csrf_token = "{{ csrf_token }}";
  $(document).ready(function () {
    if ($.fn.dataTable.isDataTable('#delivered-to-customer-table')) {
        $('#delivered-to-customer-table').DataTable().clear().destroy();
    }
    var order_obj_id = "{{order.order_id}}"
    var url = "{% url 'rental:rent_process:delivered-to-customer-list-ajax' order_id='ORDER_ID' %}".replace('ORDER_ID', order_obj_id);
    let table = $("#delivered-to-customer-table").DataTable({
        processing: true,
        serverSide: true,
        ajax: {
            url: url,
            type: "GET",
        },
        columns: [
            { data: "delivery_id" },
            { data: "total_qty" },
            { data: "contract_start_date" },
            { data: "delivery_date" },
            //{ data: "actions", orderable: false, searchable: false },
        ],
        rowCallback: function (row, data, index) {
          if (data.products) {
              let totalQtyCell = $(row).find('td:eq(1)');
              let checkoutCell = $(row).find('td:eq(2)');
              let deliveryCell = $(row).find('td:eq(3)');

              // Merge the columns to fit all data in one row
              totalQtyCell.attr('colspan', 3).css({ "vertical-align": "top" });

              let summaryRow = `
                 <table class="table table-striped table-bordered">
                    <tbody>
                        <tr>
                            <td style="width: 28.5%;">${data.total_qty}</td>
                            <td style="width: 29.1%;">${data.contract_start_date}</td>
                            <td style="width: 27.7%;">${data.delivery_date}</td>
                        </tr>
                    </tbody>
                </table>
              `;

              totalQtyCell.html(`
                  ${summaryRow}
                  <div>${data.products}</div>
              `);

              checkoutCell.hide();
              deliveryCell.hide();
              //actionsCell.hide();
          }
      }

    });

    setInterval(function () {
        table.ajax.reload(null, false);
    }, 60000);

    $(document).on('input', '.delivered-to-customer-qty', function() {
      // Get the expected quantity from the data-value attribute
      const expectedQty = parseInt($(this).data('value'), 10) || 0;
      // Get the entered quantity, allowing only numbers
      const filteredValue = $(this).val().replace(/[^0-9]/g, '');
      $(this).val(filteredValue);
      const enteredQty = parseInt(filteredValue, 10) || 0;
  
      // Find the specific message element for this input
      const messageElement = $(this).siblings(".quantityMessage");
  
      if (filteredValue === "") {
          messageElement.html('');
      } else if (enteredQty < expectedQty) {
          messageElement.html(`<span class="warning"><i class="ft-alert-triangle"></i> Quantity does not match. Please resolve it....</span>`);
          console.log("Entered quantity is less than required.");
      } else if (enteredQty > expectedQty) {
          messageElement.html(`<span class="warning"><i class="ft-alert-triangle"></i> Quantity does not match. Please resolve it....</span>`);
          console.log("Entered quantity is more than required.");
      } else {
          messageElement.html('');
          console.log('Quantity matched correctly.');
      }
  });
  
  let isUpdating = false;

  $(document).off("change", ".delivered-to-customer-contract-start-date").on("change", ".delivered-to-customer-contract-start-date", function () {
    if (isUpdating) return; // Don't allow another request if one is already in progress
    isUpdating = true;
  
    let selectedDate = $(this).val();
    let deliveryId = $(this).data("delivery-id");
    let successMessage = $(this).siblings(".success-message");
    let errorMessage = $(this).siblings(".error-message");
    var delivered_to_customer_update_url = "{% url 'rental:rent_process:delivered_to_customer_update_date' %}";
  
    console.log(`Updating delivery ${deliveryId} with date: ${selectedDate}`);
  
    $.ajax({
        url: delivered_to_customer_update_url,
        type: "POST",
        headers: {
            "X-CSRFToken": csrf_token,
        },
        data: JSON.stringify({
            delivery_id: deliveryId,
            contract_start_date: selectedDate,
        }),
        contentType: "application/json",
        dataType: "json",
        success: function (response) {
            isUpdating = false; // Reset the flag when the request is complete
  
            if (response.success) {
                toastr.success("Date Updated Successfully!", 'Success', {
                    closeButton: true,
                    progressBar: true,
                    positionClass: 'toast-bottom-right',
                    timeOut: 6000
                });
            } else {
                errorMessage.text(response.error).show().delay(2000).fadeOut();
            }
        },
        error: function (xhr, status, error) {
            isUpdating = false; // Reset the flag even in case of error
            console.log("Error:", error);
            errorMessage.text("Failed to update date.").show().delay(2000).fadeOut();
        },
    });
  });

});
</script>

<script>
  $(document).ready(function () {
      // Global status change
      $("#global-select-template-delivery").on("change", function () {
          var selectedValue = $(this).val();
          var order_obj_id = "{{ order.order_id }}";
  
          if (selectedValue === "Delivered To Customer") {
              $.ajax({
                  url: "{% url 'rental:rent_process:change_delivery_delivered_to_customer_status' %}",
                  type: "POST",
                  headers: {
                      'X-CSRFToken': "{{ csrf_token }}",
                  },
                  data: JSON.stringify({
                      global_status_change: true,
                      order_id: order_obj_id
                  }),
                  contentType: "application/json",
                  success: function (response) {
                      if (response.success) {
                          $(".another-select-delivered-to-customer").val("Delivered To Customer").trigger('change');
                      } else {
                          $(".another-select-delivered-to-customer").val("").trigger('change');
                      }
                  },
                  error: function () {
                      console.error("Error checking delivery status.");
                  }
              });
          } else {
              $(".another-select-delivered-to-customer").val("").trigger('change');
          }
      });
  
      // Individual status change

      $(document).off("change", ".another-select-delivered-to-customer").on("change", ".another-select-delivered-to-customer", function () {
          var selectedValue = $(this).val();
          console.log('selectedValue: ', selectedValue);
          var deliveryId = $(this).data("delivery-id");
          console.log('deliveryId: ', deliveryId);
          var deliveryPK = $(this).data("delivery-pk");
          console.log('deliveryPK: ', deliveryPK);
          var $this = $(this); // Store reference to 'this'
      
          if (selectedValue === "Delivered To Customer") {
              $.ajax({
                  url: "{% url 'rental:rent_process:change_delivery_delivered_to_customer_status' %}",
                  type: "POST",
                  headers: {
                      'X-CSRFToken': "{{ csrf_token }}",
                  },
                  data: JSON.stringify({
                      global_status_change: false,
                      delivery_id: deliveryId,
                      delivery_pk: deliveryPK
                  }),
                  contentType: "application/json",
                  success: function (response) {
                      if (!response.success) {
                          $this.val(""); 
                      }else{
                          toastr.success("Status Updated Successfully!", 'Success', {
                              closeButton: true,
                              progressBar: true,
                              positionClass: 'toast-bottom-right',
                              timeOut: 6000
                          });
                      }
                  },
                  error: function () {
                      console.error("Error updating individual delivery status.");
                      $this.val(""); 
                  }
              });
          }
      });
      
  });
  
</script>

