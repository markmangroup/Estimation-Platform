{% load static %}
<style>
  .checkout-qty {
      width: 100px;
  }

  / Custom striped table effect /
  .table-striped tbody tr:nth-of-type(odd) {
      background-color: rgba(0, 0, 0, 0.05) !important;
  }

  .table-dark.table-striped tbody tr:nth-of-type(odd) {
      background-color: #342E49 !important;
  }

  / Ensure table borders and spacing /
  .table-bordered {
      border: 1px solid #ddd;
  }

  .table-bordered th, .table-bordered td {
      border: 1px solid #ddd;
      padding: 8px;
  }

  .table {
      width: 100%;
      border-collapse: collapse;
  }
</style>
<!-- Print Button Start -->
<div class="float-left my-2 mt-3">
  <button type="button" class="btn btn-primary print-button" data-table-id="table2">Print</button>
</div>
  <!-- Global Select Component -->
<br>
{% comment %} <div class="" style="margin-left: 85%;">
  <label for="" class="form-label font-weight-bold">Global Status</label> 
  <select name="status" class="select2 form-control wizard-required" id="global-select-template">
    <option value="" disabled selected>None</option>
    <option value="Loaded">Loaded</option>
  </select>
</div> {% endcomment %}

<div class="" style="margin-left: 85%;">
    <label for="" class="form-label font-weight-bold">Global Status</label> 
    <select name="status" class="select2 form-control wizard-required" id="global-select-template-Loaded">
      <option value="" disabled selected>None</option>
      <option value="Loaded">Loaded</option>
    </select>
  </div>
<!-- Print Button End -->

<!-- New Table View -->
<div class="mt-5">
    <table id="pickuptable" class="table table-bordered" style="width:100% !important;">
      <thead>
          <tr>
              <th>Delivery ID</th>
              <th>Total Quantity</th>
              <th>PickUp Date</th>
              <th>Delivery Date</th>
          </tr>
      </thead>
      <tbody></tbody>
  </table>
</div>

<script>

    let debounceTimer;

    $(document).on("change", ".another-select-Loaded, .pickup-date-input", function () {
        clearTimeout(debounceTimer);
        debounceTimer = setTimeout(() => {
            let row = $(this).closest("tr");
            let deliveryId = $(this).data("delivery-id");
            let table = $('table[data-table-id="' + deliveryId + '"]').first();
            let newPickupDate = row.find(".pickup-date-input").val();
    
            if (table.length === 0) {
                console.log("Table not found for delivery ID:", deliveryId);
                return;
            }
    
            console.log("Table found for delivery ID:", deliveryId, table);
    
            if ($(this).hasClass("pickup-date-input")) {
                let deliveries = [{
                    delivery_id: deliveryId,
                    pickup_date: newPickupDate
                }];
    
                $.ajax({
                    url: "{% url 'rental:rent_process:update_pickup_date' %}",
                    type: "POST",
                    data: {
                        deliveries: JSON.stringify(deliveries),
                        csrfmiddlewaretoken: "{{ csrf_token }}",
                    },
                    success: function (response) {
                        toastr.success("Pickup date updated successfully!", 'Success', {
                            closeButton: true,
                            progressBar: true,
                            positionClass: 'toast-bottom-right',
                            timeOut: 6000
                        });
                    },
                    error: function () {
                        toastr.error("Error updating pickup date.");
                    }
                });
            }
    
            let allLoaded = true;
            table.find(".another-select-Loaded").each(function () {
                let statusValue = $(this).val();
                console.log("Checking status:", statusValue);
    
                if (statusValue === "None" || statusValue === "" || statusValue === null || statusValue !== "Loaded") {
                    allLoaded = false;
                    return false;
                }
            });
    
            if (allLoaded) {
                console.log("All statuses are 'Loaded'. Making AJAX request...");
    
                let deliveries = [{
                    delivery_id: deliveryId,
                    status: "Loaded"
                }];
    
                $.ajax({
                    url: "{% url 'rental:rent_process:update_pickup_date' %}",
                    type: "POST",
                    data: {
                        deliveries: JSON.stringify(deliveries),
                        csrfmiddlewaretoken: "{{ csrf_token }}",
                    },
                    success: function (response) {
                        toastr.success("All items in this table are Loaded. Status updated!", 'Success', {
                            closeButton: true,
                            progressBar: true,
                            positionClass: 'toast-bottom-right',
                            timeOut: 6000
                        });
                    },
                    error: function () {
                        toastr.error("Error updating data.");
                    }
                });
            } else {
                console.log("Not all statuses are 'Loaded'. AJAX request skipped.");
            }
        }, 300); // 300ms debounce
    });
    
</script>
<script>
  $(document).ready(function () {
    if ($.fn.dataTable.isDataTable('#pickuptable')) {
        $('#pickuptable').DataTable().clear().destroy();
    }
    var order_obj_id = "{{order.order_id}}"
    var url = "{% url 'rental:rent_process:pickup_ticket_list_ajax' order_id='ORDER_ID' %}".replace('ORDER_ID', order_obj_id);

    let table = $("#pickuptable").DataTable({
        processing: true,
        serverSide: true,
        ajax: {
            url: url,
            type: "GET",
        },
        columns: [
            { data: "delivery_id" },
            { data: "total_qty" },
            { data: "pickup_date" },
            { data: "delivery_date" },
            
        ],
        rowCallback: function (row, data, index) {
          if (data.products) {
              let totalQtyCell = $(row).find('td:eq(1)');
              let checkoutCell = $(row).find('td:eq(2)');
              let deliveryCell = $(row).find('td:eq(3)');
              let actionsCell = $(row).find('td:eq(4)');

              totalQtyCell.attr('colspan', 4).css({ "vertical-align": "top" });
              let pickupDateInput = `<input type="date" class="form-control today-date wizard-required pickup-date-input" data-delivery-id="${data.delivery_id}" value="${data.pickup_date !== '-' ? moment(data.pickup_date, 'DD MMMM, YYYY').format('YYYY-MM-DD') : ''}" />`;

              let summaryRow = `
                 <table class="table table-striped table-bordered">
                    <tbody>
                        <tr>
                            <td style="width: 28.9%;">${data.total_qty}</td>
                            <td style="width: 29.1%;">${pickupDateInput}</td>
                            <td style="width: 27.7%;">${data.delivery_date}</td>
                        </tr>
                    </tbody>
                </table>
              `;
              totalQtyCell.html(`
                  ${summaryRow}
                  <div>${data.products}</div>
              `);

              checkoutCell.hide();
              deliveryCell.hide();
              actionsCell.hide();
          }
      }

    });
    setInterval(function () {
        table.ajax.reload(null, false);
    }, 60000);
});

</script>
<script>
    $("#global-select-template-Loaded").on("change", function () {
        let selectedValue = $(this).val();
    
        if (selectedValue === "Loaded") {
            $(".another-select-Loaded").val("Loaded").trigger('change');
        } else {
            $(".another-select-Loaded").val("").trigger('change');
        }
    
        // Collect all delivery IDs
        let deliveries = [];
        $(".another-select-Loaded").each(function () {
            let deliveryId = $(this).data("delivery-id");
    
            if (deliveryId) {
                deliveries.push({
                    delivery_id: deliveryId,
                    status: selectedValue || "None"
                });
            }
        });
        if (deliveries.length > 0) {
            $.ajax({
                url: "{% url 'rental:rent_process:update_pickup_date' %}",
                type: "POST",
                data: {
                    deliveries: JSON.stringify(deliveries),
                    csrfmiddlewaretoken: "{{ csrf_token }}",
                },
                success: function (response) {
                    toastr.success("Global Status updated successfully!", 'Success', {
                        closeButton: true,
                        progressBar: true,
                        positionClass: 'toast-bottom-right',
                        timeOut: 6000
                    });
                },
                error: function () {
                    toastr.error("Error updating Global Status.");
                }
            });
        }
    });
</script>    
<script>
    var selectElement = document.getElementById('global-select-template-Loaded');
    $("#global-select-template-Loaded").on("change", function (e){
      selectedValue = ($(this).val()) 
      if (selectedValue === "Loaded") {
        $(".another-select-Loaded").val("Loaded").trigger('change');
    } else {
        $(".another-select-Loaded").val("").trigger('change');
    }
    })
</script>