{% load static %}

<!-- Adjust modal width -->
<style>
  .mass-update {
    max-width: 55vw;
  }
</style>
<!-- Adjust modal width -->
<div class="row">
  <div class="col-12">
    <div class="content-header">Stock Adjustment</div>
  </div>
</div>

<div class="card">
  <div class="card-body">
      <div class="row">
          <!-- Filters Start -->

          <div class="col-3">
            <label for="equipment_id" class="form-label font-weight-bold">Equipment ID</label>
            <select class="select2 form-control" multiple id = "equipment_id">
              {% for equipment_id in equipment_ids %}
                <option value="{{ equipment_id }}">{{ equipment_id }}</option>
              {% endfor %}
            </select>
          </div>

          <div class="col-3">
            <label for="equipment_material_group" class="form-label font-weight-bold">Equipment Material Group</label>
            <select class="select2 form-control" multiple id = "equipment_material_group">
              {% for material_group in equipment_material_groups %}
                <option value="{{ material_group }}">{{ material_group }}</option>
              {% endfor %}
            </select>
          </div>

          <div class="col-3">
            <label for="equipment_name" class="form-label font-weight-bold">Equipment Name</label>
            <select class="select2 form-control" multiple id = "equipment_name">
              {% for equipment_name in equipment_names %}
                <option value="{{ equipment_name }}">{{ equipment_name }}</option>
              {% endfor %}
            </select>
          </div>

          <div class="col-3">
            <label for="location" class="form-label font-weight-bold">Location</label>
            <select class="select2 form-control" multiple id = "location">
              {% for location in locations %}
                <option value="{{ location }}">{{ location }}</option>
              {% endfor %}
            </select>
          </div>

          <!-- Filters End -->
      </div>
  </div>
</div>

<!-- Wizard Starts -->
<section id="icon-tabs">
  <div class="row">
    <div class="col-12">
      <div class="card">
        <div class="card-content">
            <div class="row mt-2 justify-content-end">
              <div class="col-7 mt-2">
                <div class="float-right mb-3">
                  <div class="col-12 my-1">
                    <button
                      class="btn bg-light-info"
                      onclick="DownloadProductsInCSV('StockAdjustmentReport')"
                    >
                      <em class="ft-download"></em> Stock Adjustment Report CSV
                    </button>

                     <!-- Import Order Starts -->
                     <a hx-get="{% url 'rental:stock_management:import-mass_stock' %}" class="btn bg-light-secondary" data-toggle="modal" data-target="#exampleModal" hx-target="#stock-massform">
                      <i class="fa ft-briefcase"></i> Mass Stock Adjustment
                     </a>

                   <!-- Import Order Modal -->
                    <div class="modal fade text-left" id="exampleModal" tabindex="-1" role="dialog" aria-labelledby="myModalLabel33" aria-hidden="true" data-backdrop="false">
                      <div class="modal-dialog modal-dialog-centered" role="document">
                        <div class="modal-content">
                          <div class="modal-header">
                              <h4 class="modal-title" id="myModalLabel5">
                                Import Order
                              </h4>
                              <button
                                type="button"
                                class="close"
                                data-dismiss="modal"
                                aria-label="Close"
                              >
                                <span aria-hidden="true">
                                  <i class="ft-x font-medium-2 text-bold-700"></i>
                                </span>
                              </button>
                          </div>
                          <div class="modal-body" id="stock-massform">

                          </div>

                        </div>
                      </div>
                    </div>
                    <!-- Import Order Modal -->
                </div>
              </div>
            </div>
          <div class="card-body">
            <div id="StockAdjustmentReport" class="table-responsive">
              <table
                class="table table-striped table-bordered" id="stock_management_list"
              >
                <thead>
                  <tr>
                    <th>Equipment ID</th>
                    <th>Equipment Material Group</th>
                    <th>Equipment Name</th>
                    <th >Quantity</th>
                    <th>Location</th>
                    <th>Action</th>
                  </tr>
                </thead>
                <tbody>

                </tbody>
              </table>
            </div>
          </div>
        </div>
      </div>
    </div>

    <div id="stockform">

    </div>

  </div>
</section>

<!-- Js Start -->
<script src="{% static 'app/js/jquery.min.js' %}"></script>
<script src="{% static 'vendors/js/select2.full.min.js' %}"></script>
<script src="{% static 'app/js/select2.min.js' %}"></script>
<script src="{% static 'app/js/ex-component-upload.min.js' %}"></script>
<!-- Js End -->

<!-- BEGIN PAGE LEVEL JS-->
<!-- <script src="{% static 'app/js/data-tables/dt-data-sources.min.js' %}"></script> -->
<!-- END PAGE LEVEL JS-->

<script>

 $(document).ready(function() {
      $("#stock_management_list").DataTable({
          autoWidth: false,
          order: [[0, 'asc']],
          processing: true,
          serverSide: true,
          ajax: {
            url : '{% url "rental:stock_management:rental-stock-management-list-ajax" %}',
            type: 'GET',
            data: function(d) {
                return $.extend({}, d, set_filters());
            }
          },
          columns : [
            { data: 'equipment_id', name: 'rental_product__equipment_id'},
            { data: 'equipment_material_group', name: 'rental_product__equipment_material_group' },
            { data: 'equipment_name', name: 'rental_product__equipment_name'},
            { data: 'quantity', name: 'quantity'},
            { data: 'location', name: 'location' },
            { data: 'actions', name: 'actions', orderable: false, searchable: false }
        ],
      });

      function set_filters() {
          return {
            equipment_id: $("#equipment_id").val(),
            equipment_material_group: $("#equipment_material_group").val(),
            equipment_name: $("#equipment_name").val(),
            location: $("#location").val(),
          };
      }
  });

  $('#equipment_id, #equipment_material_group, #equipment_name, #location').on("change", function() {
    $("#stock_management_list").DataTable().ajax.reload();
  });

  </script>

<!-- Download CSV formate Script Start -->
<script>
  function DownloadProductsInCSV(id, fileName) {
    var table = document.getElementById(id);

    // Extract headers from the table
    var headers = [];
    var headerRow = table.querySelector("tr");
    var headerCols = headerRow.querySelectorAll("th, td");
    headerCols.forEach(function(col) {
      headers.push('"' + col.innerText.replace(/"/g, '""') + '"'); // Wrap headers in quotes and escape double quotes
    });
    var csvContent = headers.join(",") + "\n";

    // Add data rows to CSV content (start from the second row)
    var rows = table.querySelectorAll("tr");
    for (var i = 1; i < rows.length; i++) { // Start from index 1 to skip the header row
      var rowData = [];
      var cols = rows[i].querySelectorAll("td");
      cols.forEach(function(col) {
        rowData.push('"' + col.innerText.replace(/"/g, '""') + '"'); // Wrap cell data in quotes and escape double quotes
      });
      csvContent += rowData.join(",") + "\n";
    }

    // Create Blob object
    var blob = new Blob([csvContent], { type: "text/csv" });

    // Create temporary URL
    var url = window.URL.createObjectURL(blob);

    // Create a link element
    var link = document.createElement("a");
    link.setAttribute("href", url);
    link.setAttribute("download", fileName + ".csv");

    // Simulate a click on the link
    link.click();

    // Remove the temporary URL
    window.URL.revokeObjectURL(url);
  }
</script>
<!-- Download CSV formate Script End -->

<!-- Date picker Start -->
<script type="text/javascript">
  $(document).ready(function() {

      var start = moment().subtract(29, 'days');
      var end = moment();

      function cb(start, end) {
          $('.reportrange span').html(start.format('MMMM D, YYYY') + ' - ' + end.format('MMMM D, YYYY'));
      }

      $('.reportrange').daterangepicker({
          startDate: start,
          endDate: end,
          ranges: {}
      }, cb);

      cb(start, end);

  });
</script>
<!-- Date picker End -->

<!-- Calculation of stock adjustment Start -->
<script>
  $(document).ready(function() {
    const currentQuantity = 1593;

    const $plusInput = $('#PluseQuantity');
    const $minusInput = $('#minusQuantity');
    const $revisedInput = $('#revisedQuantity');

    // Function to update plus quantity based on revised quantity
    function updatePlusQuantity() {
      const enteredRevisedQuantity = parseFloat($revisedInput.val()) || 0;
      const newPlusQuantity = Math.max(0, enteredRevisedQuantity - currentQuantity);
      $plusInput.val(newPlusQuantity);
    }

    // Function to update minus quantity based on revised quantity
    function updateMinusQuantity() {
      const enteredRevisedQuantity = parseFloat($revisedInput.val()) || 0;
      const newMinusQuantity = Math.max(0, currentQuantity - enteredRevisedQuantity);
      $minusInput.val(newMinusQuantity);
    }

    // Function to update revised quantity based on plus and minus quantities
    function updateRevisedQuantity() {
      const plusQuantity = parseFloat($plusInput.val()) || 0;
      const minusQuantity = parseFloat($minusInput.val()) || 0;
      const newRevisedQuantity = currentQuantity + plusQuantity - minusQuantity;
      $revisedInput.val(newRevisedQuantity);
    }

    // Event handlers
    $plusInput.on('input', function() {
      updateRevisedQuantity();
      updateMinusQuantity();
    });

    $minusInput.on('input', function() {
      updateRevisedQuantity();
      updatePlusQuantity();
    });

    $revisedInput.on('input', function() {
      updatePlusQuantity();    // Update plus quantity when revised quantity changes
      updateMinusQuantity();   // Update minus quantity when revised quantity changes
    });

    // Initialize values on page load
    updateRevisedQuantity();
    updatePlusQuantity();
    updateMinusQuantity();
  });
</script>
<!-- Calculation of stock adjustment End -->

<script>
  $(document).ready(function() {
    // Get today's date
    var today = new Date();

    // Set the input field to today's date
    var todayStr = today.toISOString().split('T')[0];
    $('.today-date').val(todayStr);

    // Get the start and end of the current month
    var startOfMonth = new Date(today.getFullYear(), today.getMonth(), 1);
    var endOfMonth = new Date(today.getFullYear(), today.getMonth() + 1, 0);

    // Format dates as YYYY-MM-DD
    var startOfMonthStr = startOfMonth.toISOString().split('T')[0];
    var endOfMonthStr = endOfMonth.toISOString().split('T')[0];

    // Set min and max attributes of the date inputs
    $('.today-date').attr('min', startOfMonthStr);
    $('.today-date').attr('max', endOfMonthStr);
  });
</script>
