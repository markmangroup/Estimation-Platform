{% load static %}

<div class="d-flex justify-content-end">
  <button
    type="button"
    class="btn bg-light-secondary htmx-trigger-btn mb-2"
    hx-get="{% url 'proposal_app:opportunity:select-task-model' opportunity.document_number %}"
    hx-target="#selectTaskModal"
    hx-trigger="click"
    data-toggle="modal"
    data-target="#selectTaskModal"
  >
    <em class="ft-plus font-medium-5"></em> Add Tasks
  </button>
</div>

<!-- Select Task Modal Start -->
<div class="modal fade text-left" id="selectTaskModal" tabindex="-1" role="dialog" aria-labelledby="myModalLabel33" aria-hidden="true" data-backdrop="false">
  <div class="modal-dialog modal-dialog-centered" role="document">
      <div class="modal-content">
          <div id="modelSelectTask">
              <!-- Content loaded by htmx will appear here -->
          </div>
      </div>
  </div>
</div>
<!-- Select Task Modal End -->

<div class="table-responsive">
  <table id= "selected-task-table" class="table table-striped table-bordered" style="width:100%;">
    <thead>
        <tr>
            <th>Internal ID</th>
            <th>Name</th>
            <th>Description</th>
            <th>Action</th>
        </tr>
    </thead>
  </table>
</div>

<!-- Htmx -->
<script>
  $(document).on('click', '.htmx-trigger-btn' , function (e) {
    url = "{% url 'proposal_app:opportunity:select-task-model' opportunity.document_number %}"
    htmx.ajax('GET',
        url,
        {
          target:'#modelSelectTask',
          swap:'innerHTML',
    }).then(() => {
        $('#selectTaskModal').toggleClass('hidden');
    })
  })
</script>
<!-- Htmx -->

<!-- Datatabele -->
<script>
  var table_task = initializeDataTable();

  function initializeDataTable() {
      return $('#selected-task-table').DataTable({
          processing: true,
          serverSide: true,
          destroy: true,
          ajax: {
              url: "{% url 'proposal_app:opportunity:ajax-selected-task-list' opportunity.document_number %}",
              type: 'GET',
          },
          columns: [
          { data: 'task__internal_id', name: 'task__internal_id' },
          { data: 'task__name', name: 'task__name' },
          { data: 'task__description', name: 'task__description' },
          { data: 'action', name: 'action' },
        ],
        columnDefs: [
        {
            targets: 3,
            className: 'text-center w-80',
            orderable: false,
        }
      ],

      });
  }
</script>
<!-- Datatabele -->

<!-- Go to Current Stage -->
<script>
  $(document).ready(function() {
    var foundElements = $(".steps li").find(".current a");

  });
</script>
<!-- Go to Current Stage -->

<!-- Update Stages -->
<script>
  $(document).ready(function() {
    $("a[href='#next']").on("click", function(e) {
      var foundElements = $(".steps li").find(".current");
      if (foundElements){
        value = $(".current a span.step").text();
        $.ajax({
          url: '{% url "proposal_app:opportunity:update-stages" %}',
          type: 'POST',
          contentType: 'application/json',
          data: JSON.stringify({
            document_number: "{{opportunity.document_number}}",
            stage: `STAGE_${value}`,
          }),
          headers: {
              'X-CSRFToken': "{{ csrf_token }}",
          },
          success: function(response) {
              if (response.error) {
                // console.log("Error!!",response.error);
              } else {
                  // console.log("");
              }
          },
          error: function(xhr, status, error) {
              console.error('Error:', error);
          }
        });
      }
      else{
        // console.log("Not found elements:");
      }
    });

    $("a[href='#previous']").on("click", function(e) {
      // console.log("Previous Clicked");
      var foundElements = $(".steps li").find(".current");
      if (foundElements){
        value = $(".current a span.step").text();
      }
      else{
        // console.log("Not found elements:");
      }
    });
  });
</script>
<!-- Update Stages -->

<!-- Update description Ajax -->
<script>
  $(document).on("change", ".edi-description", function(e) {
      var field = $(this);
      var id = field.data('id');
      var description = field.val();

      if (!id || !description) {
          toastr.error("Task code ID and description are required.", "Validation Error", {
              closeButton: true,
              progressBar: true,
              positionClass: "toast-bottom-right",
              timeOut: 4000
          });
          return;
      }

      $.ajax({
          url: "{% url 'proposal_app:opportunity:update-selected-task-ajax' %}",
          type: 'POST',
          data: {
              task_code_id: id,
              task_description: description,
              csrfmiddlewaretoken: '{{ csrf_token }}'
          },
          success: function(response) {
              toastr.success(response.message || "Description updated successfully.", "Success", {
                  closeButton: true,
                  progressBar: true,
                  positionClass: 'toast-bottom-right',
                  timeOut: 6000
              });
          },
          error: function(xhr) {
              var message = xhr.responseJSON ? xhr.responseJSON.message : "An error occurred";
              toastr.error(message, "Error", {
                  closeButton: true,
                  progressBar: true,
                  positionClass: 'toast-bottom-right',
                  timeOut: 6000
              });
          }
      });
  });
</script>

<!-- Delete Task Ajax-->
<script>
	$(document).on('click', '.delete-task', function (e) {
		var id = $(this).data("id")
		var title = $(this).data("title")
		if (title == "None") {
			title = ""
		}
		var url = $(this).data("url")
		var delete_ele = $(this)

		Swal.fire({
			html: `Are you sure you want to delete <b>${title}</b>?`,
			icon: 'question',
			showCloseButton: true,
			showCancelButton: true,
			confirmButtonColor: "#7442DB",

		}).then((result) => {

			/* Read more about isConfirmed, isDenied below */
			if (result.isConfirmed) {
				$.ajax({
					type: "POST",
					url: url,
					data: {
						"id": id,
						"csrfmiddlewaretoken": '{{ csrf_token }}'
					},
					success: function (data) {

						$("#selected-task-table").DataTable().ajax.reload(null, false);

            if (data["code"] == "400"){
              toastr.error(data.message, 'Error', {
                closeButton: true,
                progressBar: true,
                positionClass: 'toast-bottom-right',
                timeOut: 6000
              });
            } else if (data["code"] == "200") {
              toastr.info(data.message, 'Deleted', {
                closeButton: true,
                progressBar: true,
                positionClass: 'toast-bottom-right',
                timeOut: 6000
              });
						}
					}
				});
			}else {
          Swal.fire("Cancel delete", "", "info");
      }
		})
	})
</script>