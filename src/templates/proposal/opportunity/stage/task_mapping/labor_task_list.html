{% load custom_filters %}
{% for t_id, t_info in task_mapping_labor_list.items %}

<tr class="labor-task-tr">
    <td >
        <select data-id="{{t_id}}" class="select2-labor-task form-control">
        <option selected disabled>{{t_info.task.code}}</option>
        </select>
    </td>
    <td><input type="text" class="form-control task_description" data-id="{{ t_id }}" value="{{t_info.task.description}}" /></td>
    <td class="mapping-total-price-{{t_id}} t-price">${{ t_info.total_price }}</td>
    <td class="mapping-total-percent-{{t_id}} t-percent">{{ t_info.total_percent }}%</td>
    <td class="mapping-total-qauntiy-{{t_id}} t-quantity">{{ t_info.total_quantity }}</td>
    <td>EA</td>
    <td class="mapping-total-price-{{t_id}}">${{ t_info.total_unit_price }}</td>
    <td>
        <a data-toggle="collapse" href="#collapse{{t_id}}" aria-expanded="true" aria-controls="collapse{{t_id}}" class="card-title">
        <em class="ft-chevron-down font-medium-5"></em>
        </a>
    </td>
</tr>

<tr id="collapse{{t_id}}" role="tabpanel" aria-labelledby="headingCollapse{{t_id}}" class="collapse">

    <td>
    </td>

    <td colspan="100">

        <div class="float-left my-2">
            <label>Assign labor to task:</label>
            {% if t_info.task.assign_to %}
            <select class="select-labor-task" name="" data-url="{% url "proposal_app:opportunity:assign-task-labor" opportunity.document_number %}" data-id={{t_id}} data-document={{ opportunity.document_number }}>
                <option value="{{t_info.task.assign_to}}">{{t_info.task.assign_to}}</option>
            </select>
            {% else %}
            <select class="select-labor-task" name="" data-url="{% url "proposal_app:opportunity:assign-task-labor" opportunity.document_number %}" data-id={{t_id}} data-document={{ opportunity.document_number }}>
                <option selected disabled>Select task</option>
            </select>
            {% endif %}

        </div>

        <div class="float-right my-2">
            <button  type="button" class="btn bg-light-primary" data-backdrop="false"
            data-toggle="modal" data-target="#addlabor{{t_id}}">
                <em class="ft-plus font-medium-5"></em> Add labor
            </button>

            <!-- Add Labor Modal -->
            <div class="modal fade text-left" id="addlabor{{t_id}}" tabindex="-1" role="dialog" aria-labelledby="myModalLabel5" aria-hidden="true">
            <div class="modal-dialog modal-md modal-dialog-centered" role="document">
                <div class="modal-content">
                <div class="modal-header">
                    <h4 class="modal-title" id="myModalLabel5">Add labor</h4>
                    <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                    <span aria-hidden="true"><i class="ft-x font-medium-2 text-bold-700"></i></span>
                    </button>
                </div>
                <div class="modal-body">
                    <section id="multiple-select2">
                    <div class="card">
                        <div class="card-content">
                        <div class="card-body">
                            <div class="form-group">
                                <label>Enter the number of fields</label>
                                <input id="totalRows{{t_id}}" type="text" class="form-control mb-1" placeholder="Enter the number of fields">
                            </div>
                        </div>
                        </div>
                    </div>
                    </section>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn bg-light-secondary" data-dismiss="modal">Close</button>
                    <button type="button" data-id="{{t_id}}" class="btn btn-primary add-multi-labor-row-btn" data-dismiss="modal"><em class="ft-plus font-medium-5"></em> Add Labor</button>
                </div>
                </div>
            </div>
            </div>

        </div>

        <div class="table-responsive">
            <table id="tableBody-{{t_id}}" class="table table-striped table-bordered">

                <thead>
                    <tr class="text-center">
                    <th colspan="1"></th>
                    <th colspan="6" class="align-top">Project Labor Information</th>
                    <th colspan="1" class="align-top">Cost</th>
                    <th colspan="2" class="align-top">Sell</th>
                    <th colspan="2" class="align-top">Gross Profit</th>
                    <th colspan="2" class="align-top"></th>
                    </tr>
                    <tr>
                    <th>Sr No</th>

                    <th class="text-nowrap">Quantity</th>
                    <th class="text-nowrap">Labor task</th>
                    <th >Description</th>
                    <th>Standard Cost</th>
                    <th>Vendor Quoted cost</th>
                    <th>Item Note</th>

                    <th>Total</th>

                    <th>Sell</th>
                    <th>Total</th>

                    <th>$</th>
                    <th>%</th>


                    <td></td>

                    </tr>
                </thead>

                <tbody id="labor-{{t_id}}" class="sortable">

                    {% for ap in t_info.assigned_products %}

                    <tr class="tr-{{t_id}}" data-row-id="{{ap.id}}">
                        <td class="sr-no">{{forloop.counter}}</td>
                        <td class="text-nowrap">
                            <input type="text" class="form-control quantity" data-id="{{ap.id}}" data-task-id="{{t_id}}" value="{{ap.quantity}}"/>
                        </td>
                        <td class="text-nowrap">{{ap.labor_task}}</td>
                        <td>{{ap.description}}</td>
                        <td class="text-nowrap">
                        {% if ap.standard_cost %}
                            <input type="text" data-id="{{ap.id}}" class="form-control standard-cost" data-task-id="{{t_id}}" value="{{ap.standard_cost}}">
                        {% else %}
                            <input type="text" data-id="{{ap.id}}" class="form-control standard-cost" data-task-id="{{t_id}}" value="{{ap.standard_cost}}">
                        {% endif %}
                        </td>
                        <td class="text-nowrap">
                        {% if ap.vendor_quoted_cost %}
                            <input type="text" data-id="{{ ap.id }}" class="form-control vendor-quoted-cost" data-task-id="{{t_id}}" value="{{ap.vendor_quoted_cost}}">
                        {% else %}
                            <input type="text" data-id="{{ ap.id }}" class="form-control vendor-quoted-cost" data-task-id="{{t_id}}" value="{{ap.vendor_quoted_cost}}">
                        {% endif %}
                        </td>
                        <td><input  type="text" id="comment-{{ap.id}}" data-id="{{ ap.id }}" class="form-control comment" value="{{ap.comment}}" placeholder="Enter Item Note"></td>
                        <td>
                        {% if ap.vendor_quoted_cost %}
                            <span class="cost-total">{{ ap.vendor_quoted_cost|multiply:ap.quantity }}</span>
                        {% else %}
                            <span class="cost-total">{{ ap.standard_cost|multiply:ap.quantity }}</span>
                        {% endif %}
                        </td>
                        <td class="mapping-prod-sell">{{ ap.sell }}</td>
                        <td class="mapping-prod-sell">{{ ap.sell }}</td>
                        <td class="mapping-prod-gross-profit">{{ ap.gross_profit }}</td>
                        <td class="mapping-prod-gross-percentage">{{ ap.gross_profit_percentage }}</td>

                        <td class="d-flex">
                            <button type="button" class="btn btn-danger assign-prod-delete-btn remove-labor-row-btn mr-2" data-task-id="{{t_id}}" data-id="{{ap.id}}" data-title="{{ap.description}} - {{ t_info.task.task.name }}" data-url="{% url   'proposal_app:opportunity:assign-prod-delete-ajax' %}">
                                <em class="fa fa-trash"></em>
                            </button>
                            <button type="button" data-id="{{t_id}}" class="btn btn-primary add-labor-row" style="display: none;"><i class="fa fa-plus"></i></button>
                        </td>
                    </tr>

                    {% endfor %}

                    <tr id="row-{{t_id}}" class="new_prod">

                        <td class="d-none"><input type="hidden" class="task_id" value="{{ t_id }}"></td>
                        <td class="sr-no" id="sr-labor-no">{{ t_info.assigned_products.count|add:1 }}</td>
                        <td>
                            <input type="text" class="form-control quantity" placeholder="Enter Quantity">
                        </td>
                        <td>
                        <select data-id="{{t_id}}" class="labour-task-name form-control">
                            <!-- Data will apper here -->
                        </select>
                        </td>
                        <td class="text-nowrap">
                        <select data-id="{{t_id}}" class="labour-description form-control">
                            <!-- Data will apper here -->
                        </select>
                        </td>
                        <td>
                            <input type="text" id="standardCost{{ t_id }}" data-task-id="{{t_id}}" class="form-control standard-cost" data-id="{{ t_id }}" placeholder="Enter Standard Cost" value="0">
                        </td>
                        <td>
                            <input id="productCost{{ t_id }}" data-id="{{ t_id }}" data-task-id="{{t_id}}" data-standard-cost="standardCost{{ t_id }}" type="text" class="form-control quoted-cost" placeholder="Enter Quoted Cost" onchange="checkCostEquality('standardCost{{ t_id }}', 'productCost{{ t_id }}')" onkeyup="checkCostEquality('standardCost{{ t_id }}', 'productCost{{ t_id }}')" value="0">
                        </td>
                        <td>
                        <input type="text" class="form-control comment"placeholder="Enter Item Note">
                        </td>
                        <td class="total" data-id="{{t_id}}"></td>
                        <td class="sell" data-id="{{t_id}}"></td>
                        <td class="sell-total" data-id="{{t_id}}"></td>
                        <td class="gross" data-id="{{t_id}}"></td>
                        <td class="gross-p" data-id="{{t_id}}"></td>

                        <td class="d-flex">
                            <button type="button" data-task-id="{{t_id}}" class="btn btn-danger mr-2 remove-labor-row-btn"><i class="fa fa-trash"></i></button>
                            <button type="button" data-id="{{t_id}}" class="btn btn-primary add-labor-row"><i class="fa fa-plus"></i></button>
                        </td>
                    </tr>

                </tbody>

            </table>
        </div>

    </td>

</tr>
{% endfor %}
<!-- Labor End -->

<!--Labor Total -->
{% if task_mapping_labor_list %}
<tr>
    <th></th>
    <th>Total</th>
    <th class="mapping-grand-total-labor">${{labor_task_total.grand_total_price}}</th>
    <th></th>
    <th class="mapping-grand-total-labor-quantity">{{labor_task_total.grand_total_quantity}}</th>
    <th></th>
    <th></th>
    <th></th>
</tr>
{% endif %}