{% load static %}
<style>
  .select2-container--default .select2-selection--single {
      height: 38px;
  }
  .select2-labor-task {
    width: 50% !important;
  }
  .select2-task {
    width: 50% !important;
  }
</style>

<div class="form-group">

  <!-- Add manully task button -->
  <div class="text-right my-2">
    <button type="button" class="btn bg-light-primary htmx-trigger-btn-add-task"
            data-url="{% url 'proposal_app:opportunity:add-task' opportunity.document_number %}"
            hx-get="{% url 'proposal_app:opportunity:add-task' opportunity.document_number %}"
            hx-target="#model-add-task" hx-trigger="click" data-toggle="modal" data-target="#add-task">
            <em class="ft-plus font-medium-5"></em> Add Task
    </button>
  </div>

  <div class="">
    <table class="table table-striped table-bordered">
      <thead>
        <tr>
          <th style="max-width: 30% !important;">Task No</th>
          <th>Description</th>
          <th style="max-width:100px">Total</th>
          <th style="max-width:100px">Percent of Total</th>
          <th style="max-width:100px">Quantity </th>
          <th style="max-width:100px">Units </th>
          <th style="max-width:100px">Unit Price </th>
          <th style="max-width:50px"></th>
        </tr>
      </thead>
      <tbody>

        <!-- Task Start-->
        {% for t_id, t_info in task_mapping_list.items %}
            {% if  t_info.task.code %}
                <tr class="task-tr">
                  <td>
                      <select data-id="{{t_id}}" class="select2-task form-control">
                          <option selected disabled>{{ t_info.task.code }}</option>
                      </select>
                  </td>
                  <td>
                      <input type="text" class="form-control" value="{{ t_info.task.description }}" disabled />
                  </td>
                  <td class="mapping-total-price-{{t_id}} t-price">${{ t_info.total_price }}</td>
                  <td class="mapping-total-percent-{{t_id}} t-percent">{{ t_info.total_percent }}%</td>
                  <td class="mapping-total-qauntiy-{{t_id}} t-quantity">{{ t_info.total_quantity }}</td>
                  <td>EA</td>
                  <td class="mapping-total-price-{{t_id}}">${{ t_info.total_price }}</td>
                  <td>
                      <a data-toggle="collapse" href="#collapse{{ t_id }}" aria-expanded="true" aria-controls="collapse{{ t_id }}" class="card-title">
                          <em class="ft-chevron-down font-medium-5"></em>
                      </a>
                  </td>
                </tr>
            {% else %}
                <tr class="task-tr">
                  <td>
                      <select data-id="{{t_id}}" class="select2-task form-control">
                          <option selected disabled>{{ t_info.task.task.name }}</option>
                      </select>
                  </td>
                  <td>
                      <input type="text" class="form-control" value="{{ t_info.task.task.description }}" disabled />
                  </td>
                  <td class="mapping-total-price-{{t_id}} t-price">${{ t_info.total_price }}</td>
                  <td class="mapping-total-percent-{{t_id}} t-percent">{{ t_info.total_percent }}%</td>
                  <td class="mapping-total-qauntiy-{{t_id}} t-quantity">{{ t_info.total_quantity }}</td>
                  <td>EA</td>
                  <td class="mapping-total-price-{{t_id}}">${{ t_info.total_price }}</td>
                  <td>
                      <a data-toggle="collapse" href="#collapse{{ t_id }}" aria-expanded="true" aria-controls="collapse{{ t_id }}" class="card-title">
                          <em class="ft-chevron-down font-medium-5"></em>
                      </a>
                  </td>
                </tr>
            {% endif %}

            <tr id="collapse{{ t_id }}" role="tabpanel" aria-labelledby="headingCollapse{{ t_id }}" class="collapse">
                <td></td>
                <td colspan="100">
                    <div class="text-right my-2">

                        <button type="button" class="btn bg-light-primary" data-backdrop="false" data-toggle="modal" data-target="#addProduct{{t_id}}">
                            <em class="ft-plus font-medium-5"></em> Add Product
                        </button>

                        <!-- Add Product Modal -->
                        <div class="modal fade text-left" id="addProduct{{t_id}}" tabindex="-1" role="dialog" aria-labelledby="myModalLabel5" aria-hidden="true">
                          <div class="modal-dialog modal-md modal-dialog-centered" role="document">
                            <div class="modal-content">
                              <div class="modal-header">
                                <h4 class="modal-title" id="myModalLabel5">Add Product</h4>
                                <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                                  <span aria-hidden="true"><i class="ft-x font-medium-2 text-bold-700"></i></span>
                                </button>
                              </div>
                              <div class="modal-body">
                                <section id="multiple-select2">
                                  <div class="card">
                                    <div class="card-content">
                                      <div class="card-body">
                                        <div class="form-group">
                                            <label>Enter the number of fields</label>
                                            <input id="totalRows{{t_id}}" type="text" class="form-control mb-1" placeholder="Enter the number of fields">
                                          </div>
                                      </div>
                                    </div>
                                  </div>
                                </section>
                              </div>
                              <div class="modal-footer">
                                <button type="button" class="btn bg-light-secondary" data-dismiss="modal">Close</button>
                                <button type="button" data-id="{{t_id}}" class="btn btn-primary add-multi-row-btn" data-dismiss="modal"><em class="ft-plus font-medium-5"></em> Add Product</button>
                              </div>
                            </div>
                          </div>
                        </div>

                        <button type="button" class="btn bg-light-primary htmx-trigger-btn-assign-prod"
                                data-url="{% url 'proposal_app:opportunity:assign-prod-labor' t_info.task.opportunity.document_number t_id %}"
                                hx-get="{% url 'proposal_app:opportunity:assign-prod-labor' t_info.task.opportunity.document_number t_id %}"
                                hx-target="#model-assign" hx-trigger="click" data-toggle="modal" data-target="#assign-prod">
                            <i class="fa ft-briefcase mr-1"></i>Assign Products
                        </button>
                    </div>
                    <div class="table-responsive">
                        <table id="tableBody-{{ t_id }}" class="table table-striped table-bordered">
                            <thead>
                                <tr class="text-center">
                                    <th colspan="1"></th>
                                    <th colspan="7" class="align-top">Project Product Information</th>
                                    <th colspan="1" class="align-top">Cost</th>
                                    <th colspan="2" class="align-top">Sell</th>
                                    <th colspan="2" class="align-top">Gross Profit</th>
                                    <th colspan="1" class="align-top"></th>
                                </tr>
                                <tr>
                                    <th>Sr No</th>
                                    <th class="text-nowrap">Quantity</th>
                                    <th class="text-nowrap">Item Code</th>
                                    <th>Description</th>
                                    <th>Standard Cost</th>
                                    <th>Vendor Quoted cost</th>
                                    <th>Vendor</th>
                                    <th>Comment</th>
                                    <th>Total</th>
                                    <th>Sell</th>
                                    <th>Total</th>
                                    <th>$</th>
                                    <th>%</th>
                                    <td></td>
                                </tr>
                            </thead>
                            <tbody>
                                {% for ap in t_info.assigned_products %}
                                <tr class="tr-{{t_id}}">
                                    <td>{{ forloop.counter }}</td>
                                    <td>
                                      {% if ap.quantity == None %}
                                        <input type="text" data-id="{{ap.id}}" class="form-control quantity" value="" data-task-id="{{t_id}}" placeholder="Enter Quantity"></td>
                                      {% else %}
                                        <input type="text" data-id="{{ap.id}}" class="form-control quantity" data-task-id="{{t_id}}" value="{{ap.quantity}}" placeholder="Enter Quantity"></td>
                                      {% endif %}

                                    <td class="text-nowrap">{{ ap.item_code }}</td>
                                    {% if ap.description %}
                                      <td>{{ ap.description }}</td>
                                    {% else %}
                                      <td> - </td>
                                    {% endif %}
                                    {% comment %} <td id="standardCost{{ ap.id }}" class="text-nowrap">{{ ap.standard_cost }}</td> {% endcomment %}
                                    <td>
                                      {% if ap.standard_cost == None %}
                                        <input type="text" id="standardCost{{ ap.id }}" class="text-nowrap form-control standard-cost" data-id="{{ap.id}}" data-task-id="{{t_id}}" value="">
                                      {% else %}
                                        <input type="text" id="standardCost{{ ap.id }}" class="text-nowrap form-control standard-cost" data-id="{{ap.id}}" data-task-id="{{t_id}}" value="{{ ap.standard_cost }}">
                                      {% endif %}
                                    </td>
                                    {% if ap.vendor_quoted_cost == None %}
                                      <td>
                                        <input id="productCost{{ ap.id }}"
                                              data-id="{{ ap.id }}"
                                              data-task-id="{{t_id}}"
                                              data-standard-cost="standardCost{{ ap.id }}"
                                              type="text"
                                              class="form-control vendor-quoted-cost"
                                              value=""
                                              onchange="checkCostEquality('standardCost{{ ap.id }}', 'productCost{{ ap.id }}')"
                                              onkeyup="checkCostEquality('standardCost{{ ap.id }}', 'productCost{{ ap.id }}')">
                                      </td>
                                    {% else %}
                                      <td>
                                        <input id="productCost{{ ap.id }}"
                                              data-id="{{ ap.id }}"
                                              data-task-id="{{t_id}}"
                                              data-standard-cost="standardCost{{ ap.id }}"
                                              type="text"
                                              class="form-control vendor-quoted-cost"
                                              value="{{ap.vendor_quoted_cost}}"
                                              onchange="checkCostEquality('standardCost{{ ap.id }}', 'productCost{{ ap.id }}')"
                                              onkeyup="checkCostEquality('standardCost{{ ap.id }}', 'productCost{{ ap.id }}')">
                                      </td>
                                    {% endif %}

                                    <td>
                                        <select data-id="{{ap.id}}" class="select2-vendor form-control">
                                          {% if ap.vendor == None %}
                                            <option selected disabled>Select Vendor Name</option>
                                          {% else %}
                                            <option selected disabled>{{ap.vendor}}</option>
                                          {% endif %}
                                        </select>
                                    </td>
                                    <td>
                                      {% if ap.comment == None %}
                                        <input type="text" id="comment-{{ap.id}}" data-id="{{ ap.id }}" class="form-control comment" placeholder="Enter comment" value=""></td>
                                      {% else %}
                                        <input type="text" id="comment-{{ap.id}}" data-id="{{ ap.id }}" class="form-control comment" placeholder="Enter comment" value="{{ ap.comment }}"></td>
                                      {% endif %}

                                    <td>
                                      {% if ap.vendor_quoted_cost %}
                                        <span class="cost-total">{{ ap.vendor_quoted_cost }}</span>
                                      {% else %}
                                        <span class="cost-total">{{ ap.standard_cost }}</span>
                                      {% endif %}
                                    </td>
                                    <td class="mapping-prod-sell">{{ ap.sell }}</td>
                                    <td class="mapping-prod-sell">{{ ap.sell }}</td>
                                    <td class="mapping-prod-gross-profit">{{ ap.gross_profit }}</td>
                                    <td class="mapping-prod-gross-percentage">{{ ap.gross_profit_percentage }}</td>
                                    <td>
                                      {% if t_info.task.code %}
                                        <button type="button" class="btn btn-danger assign-prod-delete-btn" data-id="{{ap.id}}" data-title="{{ap.description}} - {{ t_info.task.code }}" data-url="{% url   'proposal_app:opportunity:assign-prod-delete-ajax' %}"><em class="fa fa-trash"></em></button>
                                      {% else %}
                                        <button type="button" class="btn btn-danger assign-prod-delete-btn" data-id="{{ap.id}}" data-title="{{ap.description}} - {{ t_info.task.task.name }}" data-url="{% url   'proposal_app:opportunity:assign-prod-delete-ajax' %}"><em class="fa fa-trash"></em></button>
                                      {% endif %}

                                    </td>
                                </tr>
                                {% empty %}
                                <tr>
                                    <td colspan="13" class="text-center">No products assigned</td>
                                </tr>
                                {% endfor %}
                                <!-- Genarate dynamic rows -->
                                <tr id="row-template-{{ t_id }}" class="new_prod">
                                    <td><input type="hidden" class="task_id" value="{{ t_id }}"></td>
                                    <td class="text-nowrap"><input type="text" class="form-control quantity" data-id="quantity-{{t_id}}" placeholder="Enter Quantity"></td>
                                    <td class="text-nowrap">
                                        <select data-id="{{ t_id }}" class="select2-item-code js-example-programmatic form-control">
                                            <!-- Data will apper here -->
                                        </select>
                                    </td>
                                    <td>
                                        <select data-id="{{ t_id }}" class="select2-item-description js-example-programmatic form-control" >
                                            <!-- Data will apper here -->
                                        </select>
                                    </td>
                                    <td><input type="text" class="form-control standard-cost" data-id="{{ t_id }}" id="std_cost" placeholder="Enter Standard Cost"></td>
                                    <td><input type="text" class="form-control quoted-cost" placeholder="Enter Quoted Cost"></td>
                                    <td>
                                        <select data-id="{{ t_id }}" class="select2-vendor vendor form-control">
                                          <option selected disabled>Select Vendor Name</option>
                                        </select>
                                    </td>
                                    <td><input type="text" class="form-control comment" placeholder="Enter comment"></td>
                                    <td class="total" data-id="{{t_id}}"></td>
                                    <td class="sell" data-id="{{t_id}}"></td>
                                    <td class="sell-total" data-id="{{t_id}}"></td>
                                    <td class="gross" data-id="{{t_id}}"></td>
                                    <td class="gross-p" data-id="{{t_id}}"></td>
                                    <td class="d-flex">
                                        <button type="button" class="btn btn-danger mr-2 remove-row-btn"><i class="fa fa-trash"></i></button>
                                        <button type="button" data-id="{{t_id}}" class="btn btn-primary add-row-btn"><i class="fa fa-plus"></i></button>
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </td>
            </tr>
        {% endfor %}
        <!-- Task End-->

        <!--Task Total -->
        {% if task_mapping_list %}
            <tr>
                <th></th>
                <th>Total</th>
                <th class="mapping-grand-total">${{grand_total.grand_total_price}}</th>
                <th></th>
                <th class="mapping-grand-total-quantity">{{grand_total.grand_total_quantity}}</th>
                <th></th>
                <th></th>
                <th></th>
            </tr>
        {% endif %}
        <!--Task Total -->


        <!-- Labor start -->
        {% for t_id, t_info in task_mapping_labor_list.items %}
          <tr class="labor-task-tr">
            <td >
              <select data-id="{{t_id}}" class="select2-labor-task form-control">
                <option selected disabled>{{t_info.task.code}}</option>
              </select>
            </td>
            <td><input type="text" class="form-control" id="" value="{{t_info.task.description}}" disabled/></td>
            <td class="mapping-total-price-{{t_id}} t-price">${{ t_info.total_price }}</td>
            <td class="mapping-total-percent-{{t_id}} t-percent">{{ t_info.total_percent }}%</td>
            <td class="mapping-total-qauntiy-{{t_id}} t-quantity">{{ t_info.total_quantity }}</td>
            <td>EA</td>
            <td class="mapping-total-price-{{t_id}}">${{ t_info.total_price }}</td>
            <td>
              <a data-toggle="collapse" href="#collapse{{t_id}}" aria-expanded="true" aria-controls="collapse{{t_id}}" class="card-title">
                <em class="ft-chevron-down font-medium-5"></em>
              </a>
            </td>
          </tr>
          <tr id="collapse{{t_id}}" role="tabpanel" aria-labelledby="headingCollapse{{t_id}}" class="collapse">
            <td>
            </td>

            <td colspan="100">

              <div class="float-left my-2">
                <label>Assign labor to task:</label>
                {% if t_info.task.assign_to %}
                  <select class="select-labor-task" name="" data-url="{% url "proposal_app:opportunity:assign-task-labor" opportunity.document_number %}" data-id={{t_id}} data-document={{ opportunity.document_number }}>
                    <option value="{{t_info.task.assign_to}}">{{t_info.task.assign_to}}</option>
                  </select>
                {% else %}
                  <select class="select-labor-task" name="" data-url="{% url "proposal_app:opportunity:assign-task-labor" opportunity.document_number %}" data-id={{t_id}} data-document={{ opportunity.document_number }}>
                    <option selected disabled>Select task</option>
                  </select>
                {% endif %}

              </div>

              <div class="float-right my-2">
                <button  type="button" class="btn bg-light-primary" data-backdrop="false"
                  data-toggle="modal" data-target="#addlabor{{t_id}}">
                    <em class="ft-plus font-medium-5"></em> Add labor
                </button>

                <!-- Add Labor Modal -->
                <div class="modal fade text-left" id="addlabor{{t_id}}" tabindex="-1" role="dialog" aria-labelledby="myModalLabel5" aria-hidden="true">
                  <div class="modal-dialog modal-md modal-dialog-centered" role="document">
                    <div class="modal-content">
                      <div class="modal-header">
                        <h4 class="modal-title" id="myModalLabel5">Add labor</h4>
                        <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                          <span aria-hidden="true"><i class="ft-x font-medium-2 text-bold-700"></i></span>
                        </button>
                      </div>
                      <div class="modal-body">
                        <section id="multiple-select2">
                          <div class="card">
                            <div class="card-content">
                              <div class="card-body">
                                <div class="form-group">
                                    <label>Enter the number of fields</label>
                                    <input id="totalRows{{t_id}}" type="text" class="form-control mb-1" placeholder="Enter the number of fields">
                                  </div>
                              </div>
                            </div>
                          </div>
                        </section>
                      </div>
                      <div class="modal-footer">
                        <button type="button" class="btn bg-light-secondary" data-dismiss="modal">Close</button>
                        <button type="button" data-id="{{t_id}}" class="btn btn-primary add-multi-labor-row-btn" data-dismiss="modal"><em class="ft-plus font-medium-5"></em> Add Labor</button>
                      </div>
                    </div>
                  </div>
                </div>

              </div>

              <div class="table-responsive">
                <table
                  class="table table-striped table-bordered"
                  >
                  <thead>
                    <tr class="text-center">
                      <th colspan="1"></th>
                      <th colspan="6" class="align-top">Project Labor Information</th>
                      <th colspan="1" class="align-top">Cost</th>
                      <th colspan="2" class="align-top">Sell</th>
                      <th colspan="2" class="align-top">Gross Profit</th>
                      <th colspan="2" class="align-top"></th>
                    </tr>
                    <tr>
                      <th>Sr No</th>

                      <th class="text-nowrap">Labor task</th>
                      <th >Description</th>
                      <th class="text-nowrap">Quantity</th>
                      <th>Standard Cost</th>
                      <th>Vendor Quoted cost</th>
                      <th>Comment</th>

                      <th>Total</th>

                      <th>Sell</th>
                      <th>Total</th>

                      <th>$</th>
                      <th>%</th>


                      <td></td>

                    </tr>
                  </thead>

                  <tbody id="labor-{{t_id}}">

                    {% for ap in t_info.assigned_products %}
                      <tr class="tr-{{t_id}}">
                        <td>{{foorloop.counter}}</td>

                        <td class="text-nowrap">{{ap.labor_task}}</td>
                        <td>{{ap.description}}</td>
                        <td class="text-nowrap">
                          <input type="text" class="form-control quantity" data-id="{{ap.id}}" data-task-id="{{t_id}}" value="{{ap.quantity}}"/>
                        </td>
                        <td class="text-nowrap">
                          {% if ap.standard_cost %}
                            <input type="text" data-id="{{ap.id}}" class="form-control standard-cost" data-task-id="{{t_id}}" value="{{ap.standard_cost}}">
                          {% else %}
                            <input type="text" data-id="{{ap.id}}" class="form-control standard-cost" data-task-id="{{t_id}}" value="{{ap.standard_cost}}">
                          {% endif %}
                        </td>
                        <td class="text-nowrap">
                          {% if ap.vendor_quoted_cost %}
                            <input type="text" data-id="{{ ap.id }}" class="form-control vendor-quoted-cost" data-task-id="{{t_id}}" value="{{ap.vendor_quoted_cost}}">
                          {% else %}
                            <input type="text" data-id="{{ ap.id }}" class="form-control vendor-quoted-cost" data-task-id="{{t_id}}" value="{{ap.vendor_quoted_cost}}">
                          {% endif %}
                        </td>
                        <td><input  type="text" id="comment-{{ap.id}}" data-id="{{ ap.id }}" class="form-control comment" value="{{ap.comment}}" placeholder="Enter comment"></td>
                        <td>
                          {% if ap.vendor_quoted_cost %}
                            <span class="cost-total">{{ ap.vendor_quoted_cost }}</span>
                          {% else %}
                            <span class="cost-total">{{ ap.standard_cost }}</span>
                          {% endif %}
                        </td>
                        <td class="mapping-prod-sell">{{ ap.sell }}</td>
                        <td class="mapping-prod-sell">{{ ap.sell }}</td>
                        <td class="mapping-prod-gross-profit">{{ ap.gross_profit }}</td>
                        <td class="mapping-prod-gross-percentage">{{ ap.gross_profit_percentage }}</td>

                        <td><button type="button" class="btn btn-danger assign-prod-delete-btn" data-id="{{ap.id}}" data-title="{{ap.description}} - {{ t_info.task.task.name }}" data-url="{% url   'proposal_app:opportunity:assign-prod-delete-ajax' %}"><em class="fa fa-trash"></em></button></td>
                      </tr>
                    {% endfor %}

                      <tr id="row-{{t_id}}" class="new_prod">

                        <td> <input type="hidden" class="task_id" value="{{t_id}}"> </td>
                        <td>
                          <select data-id="{{t_id}}" class="labour-task-name form-control">
                              <!-- Data will apper here -->
                          </select>
                        </td>
                        <td class="text-nowrap">
                          <select data-id="{{t_id}}" class="labour-description form-control">
                            <!-- Data will apper here -->
                          </select>
                        </td>
                        <td>
                          <input type="text" class="form-control quantity" placeholder="Enter Quantity">
                        </td>
                        <td class="text-nowrap">
                          <input type="text" class="form-control standard-cost" data-id="{{t_id}}" value="" placeholder="Enter standard cost">
                        </td>
                        <td class="text-nowrap">
                          <input type="text" class="quoted-cost form-control" data-id="{{t_id}}" value="" placeholder="Enter vendor quoted cost">
                        </td>
                        <td>
                          <input type="text" class="form-control comment"placeholder="Enter comment">
                        </td>
                        <td class="total" data-id="{{t_id}}"></td>
                        <td class="sell" data-id="{{t_id}}"></td>
                        <td class="sell-total" data-id="{{t_id}}"></td>
                        <td class="gross" data-id="{{t_id}}"></td>
                        <td class="gross-p" data-id="{{t_id}}"></td>

                        <td class="d-flex">
                          <button class="btn btn-danger mr-2"><i class="fa fa-trash"></i></button>
                          <button type="button" data-id="{{t_id}}" class="btn btn-primary add-labor-row"><i class="fa fa-plus"></i></button>
                        </td>
                      </tr>

                  </tbody>

                </table>
              </div>

            </td>
          </tr>
        {% endfor %}
        <!-- Labor End -->

        <!--Labor Total -->
        {% if task_mapping_labor_list %}
          <tr>
            <th></th>
            <th>Total</th>
            <th class="mapping-grand-total-labor">${{labor_task_total.grand_total_price}}</th>
            <th></th>
            <th class="mapping-grand-total-labor-quantity">{{labor_task_total.grand_total_quantity}}</th>
            <th></th>
            <th></th>
            <th></th>
          </tr>
        {% endif %}
        <!--Labor Total -->

      </tbody>
    </table>
  </div>

</div>


<!-- Add Task Model -->
<div class="modal fade text-left" id="add-task" tabindex="-1" role="dialog" aria-labelledby="myModalLabel5" aria-hidden="true" data-backdrop="false">
  <div class="modal-dialog modal-dialog-centered" role="document">
    <div class="modal-content">
      <div id="model-add-task">
        <!-- Form content will be dynamically inserted here by HTMX -->
      </div>
    </div>
  </div>
</div>

<!-- Assign Product Modal -->
<div class="modal fade text-left" id="assign-prod" tabindex="-1" role="dialog" aria-labelledby="myModalLabel5" aria-hidden="true" data-backdrop="false">
  <div class="modal-dialog modal-lg modal-dialog-centered" role="document">
    <div class="modal-content">
      <div id="model-assign">
        <!-- Form content will be dynamically inserted here by HTMX -->
      </div>
    </div>
  </div>
</div>


{% block script %}

  <!-- Add dynamic task rows -->
  <script>

    var task_id = null;

    $(document).ready(function() {

        function generateUniqueId() {
            return "id" + Math.random().toString(16).slice(2);
        }

        // Handle 'Add Row' button click
        $('.add-row-btn, .add-multi-row-btn').on('click', function(e) {
          console.log("Clicked.........")
          var unique_id;
          var html;
          var $input = $(e.target);
          var multi_row;
          task_id = $(this).data('id');

          var numRows = 1;
          if ($input.hasClass("add-multi-row-btn")) {
              var total_rows = $(`#totalRows${task_id}`).val();
              numRows = parseInt(total_rows, 10) || 1;
              console.log("numRows", numRows)
              multi_row = true;
          }

          console.log("multi", multi_row)

          // Function to generate a new row with a unique ID
          function generateRow(unique_id) {
              return `
              <tr id="row-template-${unique_id}" class="new_prod">
                  <td> <input type="hidden" class="task_id" value="${task_id}"> </td>
                  <td class="text-nowrap"><input type="text" class="form-control quantity" data-id="quantity-${unique_id}" placeholder="Enter Quantity"></td>
                  <td class="text-nowrap">
                      <select data-id="${unique_id}" class="select2-item-code js-example-programmatic form-control">
                      </select>
                  </td>
                  <td>
                      <select data-id="${unique_id}" class="select2-item-description js-example-programmatic form-control">
                      </select>
                  </td>
                  <td><input data-id="${unique_id}" type="text" class="form-control standard-cost" placeholder="Enter Standard Cost"></td>
                  <td><input data-id="${unique_id}" type="text" class="form-control quoted-cost" placeholder="Enter Quoted Cost"></td>
                  <td>
                      <select data-id="${unique_id}" class="select2-vendor vendor form-control">
                        <option selected disabled>Select Vendor Name</option>
                      </select>
                  </td>
                  <td><input type="text" class="form-control comment" placeholder="Enter comment"></td>
                  <td data-id="${unique_id}" class="total"></td>
                  <td data-id="${unique_id}" class="sell"></td>
                  <td data-id="${unique_id}" class="sell-total"></td>
                  <td data-id="${unique_id}" class="gross"></td>
                  <td data-id="${unique_id}" class="gross-p"></td>
                  <td class="d-flex">
                      <button type="button" class="btn btn-danger mr-2 remove-row-btn"><i class="fa fa-trash"></i></button>
                  </td>
              </tr>
              `;
          }

          for (var i = 0; i < numRows; i++) {
              unique_id = generateUniqueId();
              html = generateRow(unique_id);

              task_id = $(this).data('id');

              if (multi_row) {
                var currentRow = $(this).closest('tr').find(`#row-template-${task_id}`);
              } else {
                var currentRow = $(this).closest('tr');
              }

              // Find the ID of the table body to append the row
              var data_id = $(this).data('id');
              var tableBody = $(`#tableBody-${data_id}`);

              // Insert the new row before the current row
              tableBody.append(html);
              $(`#row-template-${unique_id}`).insertBefore(currentRow);

              // Initialize select2 for the new selects
              $('.select2-vendor').select2({
                placeholder: 'Select Vendor Name',
                tags: true, // Enable the tagging feature
                ajax: {
                    url: '{% url "proposal_app:opportunity:vendor-search" %}',
                    dataType: 'json',
                    delay: 250,  // Add a delay for better UX
                    data: function (params) {
                        return {
                            q: params.term
                        };
                    },
                    processResults: function (data) {
                        return {
                            results: data.results
                        };
                    },
                    cache: true
                }
              });

              // Item code start
              $('.select2-item-code').select2({
                placeholder: 'Select Item Code',
                tags: true, // Enable the tagging feature
                ajax: {
                    url: '{% url "proposal_app:opportunity:item-code-search" %}',
                    dataType: 'json',
                    delay: 250,
                    data: function (params) {
                        return {
                            q: params.term
                        };
                    },
                    processResults: function (data) {
                        return {
                            results: data.results
                        };
                    },
                    cache: true
                }
              });

              // Set Select 2 for new generated rows
              $(`.select2-item-description`).select2({
                placeholder: 'Select Item description',
                tags: true, // Enable the tagging feature
                ajax: {
                    url: '{% url "proposal_app:opportunity:item-description-search" %}',
                    dataType: 'json',
                    delay: 250,
                    data: function (params) {
                        return {
                            q: params.term
                        };
                    },
                    processResults: function (data) {
                        return {
                            results: data.results
                        };
                    },
                    cache: true
                }
              });

          }

        });

        var item_code_changed = false;
        var item_description_changed = false;

        // NOTE: Try to fix multiple ajax request
        // Auto populated description while select item code
        function updateDescription(value, id) {
            var $select2Element = $(`select[data-id="${id}"].select2-item-description.js-example-programmatic.form-control`);

            // Initialize Select2 if not already initialized
            if (!$select2Element.hasClass('select2-hidden')) {
                $select2Element.select2({
                    ajax: {
                      url: '{% url "proposal_app:opportunity:item-description-search" %}',
                      dataType: 'json',
                      delay: 250,
                      data: function(params) {
                          return {
                              q: value
                          };
                      },
                      processResults: function(data) {
                          // Clear existing options
                          $select2Element.empty();

                          // Populate new options
                          $.each(data.results, function(index, item) {
                              var newOption = new Option(item.text, item.id, false, false);
                              $select2Element.append(newOption);
                          });

                          // Check if there are results and set the first as selected
                          if (data.results.length > 0) {
                              $select2Element.val(data.results[0].id).trigger('change');
                          }

                          return {
                              results: data.results
                          };
                      },
                      cache: true
                    }
                });
              }

          // Manually trigger AJAX request without opening dropdown
          $select2Element.select2('data', null); // Clear previous data
          $select2Element.select2('open'); // Trigger AJAX without user action
          $select2Element.select2('close'); // Close dropdown immediately after fetching
        }

        // Set value of selectd item code with on change event
        $(document).on('select2:select', '.select2-item-code', function(e) {

          if (item_description_changed) return; // Prevent triggering if item description is changing

          item_code_changed = true;

          var $row = $(this).closest('tr');

          // item code
          var $input = $(e.target);
          var id = $input.data("id");

          var value = $input.val();

          // Payload data
          data = {
            value: value,
          }

          $.ajax({
            url: '{% url "proposal_app:opportunity:item-code-search" %}',
            type: 'POST',
            data: data,
            headers: {
              'X-CSRFToken': "{{ csrf_token }}",
            },
            success: function(response) {
              if (response.code == 200) {

                updateDescription(response.description, id);

                var $stdCostField = $(`input[data-id="${id}"].standard-cost`);
                var total = $(`td[data-id="${id}"].total`);
                var sell = $(`td[data-id="${id}"].sell`);
                var total_sell = $(`td[data-id="${id}"].sell-total`);
                var gross_profit = $(`td[data-id="${id}"].gross`);
                var gross_percent = $(`td[data-id="${id}"].gross-p`);

                $stdCostField.val(response.std_cost);
                total.text($stdCostField.val());
                sell.text((parseFloat($stdCostField.val()) + 0.25).toFixed(2));
                total_sell.text((parseFloat($stdCostField.val()) + 0.25).toFixed(2));
                gross_profit.text((parseFloat(sell.text()) - parseFloat($stdCostField.val())).toFixed(2));
                gross_percent.text(((parseFloat(gross_profit.text()) / parseFloat(sell.text())) * 100).toFixed(2));

                $(".quoted-cost").on("input", function(e) {

                  var row = $(this).closest("tr");
                  var value = $(this).val();

                  total = row.find(".total")
                  sell = row.find(".sell")
                  total_sell = row.find(".sell-total")
                  gross_profit = row.find(".gross")
                  gross_percent = row.find(".gross-p")

                  total.text(value);
                  sell.text((parseFloat(value) + 0.25).toFixed(2));
                  total_sell.text((parseFloat(value) + 0.25).toFixed(2));
                  gross_profit.text((parseFloat(sell.text()) - parseFloat(value)).toFixed(2));
                  gross_percent.text(((parseFloat(gross_profit.text()) / parseFloat(sell.text())) * 100).toFixed(2));

                });
              }
            },
            error: function(xhr, status, error) {
              console.log("Error:", error);
              $(".quoted-cost").on("input", function(e) {

                var row = $(this).closest("tr");
                var value = $(this).val();

                total = row.find(".total")
                sell = row.find(".sell")
                total_sell = row.find(".sell-total")
                gross_profit = row.find(".gross")
                gross_percent = row.find(".gross-p")

                total.text(value);
                sell.text((parseFloat(value) + 0.25).toFixed(2));
                total_sell.text((parseFloat(value) + 0.25).toFixed(2));
                gross_profit.text((parseFloat(sell.text()) - parseFloat(value)).toFixed(2));
                gross_percent.text(((parseFloat(gross_profit.text()) / parseFloat(sell.text())) * 100).toFixed(2));

              });
            },
            complete: function() {
              item_code_changed = false; // Reset flag after completion
            }
          });
        });

        // TODO: Test Funcation
        // Auto populated item code while select item description
        function updateItemCode(value, id) {

          var $select2Element = $(`select[data-id="${id}"].select2-item-code.js-example-programmatic.form-control`);

          // Initialize Select2 if not already initialized
          if (!$select2Element.hasClass('select2-hidden')) {
              $select2Element.select2({
                ajax: {
                    url: '{% url "proposal_app:opportunity:item-code-search" %}',
                    dataType: 'json',
                    delay: 250,
                    data: function(params) {
                        return {
                            q: value
                        };
                    },
                    processResults: function(data) {
                        // Clear existing options
                        $select2Element.empty();

                        // Populate new options
                        $.each(data.results, function(index, item) {
                            var newOption = new Option(item.text, item.id, false, false);
                            $select2Element.append(newOption);
                        });

                        // Check if there are results and set the first as selected
                        if (data.results.length > 0) {
                            $select2Element.val(data.results[0].id).trigger('change');
                        }

                        return {
                            results: data.results
                        };
                    },
                    cache: true
                  }
              });
          }

          // Manually trigger AJAX request without opening dropdown
          $select2Element.select2('data', null); // Clear previous data
          $select2Element.select2('open'); // Trigger AJAX without user action
          $select2Element.select2('close'); // Close dropdown immediately after fetching
        }

        // TODO: Test Funcation
        // Set value of selectd item with with on change event
        $(document).on('select2:select', '.select2-item-description', function(e) {

          if (item_code_changed) return; // Prevent triggering if item code is changing

          item_description_changed = true;

          var $row = $(this).closest('tr');
          var $input = $(e.target);

          var id = $input.data("id");
          var value = $input.val();

          // Payload data
          data = {
            value: value,
          }

          $.ajax({
            url: '{% url "proposal_app:opportunity:item-description-search" %}',
            type: 'POST',
            data: data,
            headers: {
              'X-CSRFToken': "{{ csrf_token }}",
            },
            success: function(response) {
              if (response.code == 200) {

                updateItemCode(response.item_code, id);

                var $stdCostField = $(`input[data-id="${id}"].standard-cost`);
                var total = $(`td[data-id="${id}"].total`);
                var sell = $(`td[data-id="${id}"].sell`);
                var total_sell = $(`td[data-id="${id}"].sell-total`);
                var gross_profit = $(`td[data-id="${id}"].gross`);
                var gross_percent = $(`td[data-id="${id}"].gross-p`);

                $stdCostField.val(response.std_cost);
                total.text($stdCostField.val());
                sell.text((parseFloat($stdCostField.val()) + 0.25).toFixed(2));
                total_sell.text((parseFloat($stdCostField.val()) + 0.25).toFixed(2));
                gross_profit.text((parseFloat(sell.text()) - parseFloat($stdCostField.val())).toFixed(2));
                gross_percent.text(((parseFloat(gross_profit.text()) / parseFloat(sell.text())) * 100).toFixed(2));

                $(".quoted-cost").on("input", function(e) {

                  var row = $(this).closest("tr");
                  var value = $(this).val();

                  total = row.find(".total")
                  sell = row.find(".sell")
                  total_sell = row.find(".sell-total")
                  gross_profit = row.find(".gross")
                  gross_percent = row.find(".gross-p")

                  total.text(value);
                  sell.text((parseFloat(value) + 0.25).toFixed(2));
                  total_sell.text((parseFloat(value) + 0.25).toFixed(2));
                  gross_profit.text((parseFloat(sell.text()) - parseFloat(value)).toFixed(2));
                  gross_percent.text(((parseFloat(gross_profit.text()) / parseFloat(sell.text())) * 100).toFixed(2));

                });
              }
            },
            error: function(xhr, status, error) {
              console.log("Error:", error);
              $(".quoted-cost").on("input", function(e) {

                var row = $(this).closest("tr");
                var value = $(this).val();

                total = row.find(".total")
                sell = row.find(".sell")
                total_sell = row.find(".sell-total")
                gross_profit = row.find(".gross")
                gross_percent = row.find(".gross-p")

                total.text(value);
                sell.text((parseFloat(value) + 0.25).toFixed(2));
                total_sell.text((parseFloat(value) + 0.25).toFixed(2));
                gross_profit.text((parseFloat(sell.text()) - parseFloat(value)).toFixed(2));
                gross_percent.text(((parseFloat(gross_profit.text()) / parseFloat(sell.text())) * 100).toFixed(2));

              });
            },
            complete: function() {
              item_description_changed = false; // Reset flag after completion
            }
          });
        });


        $(document).on('click', '.remove-row-btn', function() {
            $(this).closest('tr').remove();
        });

        // Handle Save All data on next click
        $("a[href='#next']").on('click', function() {

          var foundElements = $(".steps li").find(".current");
          current_stage_value = $(".current a span.step").text();

          console.log("", current_stage_value)
          var rowsData = [];

          if (current_stage_value == "5"){

            $('tr.new_prod').each(function() {

                var $row = $(this);

                var rowData = {
                    task_id: $row.find('.task_id').val(),
                    quantity: $row.find('.quantity').val(),
                    item_code: $row.find('.select2-item-code').val(),
                    description: $row.find('.select2-item-description').val(),
                    vendor: $row.find('.select2-vendor').val(),
                    standardCost: $row.find('.standard-cost').val(),
                    quotedCost: $row.find('.quoted-cost').val(),
                    comment: $row.find('.comment').val(),
                    total: $row.find('.total').val(),
                    sell: $row.find('.sell').val(),
                    sellTotal: $row.find('.sell-total').val(),
                    gross: $row.find('.gross').val(),
                    grossP: $row.find('.gross-p').val(),
                    task_name: $row.find('.labour-task-name').val(),
                    labor_description: $row.find('.labour-description').val(),
                    local_cost: $row.find('.local_cost').val(),
                    out_of_town_cost: $row.find('.out_of_town_cost').val(),
                };

                rowsData.push(rowData);
            });

            console.log("rowData", rowsData);

            $.ajax({
                url: '{% url "proposal_app:opportunity:add-prod-row-ajax" %}',
                type: 'POST',
                data: {
                    rows: rowsData,
                },
                headers: {
                    'X-CSRFToken': "{{ csrf_token }}",
                },
                success: function(response) {
                    console.log('API call success:', response);
                    if (response.status == "success"){
                      window.location.reload();
                    }else if( response.status == "warning"){
                      window.location.reload();
                    }else if( response.status == "error"){
                      window.location.reload();
                    }
                },
                error: function(response) {
                    console.error('API call error:', status, error);
                    if( response.status == "error"){
                      window.location.reload();
                    }
                }
            });
          }
        });

    });
  </script>

  <!-- Add dynamic labor task row -->
  <script>

    var task_id = null;

    $(document).ready(function() {

        function generateUniqueId() {
            return "id" + Math.random().toString(16).slice(2);
        }

        // Handle 'Add Row' button click
        $('.add-labor-row, .add-multi-labor-row-btn').on('click', function(e) {
          console.log("Clicked.........")
          var unique_id;
          var html;
          var $input = $(e.target);
          var multi_row;
          task_id = $(this).data('id');

          var numRows = 1;
          if ($input.hasClass("add-multi-labor-row-btn")) {
              var total_rows = $(`#totalRows${task_id}`).val();
              numRows = parseInt(total_rows, 10) || 1;
              console.log("numRows", numRows)
              multi_row = true;
          }

          // console.log("multi", multi_row)

          // Function to generate a new row with a unique ID
          function generateRow(unique_id) {
              return `
                <tr id="row-${unique_id}" class="new_prod">

                  <td> <input type="hidden" class="task_id" value="${task_id}"> </td>
                  <td>
                    <select data-id="${unique_id}" class="labour-task-name form-control">
                    </select>
                  </td>
                  <td class="text-nowrap">
                    <select data-id="${unique_id}" class="labour-description form-control">
                    </select>
                  </td>
                  <td>
                    <input type="text" class="form-control quantity" placeholder="Enter Qunatity">
                  </td>
                  <td id="standardCost13" class="text-nowrap">
                    <input type="text" data-id="${unique_id}" class="form-control standard-cost" placeholder="Enter standard cost">
                  </td>
                  <td class="text-nowrap">
                    <input type="text" data-id="${unique_id}" class="quoted-cost form-control" placeholder="Enter out of town cost">
                  </td>
                  <td>
                    <input type="text" class="form-control comment"placeholder="Enter comment">
                  </td>
                  <td class="total" data-id="${unique_id}"></td>
                  <td class="sell" data-id="${unique_id}"></td>
                  <td class="sell-total" data-id="${unique_id}"></td>
                  <td class="gross" data-id="${unique_id}"></td>
                  <td class="gross-p" data-id="${unique_id}"></td>

                  <td class="d-flex">
                    <button type="button" class="btn btn-danger mr-2 remove-row-btn"><i class="fa fa-trash"></i></button>
                  </td>
                </tr>
              `;
          }

          for (var i = 0; i < numRows; i++) {
              unique_id = generateUniqueId();
              html = generateRow(unique_id);

              task_id = $(this).data('id');

              if (multi_row) {
                var currentRow = $(this).closest('tr').find(`#row-${task_id}`);
              } else {
                var currentRow = $(this).closest('tr');
              }

              // Find the ID of the table body to append the row
              var data_id = $(this).data('id');
              var tableBody = $(`#labor-${data_id}`);

              // Insert the new row before the current row
              tableBody.append(html);
              $(`#row-${unique_id}`).insertBefore(currentRow);

              $('.labour-task-name').select2({
                placeholder: 'Select task Name',
                tags: true, // Enable the tagging feature
                ajax: {
                    url: '{% url "proposal_app:opportunity:labor-task-name-search" %}',
                    dataType: 'json',
                    delay: 250,
                    data: function (params) {
                        return {
                            q: params.term
                        };
                    },
                    processResults: function (data) {
                        return {
                            results: data.results
                        };
                    },
                    cache: true
                  }
              });

              $('.labour-description').select2({
                placeholder: 'Select task description',
                tags: true, // Enable the tagging feature
                ajax: {
                    url: '{% url "proposal_app:opportunity:labor-task-description-search" %}',
                    dataType: 'json',
                    delay: 250,
                    data: function (params) {
                        return {
                            q: params.term
                        };
                    },
                    processResults: function (data) {
                        return {
                            results: data.results
                        };
                    },
                    cache: true
                  }
              });
          }

        });

        $(document).on('click', '.remove-row-btn', function() {
            $(this).closest('tr').remove();
        });

        function updateDescription(value, id) {
          var $select2Element = $(`select[data-id="${id}"].labour-description`);

          // Initialize Select2 if not already initialized
          if (!$select2Element.hasClass('select2-hidden')) {
              $select2Element.select2({
                  ajax: {
                      url: '{% url "proposal_app:opportunity:labor-task-description-search" %}',
                      dataType: 'json',
                      delay: 250,
                      data: function(params) {
                          return {
                              q: value
                          };
                      },
                      processResults: function(data) {
                          // Clear existing options
                          $select2Element.empty();

                          // Populate new options
                          $.each(data.results, function(index, item) {
                              var newOption = new Option(item.text, item.id, false, false);
                              $select2Element.append(newOption);
                          });

                          // Check if there are results and set the first as selected
                          if (data.results.length > 0) {
                              $select2Element.val(data.results[0].id).trigger('change');
                          }

                          return {
                              results: data.results
                          };
                      },
                      cache: true
                  }
              });
          }

          // Manually trigger AJAX request without opening dropdown
          $select2Element.select2('data', null); // Clear previous data
          $select2Element.select2('open'); // Trigger AJAX without user action
          $select2Element.select2('close'); // Close dropdown immediately after fetching
        }

        $(document).on('select2:select', '.labour-task-name', function(e) {

          var $row = $(this).closest('tr');

          // item code
          var $input = $(e.target);
          var id = $input.data("id");
          var value = $input.val();

          // Payload data
          data = {
            value: value,
          }

          $.ajax({
            url: '{% url "proposal_app:opportunity:labor-task-name-search" %}',
            type: 'POST',
            data: data,
            headers: {
              'X-CSRFToken': "{{ csrf_token }}",
            },
            success: function(response) {
              if (response.code == 200) {
                updateDescription(response.description, id);
              }
            },
            error: function(xhr, status, error) {
              console.log("Error:", error);
            }
          });

          $(".quoted-cost").on("input", function(e) {

            console.log("Inputed.....");

            var row = $(this).closest("tr");
            var value = $(this).val();

            total = row.find(".total")
            sell = row.find(".sell")
            total_sell = row.find(".sell-total")
            gross_profit = row.find(".gross")
            gross_percent = row.find(".gross-p")

            total.text(value);
            sell.text((parseFloat(value) + 0.25).toFixed(2));
            total_sell.text((parseFloat(value) + 0.25).toFixed(2));
            gross_profit.text((parseFloat(sell.text()) - parseFloat(value)).toFixed(2));
            gross_percent.text(((parseFloat(gross_profit.text()) / parseFloat(sell.text())) * 100).toFixed(2));

          });

        });

        // TODO: Make dyanmic
        // NOTE: Update item code feature
        function updateTaskName(value, id) {
          var $select2Element = $(`select[data-id="${id}"].labour-task-name`);

          // Initialize Select2 if not already initialized
          if (!$select2Element.hasClass('select2-hidden')) {
              $select2Element.select2({
                  ajax: {
                      url: '{% url "proposal_app:opportunity:labor-task-name-search" %}',
                      dataType: 'json',
                      delay: 250,
                      data: function(params) {
                          return {
                              q: value
                          };
                      },
                      processResults: function(data) {
                          // Clear existing options
                          $select2Element.empty();

                          // Populate new options
                          $.each(data.results, function(index, item) {
                              var newOption = new Option(item.text, item.id, false, false);
                              $select2Element.append(newOption);
                          });

                          // Check if there are results and set the first as selected
                          if (data.results.length > 0) {
                              $select2Element.val(data.results[0].id).trigger('change');
                          }

                          return {
                              results: data.results
                          };
                      },
                      cache: true
                  }
              });
          }

          // Manually trigger AJAX request without opening dropdown
          $select2Element.select2('data', null); // Clear previous data
          $select2Element.select2('open'); // Trigger AJAX without user action
          $select2Element.select2('close'); // Close dropdown immediately after fetching
        }

        // TODO: Make dyanmic
        // NOTE: Update item code feature
        $(document).on('select2:select', '.labour-description', function(e) {

          var $row = $(this).closest('tr');

          // item code
          var $input = $(e.target);
          var id = $input.data("id");
          var value = $input.val();

          // Payload data
          data = {
            value: value,
          }

          $.ajax({
            url: '{% url "proposal_app:opportunity:labor-task-description-search" %}',
            type: 'POST',
            data: data,
            headers: {
              'X-CSRFToken': "{{ csrf_token }}",
            },
            success: function(response) {
              if (response.code == 200) {
                updateTaskName(response.task_name, id);
              }
            },
            error: function(xhr, status, error) {
              console.log("Error:", error);
            }
          });

          $(".quoted-cost").on("input", function(e) {

            var row = $(this).closest("tr");
            var value = $(this).val();

            total = row.find(".total")
            sell = row.find(".sell")
            total_sell = row.find(".sell-total")
            gross_profit = row.find(".gross")
            gross_percent = row.find(".gross-p")

            total.text(value);
            sell.text((parseFloat(value) + 0.25).toFixed(2));
            total_sell.text((parseFloat(value) + 0.25).toFixed(2));
            gross_profit.text((parseFloat(sell.text()) - parseFloat(value)).toFixed(2));
            gross_percent.text(((parseFloat(gross_profit.text()) / parseFloat(sell.text())) * 100).toFixed(2));

          });

        });

    });
  </script>

  <!-- NOTE: Remove it -->
  <!-- BEGIN Copy Product Row based on model value-->
  <script>
    function copyTableRow(rowId) {
        console.log("Copying table rows...");

        // Log the rowId to check if it's correct
        console.log("Row ID Passed:", rowId);

        var totalRows = parseInt(document.getElementById("totalRows").value, 10);
        console.log("Total Rows:", totalRows);

        if (isNaN(totalRows) || totalRows < 1) {
            totalRows = 1;
        }

        var tableBody = document.getElementById("tableBody");
        console.log("Table Body:", tableBody);

        var rowToCopy = document.getElementById(rowId);
        console.log("Row to Copy:", rowToCopy);

        if (!rowToCopy) {
            console.error("Row with ID '" + rowId + "' not found.");
            return;
        }

        for (var i = 0; i < totalRows; i++) {
            var clonedRow = rowToCopy.cloneNode(true);

            // Remove ID and adjust class for cloned rows
            clonedRow.removeAttribute('id');
            clonedRow.classList.add('dynamic-row');

            // Update input names and IDs to ensure they are unique
            var inputs = clonedRow.querySelectorAll('input, select');
            inputs.forEach(function(input, index) {
                var newName = input.name ? input.name.replace(/\d+/, totalRows + i + 1) : '';
                var newId = input.id ? input.id.replace(/\d+/, totalRows + i + 1) : '';
                input.name = newName;
                input.id = newId;
                input.value = '';
            });

            tableBody.appendChild(clonedRow);
            console.log("Row appended to table body");

            // Increment totalRows
            totalRows++;
            document.getElementById("totalRows").value = totalRows;
        }
      }
  </script>
  <!-- END Copy Product Row based on model value-->


  <!-- BEGIN compare standardCost with productCost-->
  <script>
    function checkCostEquality(standardCostId, productCostId) {
      var standardCostElement = document.getElementById(standardCostId);
      var productCostInput = document.getElementById(productCostId);

      if (standardCostElement && productCostInput) {
          var standardCost = parseFloat(standardCostElement.value .trim().replace('$', ''));
          var productCost = parseFloat(productCostInput.value.trim().replace('$', ''));

          if (standardCost !== productCost) {
                productCostInput.classList.add("border-danger", "border-2", "text-danger");
            } else {
                productCostInput.classList.remove("border-danger", "border-2", "text-danger");
            }
        }
    }

    // Initialize cost checks if necessary
    document.addEventListener("DOMContentLoaded", function() {
        // Optional: Run checks on page load for all inputs
        document.querySelectorAll('input[data-standard-cost]').forEach(function(input) {
            var standardCostId = input.getAttribute('data-standard-cost');
            checkCostEquality(standardCostId, input.id);
        });
    });
  </script>

  <!-- SEARCH start -->

    <!-- SEARCH: Item code -->
    <script>
      $(document).ready(function() {
          $('.select2-item-code').select2({
            placeholder: 'Select Item Code',
            tags: true, // Enable the tagging feature
            ajax: {
                url: '{% url "proposal_app:opportunity:item-code-search" %}',
                dataType: 'json',
                delay: 250,
                data: function (params) {
                    return {
                        q: params.term
                    };
                },
                processResults: function (data) {
                    return {
                        results: data.results
                    };
                },
                cache: true
            }
          });

          /* function updateDescription(value, id) {
            var $select2Element = $(`select[data-id="${id}"].select2-item-description.js-example-programmatic.form-control`);

            // Initialize Select2 if not already initialized
            if (!$select2Element.hasClass('select2-hidden')) {
                $select2Element.select2({
                    ajax: {
                        url: '{% url "proposal_app:opportunity:item-description-search" %}',
                        dataType: 'json',
                        delay: 250,
                        data: function(params) {
                            return {
                                q: value
                            };
                        },
                        processResults: function(data) {
                            // Clear existing options
                            $select2Element.empty();

                            // Populate new options
                            $.each(data.results, function(index, item) {
                                var newOption = new Option(item.text, item.id, false, false);
                                $select2Element.append(newOption);
                            });

                            // Check if there are results and set the first as selected
                            if (data.results.length > 0) {
                                $select2Element.val(data.results[0].id).trigger('change');
                            }

                            return {
                                results: data.results
                            };
                        },
                        cache: true
                    }
                });
            }


            $select2Element.select2('data', null);
            $select2Element.select2('open');
            $select2Element.select2('close');
          }

          $(document).on('change', '.select2-item-code', function(e) {
            // item code
            var $input = $(e.target);
            var id = $input.data("id");
            console.log("id", id);

            var value = $input.val();
            console.log("value",value);

            // Payload data
            data = {
              value: value,
            }

            $.ajax({
              url: '{% url "proposal_app:opportunity:item-code-search" %}',
              type: 'POST',
              data: data,
              headers: {
                'X-CSRFToken': "{{ csrf_token }}",
              },
              success: function(response) {
                console.log('API call success:', response);
                if (response.code == 200) {
                  updateDescription(response.description, id);
                  var $stdCostField = $(`input[data-id="${id}"][id="std_cost"]`);
                  var total = $(`td[data-id="${id}"].total`);
                  var sell = $(`td[data-id="${id}"].sell`);
                  var total_sell = $(`td[data-id="${id}"].sell-total`);
                  var gross_profit = $(`td[data-id="${id}"].gross`);
                  var gross_percent = $(`td[data-id="${id}"].gross-p`);

                  $stdCostField.val(response.std_cost);
                  total.text($stdCostField.val());
                  sell.text(parseFloat($stdCostField.val()) + 0.25);
                  total_sell.text(parseFloat($stdCostField.val()) + 0.25);
                  gross_profit.text(parseFloat(sell.text()) - parseFloat($stdCostField.val()));
                  gross_percent.text(((parseFloat(gross_profit.text()) / parseFloat(sell.text())) * 100).toFixed(2));

                }
              },
              error: function(xhr, status, error) {
                console.log("Error:", error);
              }
            });
          }); */
      });
    </script>

    <!-- SEARCH:  Item Description -->
    <script>
      $(document).ready(function() {
        $('.select2-item-description').select2({
            placeholder: 'Select Item description',
            tags: true, // Enable the tagging feature
            ajax: {
                url: '{% url "proposal_app:opportunity:item-description-search" %}',
                dataType: 'json',
                delay: 250,
                data: function (params) {
                    return {
                        q: params.term
                    };
                },
                processResults: function (data) {
                    return {
                        results: data.results
                    };
                },
                cache: true
            }
        });
      });
    </script>

    <!-- SEARCH:  Vendor -->
    <script>
      $(document).ready(function() {
          $('.select2-vendor').select2({
              placeholder: 'Select Vendor Name',
              ajax: {
                  url: '{% url "proposal_app:opportunity:vendor-search" %}',
                  dataType: 'json',
                  delay: 250,  // Add a delay for better UX
                  data: function (params) {
                      return {
                          q: params.term
                      };
                  },
                  processResults: function (data) {
                      return {
                          results: data.results
                      };
                  },
                  cache: true
              }
          });
      });
    </script>

    <!-- SEARCH: Task -->
    <script>
      $(document).ready(function() {
            $('.select2-task').select2({
                containerCss: { width: "150px" },
                dropdownAutoWidth: true,  // Ensure dropdown respects the width
                width: 'resolve',
                placeholder: 'Select Task Name',
                ajax: {
                    url: '{% url "proposal_app:opportunity:task-search" %}',
                    dataType: 'json',
                    delay: 250,
                    data: function (params) {
                        return {
                            q: params.term,
                            document_number: "{{ opportunity.document_number }}",
                        };
                    },
                    processResults: function (data) {
                        return {
                            results: data.results
                        };
                    },
                    cache: true
                }
            });
        });
    </script>

    <!-- SEARCH:  Labour Task -->
    <script>
      $(document).ready(function() {
            $('.select2-labor-task').select2({
                containerCss: { width: "150px" },
                dropdownAutoWidth: true,
                width: 'resolve',
                placeholder: 'Select Task Name',

                ajax: {
                    url: '{% url "proposal_app:opportunity:labor-task-search" %}',
                    dataType: 'json',
                    delay: 250,
                    data: function (params) {
                        return {
                            q: params.term
                        };
                    },
                    processResults: function (data) {
                        return {
                            results: data.results
                        };
                    },
                    cache: true
                }
            });
        });
    </script>

    <!-- SEARCH: Labor task name -->
    <script>
      $(document).ready(function() {

        function updateDescription(value, id) {
          var $select2Element = $(`select[data-id="${id}"].labour-description`);

          // Initialize Select2 if not already initialized
          if (!$select2Element.hasClass('select2-hidden')) {
              $select2Element.select2({
                  ajax: {
                      url: '{% url "proposal_app:opportunity:labor-task-description-search" %}',
                      dataType: 'json',
                      delay: 250,
                      data: function(params) {
                          return {
                              q: value
                          };
                      },
                      processResults: function(data) {
                          // Clear existing options
                          $select2Element.empty();

                          // Populate new options
                          $.each(data.results, function(index, item) {
                              var newOption = new Option(item.text, item.id, false, false);
                              $select2Element.append(newOption);
                          });

                          // Check if there are results and set the first as selected
                          if (data.results.length > 0) {
                              $select2Element.val(data.results[0].id).trigger('change');
                          }

                          return {
                              results: data.results
                          };
                      },
                      cache: true
                  }
              });
          }

          // Manually trigger AJAX request without opening dropdown
          $select2Element.select2('data', null); // Clear previous data
          $select2Element.select2('open'); // Trigger AJAX without user action
          $select2Element.select2('close'); // Close dropdown immediately after fetching
        }

        $(document).on('change', '.labour-task-name', function(e) {

          var $row = $(this).closest('tr');

          // item code
          var $input = $(e.target);
          var id = $input.data("id");
          var value = $input.val();

          // Payload data
          data = {
            value: value,
          }

          $.ajax({
            url: '{% url "proposal_app:opportunity:labor-task-name-search" %}',
            type: 'POST',
            data: data,
            headers: {
              'X-CSRFToken': "{{ csrf_token }}",
            },
            success: function(response) {
              if (response.code == 200) {
                var $localcost = $(`input[data-id="${id}"][id="local_cost"]`);
                var $out_of_town_cost = $(`input[data-id="${id}"][id="out_of_town_cost"]`);
                updateDescription(response.description, id);
                $localcost.val(response.local_labor_rates);
                $out_of_town_cost.val(response.out_of_town_labour_rates);
              }
            },
            error: function(xhr, status, error) {
              console.log("Error:", error);
            }
          });
        });

        $('.labour-task-name ').select2({
          placeholder: 'Select task Name',
          tags: true, // Enable the tagging feature
          ajax: {
              url: '{% url "proposal_app:opportunity:labor-task-name-search" %}',
              dataType: 'json',
              delay: 250,
              data: function (params) {
                  return {
                      q: params.term
                  };
              },
              processResults: function (data) {
                  return {
                      results: data.results
                  };
              },
              cache: true
            }
        });
      });
    </script>

    <!-- SEARCH: Labor task description -->
    <script>
      $(document).ready(function() {
        $('.labour-description ').select2({
          placeholder: 'Select task description',
          tags: true, // Enable the tagging feature
          ajax: {
              url: '{% url "proposal_app:opportunity:labor-task-description-search" %}',
              dataType: 'json',
              delay: 250,
              data: function (params) {
                  return {
                      q: params.term
                  };
              },
              processResults: function (data) {
                  return {
                      results: data.results
                  };
              },
              cache: true
            }
        });
      });
    </script>

  <!-- SEARCH end -->

  <!-- Assigned Product Htmx -->
  <script>
    $(document).on('click', '.htmx-trigger-btn-assign-prod' , function (e) {

      var url = $(this).data('url');
      htmx.ajax('GET',
          url,
          {
            target:'#model-assign',
            swap:'innerHTML',
      }).then(() => {
          $('#assign-prod').toggleClass('hidden');
      })
    });
  </script>

  <!-- Delete Assigned Product -->
  <script>
    $(document).on('click', '.assign-prod-delete-btn', function (e) {
      var id = $(this).data("id")
      var prod_name = $(this).data("title")
      if (prod_name == "None") {
        prod_name = ""
      }
      var url = $(this).data("url")
      var delete_ele = $(this)

      Swal.fire({
        html: `Are you sure you want to delete <b>${prod_name}</b>?`,
        icon: 'question',
        showCloseButton: true,
        showCancelButton: true,
        confirmButtonColor: "#7442DB",

      }).then((result) => {

        if (result.isConfirmed) {
          $(this).closest('tr').remove();
          $.ajax({
            type: "POST",
            url: url,
            data: {
              "id": id,
              "csrfmiddlewaretoken": '{{ csrf_token }}'
            },
            success: function (data) {
              console.log("", data);
              toastr.info(data.message, 'Info', {
                closeButton: true,
                progressBar: true,
                positionClass: 'toast-bottom-right',
                timeOut: 6000
              });
            }
          });
        }else {
              Swal.fire("Cencel delete", "", "info");
        }
      });
    });
  </script>

  <!-- Update Assigned Product -->
  <script>

    // Input Fields
    $(document).ready(function() {
      $(".quantity, .vendor-quoted-cost, .comment, .standard-cost").on("keydown", function(e) {
        // Check if Enter key is pressed (keyCode 13)
        if (e.key === 'Enter' || e.keyCode === 13) {
          e.preventDefault();

          var $input = $(e.target);
          var id = $input.data("id");
          var value = $input.val();
          var inputType = '';

          if ($input.hasClass("quantity")) {
            inputType = 'quantity';
          } else if ($input.hasClass("vendor-quoted-cost")) {
            inputType = 'vendor_quoted_cost';
          }else if ($input.hasClass("standard-cost")) {
            inputType = 'standard_cost';
          } else if ($input.hasClass("comment")) {
            inputType = 'comment';
          }

          console.log(inputType.charAt(0).toUpperCase() + inputType.slice(1) + " Id:", id);
          console.log(inputType.charAt(0).toUpperCase() + inputType.slice(1) + " Value:", value);

          $.ajax({
            url: '{% url "proposal_app:opportunity:assign-prod-update-ajax" %}', // Replace with your actual URL
            type: 'POST',
            data: {
              type: inputType,
              id: id,
              value: value
            },
            headers: {
              'X-CSRFToken': "{{ csrf_token }}",
            },
            success: function(response) {
              console.log('API call success:', response);
              toastr.success(response.message, 'Success', {
                closeButton: true,
                progressBar: true,
                positionClass: 'toast-bottom-right',
                timeOut: 6000
              });
            },
            error: function(xhr, status, error) {
              console.error('API call error:', status, error);
              toastr.error(xhr.responseJSON.message, 'Error', {
                closeButton: true,
                progressBar: true,
                positionClass: 'toast-bottom-right',
                timeOut: 6000
              });
            }
          });
        }
      });
    });

    // Select Fields
    $(document).ready(function() {
      $(".select2-vendor, .select2-task, .select2-labor-task").on("change", function(e) {
        var $input = $(e.target);
        var id = $input.data("id");
        console.log("id", id);

        var value = $input.val();
        console.log("value",value);

        var inputType = '';

        if ($input.hasClass("select2-vendor")){
          inputType = 'vendor';
        } else if ($input.hasClass("select2-task")){
          inputType = 'task';
        } else if ($input.hasClass("select2-labor-task")){
          inputType = 'labor-task';
        }

        // Log the values based on the input type
        console.log(inputType.charAt(0).toUpperCase() + inputType.slice(1) + " Id:", id);
        console.log(inputType.charAt(0).toUpperCase() + inputType.slice(1) + " Value:", value);

        // AJAX call to a single endpoint
        $.ajax({
          url: '{% url "proposal_app:opportunity:assign-prod-update-ajax" %}', // Replace with your actual URL
          type: 'POST',
          data: {
            type: inputType,
            id: id,
            value: value
          },
          headers: {
            'X-CSRFToken': "{{ csrf_token }}",
          },
          success: function(response) {
            console.log('API call success:', response);
            toastr.success(response.message, 'Success', {
              closeButton: true,
              progressBar: true,
              positionClass: 'toast-bottom-right',
              timeOut: 6000
            });
          },
          error: function(xhr, status, error) {
            console.error('API call error:', status, error);
            toastr.error(xhr.responseJSON.message, 'Error', {
              closeButton: true,
              progressBar: true,
              positionClass: 'toast-bottom-right',
              timeOut: 6000
            });
          }
        });
      });
    });

  </script>

  <!-- Add Task Htmx -->
  <script>
    $(document).on('click', '.htmx-trigger-btn-add-task' , function (e) {

      var url = $(this).data('url');
      htmx.ajax('GET',
          url,
          {
            target:'#model-add-task',
            swap:'innerHTML',
      }).then(() => {
          $('#add-task').toggleClass('hidden');
      })
    });

    document.body.addEventListener('htmx:beforeSwap', function(evt) {

      if(evt.detail.xhr.status === 200){
          // console.log("evt.detail.xhr.status", evt.detail.xhr.status)
          // console.log("evt.detail.xhr.response", evt.detail.xhr.response)
          $("#add-task").modal('hide');
          $("#add-task .modal-body").html('');

          // Parse the JSON response
          var response = JSON.parse(evt.detail.xhr.response);

          if (response.status === 'success') {
            window.location.reload();
          }
      }
    });
  </script>

  <!-- Assign Labor for task -->
  <!-- Feature: Link labor with tasks -->
  <script>
    $(document).ready(function() {

      $(".select-labor-task").select2({
        width: "100%",
        placeholder: 'Select Tasks',
        ajax: {
          url: function () {
            return $(this).data("url");
          },
          dataType: 'json',
          delay: 250,
          data: function (params) {
              return {
                  q: params.term
              };
          },
          processResults: function (data) {
              return {
                  results: data.results
              };
          },
          cache: true
        }
      });

      $(".select-labor-task").on("change", function(e){

        var value = $(this).val();
        var current_task_id = $(this).data("id");
        var document_number = $(this).data("document");
        var url = $(this).data("url");

        // Payload data
        data = {
          value: value,
          id: current_task_id,
          document_number: document_number
        }

        // Ajax call
        $.ajax({
          url: url,
          type: 'POST',
          data: data,
          headers: {
            'X-CSRFToken': "{{ csrf_token }}",
          },
          success: function(response) {
              window.location.reload();
          },
          error: function(xhr, status, error) {
            toastr.error(xhr.responseJSON.message, 'Error', {
              closeButton: true,
              progressBar: true,
              positionClass: 'toast-bottom-right',
              timeOut: 6000
            });
          }
        });
      });
    });
  </script>


  <!-- Auto populated calculation -->
  <script>
    $(document).ready(function(){
      $(".standard-cost, .vendor-quoted-cost, .quantity").on("input", function(e) {

        var $input = $(e.target);
        var task_id = $(this).data("task-id");
        var tr = document.querySelectorAll(`.tr-${task_id}`);
        var task_tr = document.querySelectorAll(".task-tr");
        var labor_task_tr = document.querySelectorAll(".labor-task-tr");

        // current row
        var $row = $(this).closest("tr");

        // Values
        var standard_cost = $row.find(".standard-cost").val();
        var vendor_quoted_cost = $row.find(".vendor-quoted-cost").val();

        if ($input.hasClass("quantity")) {

          var totalQuantity = 0;

          tr.forEach(function(row) {
              var costTotalQuantity = row.getElementsByClassName('quantity');

              for (var j = 0; j < costTotalQuantity.length; j++) {
                  totalQuantity += parseFloat(costTotalQuantity[j].value) || 0;
              }
          });

          $(`.mapping-total-qauntiy-${task_id}`).text(totalQuantity.toFixed(2));

          var taskToalQuantity = 0;
          var laborTaskToalQuantity = 0;

          task_tr.forEach(function(row) {

            var costTaskTotalQuantity = row.getElementsByClassName('t-quantity');

            for (var j = 0; j < costTaskTotalQuantity.length; j++) {
              taskToalQuantity += parseFloat(costTaskTotalQuantity[j].textContent) || 0;
            }

          });

          $(".mapping-grand-total-quantity").text(taskToalQuantity.toFixed(2));

          labor_task_tr.forEach(function(row) {

            var costTaskTotalQuantity = row.getElementsByClassName('t-quantity');

            for (var j = 0; j < costTaskTotalQuantity.length; j++) {
              laborTaskToalQuantity += parseFloat(costTaskTotalQuantity[j].textContent) || 0;
            }

          });

          $(".mapping-grand-total-labor-quantity").text(laborTaskToalQuantity.toFixed(2));

        }else if (vendor_quoted_cost != 0.0) {

          $row.find(".cost-total").text(vendor_quoted_cost);
          $row.find(".mapping-prod-sell").text();

          var mapping_total_sell = parseFloat(vendor_quoted_cost) + 0.25;
          var mapping_total_gross_profit = parseFloat(mapping_total_sell) - parseFloat(vendor_quoted_cost);
          var mapping_total_gross_percentage = parseFloat(mapping_total_gross_profit / mapping_total_sell) * 100;

          $row.find(".mapping-prod-sell").text(mapping_total_sell.toFixed(2));
          $row.find(".mapping-prod-gross-profit").text(mapping_total_gross_profit.toFixed(2));
          $row.find(".mapping-prod-gross-percentage").text(mapping_total_gross_percentage.toFixed(2));

        } else {

          $row.find(".cost-total").text(standard_cost);
          $row.find(".mapping-prod-sell").text();

          var mapping_total_sell = parseFloat(standard_cost) + 0.25;
          var mapping_total_gross_profit = parseFloat(mapping_total_sell) - parseFloat(standard_cost);
          var mapping_total_gross_percentage = parseFloat(mapping_total_gross_profit / mapping_total_sell) * 100;

          $row.find(".mapping-prod-sell").text(mapping_total_sell.toFixed(2));
          $row.find(".mapping-prod-gross-profit").text(mapping_total_gross_profit.toFixed(2));
          $row.find(".mapping-prod-gross-percentage").text(mapping_total_gross_percentage.toFixed(2));
        }

        // Stotr total value
        var totalCost = 0;
        var totalPercent = 0;

        tr.forEach(function(row) {

          var costTotalElements = row.getElementsByClassName('cost-total');
          var costTotalPercent = row.getElementsByClassName('mapping-prod-gross-percentage');

          for (var j = 0; j < costTotalElements.length; j++) {
            totalCost += parseFloat(costTotalElements[j].textContent) || 0;
          }

          for (var j = 0; j < costTotalPercent.length; j++) {
            totalPercent += parseFloat(costTotalPercent[j].textContent) || 0;
          }

        });

        $(`.mapping-total-price-${task_id}`).text("$"+totalCost.toFixed(2));
        $(`.mapping-total-percent-${task_id}`).text(totalPercent.toFixed(2)+"%");

         // Task Total
        var all_task_total = 0;
        var all_labor_task_total = 0;

        task_tr.forEach(function(row) {
          var costTaskTotal = row.getElementsByClassName('t-price');

          for (var j = 0; j < costTaskTotal.length; j++) {
            all_task_total += parseFloat(costTaskTotal[j].textContent.replace(/\$/g, '').trim()) || 0;
          }

        });

        $(".mapping-grand-total").text("$"+all_task_total)

        labor_task_tr.forEach(function(row) {
          var costTaskTotal = row.getElementsByClassName('t-price');

          for (var j = 0; j < costTaskTotal.length; j++) {
            all_labor_task_total += parseFloat(costTaskTotal[j].textContent.replace(/\$/g, '').trim()) || 0;
          }

        });

        $(".mapping-grand-total-labor").text("$"+all_labor_task_total)

      });

    });
  </script>

{% endblock script %}
