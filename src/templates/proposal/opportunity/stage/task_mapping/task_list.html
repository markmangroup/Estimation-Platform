{% load custom_filters %}
<!-- Task Start-->
{% for t_id, t_info in task_mapping_list.items %}
{% if  t_info.task.code %}
    <tr class="task-tr">
        <td>
            <select data-id="{{t_id}}" class="select2-task form-control">
                <option selected disabled>{{ t_info.task.code }}</option>
            </select>
        </td>
        <td>
            <input type="text" class="form-control task_description" data-id="{{ t_id }}" value="{{ t_info.task.description }}" />
        </td>
        <td class="mapping-total-price-{{t_id}} t-price">${{ t_info.total_price }}</td>
        <td class="mapping-total-percent-{{t_id}} t-percent">{{ t_info.total_percent }}%</td>
        <td class="mapping-total-qauntiy-{{t_id}} t-quantity">{{ t_info.total_quantity }}</td>
        <td>EA</td>
        <td class="mapping-total-price-{{t_id}}">${{ t_info.total_unit_price }}</td>
        <td>
            <div class="tasks-mapping-collapse">
                <a data-toggle="collapse" href="#collapse{{ t_id }}" aria-expanded="true" aria-controls="collapse{{ t_id }}" class="card-title">
                    <em class="ft-chevron-down font-medium-5"></em>
                </a>
                <span class="text-danger delete-task-btn" data-id="{{ t_id }}" data-title="{{t_info.task.code}}" data-type="task_mapping" data-url="{% url 'proposal_app:opportunity:task-delete-ajax' %}"><em class="fa fa-trash"></em></span>
            </div>
        </td>
    </tr>
{% else %}
    <tr class="task-tr">
        <td>
            <select data-id="{{t_id}}" class="select2-task form-control">
                <option selected disabled>{{ t_info.task.task.name }}</option>
            </select>
        </td>
        <td>
            <input type="text" class="form-control task_description" data-id="{{ t_id }}" value="{{ t_info.task.task.description }}"/>
        </td>
        <td class="mapping-total-price-{{t_id}} t-price">${{ t_info.total_price }}</td>
        <td class="mapping-total-percent-{{t_id}} t-percent">{{ t_info.total_percent }}%</td>
        <td class="mapping-total-qauntiy-{{t_id}} t-quantity">{{ t_info.total_quantity }}</td>
        <td>EA</td>
        <td class="mapping-total-price-{{t_id}}">${{ t_info.total_unit_price }}</td>
        <td>
            <div class="tasks-mapping-collapse">
                <a data-toggle="collapse" href="#collapse{{ t_id }}" aria-expanded="true" aria-controls="collapse{{ t_id }}" class="card-title">
                    <em class="ft-chevron-down font-medium-5"></em>
                </a>
                <span class="text-danger delete-task-btn" data-id="{{ t_id }}" data-title="{{t_info.task.task.name}}" data-type="task_mapping" data-url="{% url 'proposal_app:opportunity:task-delete-ajax' %}"><em class="fa fa-trash"></em></span>
            </div>
        </td>
    </tr>
{% endif %}

<tr id="collapse{{ t_id }}" role="tabpanel" aria-labelledby="headingCollapse{{ t_id }}" class="collapse">
    <td></td>
    <td colspan="100">
        <div class="text-right my-2">

            <button type="button" class="btn bg-light-primary" data-backdrop="false" data-toggle="modal" data-target="#addProduct{{t_id}}">
                <em class="ft-plus font-medium-5"></em> Add Product
            </button>

            <!-- Add Product Modal -->
            <div class="modal fade text-left" id="addProduct{{t_id}}" tabindex="-1" role="dialog" aria-labelledby="myModalLabel5" aria-hidden="true">
                <div class="modal-dialog modal-md modal-dialog-centered" role="document">
                    <div class="modal-content">
                    <div class="modal-header">
                    <h4 class="modal-title" id="myModalLabel5">Add Product</h4>
                    <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                        <span aria-hidden="true"><i class="ft-x font-medium-2 text-bold-700"></i></span>
                        </button>
                    </div>
                    <div class="modal-body">
                    <section id="multiple-select2">
                        <div class="card">
                            <div class="card-content">
                            <div class="card-body">
                                <div class="form-group">
                                    <label>Enter the number of fields</label>
                                    <input id="totalRows{{t_id}}" type="text" class="form-control mb-1" placeholder="Enter the number of fields">
                                </div>
                            </div>
                            </div>
                        </div>
                        </section>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn bg-light-secondary" data-dismiss="modal">Close</button>
                        <button type="button" data-id="{{t_id}}" class="btn btn-primary add-multi-row-btn" data-dismiss="modal"><em class="ft-plus font-medium-5"></em> Add Product</button>
                    </div>
                    </div>
                </div>
            </div>

            <button type="button" class="btn bg-light-primary htmx-trigger-btn-assign-prod"
                    data-url="{% url 'proposal_app:opportunity:assign-prod-labor' t_info.task.opportunity.document_number t_id %}"
                    hx-get="{% url 'proposal_app:opportunity:assign-prod-labor' t_info.task.opportunity.document_number t_id %}"
                    hx-target="#model-assign" hx-trigger="click" data-toggle="modal" data-target="#assign-prod">
                <i class="fa ft-briefcase mr-1"></i>Assign Products
            </button>
        </div>
        <div class="table-responsive">
            <table id="tableBody-{{ t_id }}" class="table table-striped table-bordered">
                <thead>
                    <tr class="text-center">
                        <th colspan="1"></th>
                        <th colspan="7" class="align-top">Project Product Information</th>
                        <th colspan="1" class="align-top">Cost</th>
                        <th colspan="2" class="align-top">Sell</th>
                        <th colspan="2" class="align-top">Gross Profit</th>
                        <th colspan="1" class="align-top"></th>
                    </tr>
                    <tr>
                        <th>Sr No</th>
                        <th class="text-nowrap">Quantity</th>
                        <th>Item Code</th>
                        <th>Description</th>
                        <th>Standard Cost</th>
                        <th>Vendor Quoted cost</th>
                        <th>Vendor</th>
                        <th class="text-nowrap">Item Note</th>
                        <th>Total</th>
                        <th>Sell</th>
                        <th>Total</th>
                        <th>$</th>
                        <th>%</th>
                        <td></td>
                    </tr>
                </thead>

                <tbody id="sortable-{{t_id}}" class="sortable">

                    {% for ap in t_info.assigned_products %}
                        <tr class="tr-{{t_id}}" data-row-id="{{ap.id}}">
                            <td class="sr-no">{{ forloop.counter }}</td>
                            <td>
                                <input type="text" data-id="{{ap.id}}" class="form-control quantity" value="{{ap.quantity|floatformat:0|default:''}}" data-task-id="{{t_id}}" placeholder="Enter Quantity">
                            </td>
                            <td>{{ ap.item_code }}</td>
                            <td>{{ ap.description|default:'-' }}</td>
                            <td>
                                <input type="text" id="standardCost{{ ap.id }}" class="form-control standard-cost" data-id="{{ap.id}}" data-task-id="{{t_id}}" value="{{ ap.standard_cost|default:'' }}">
                            </td>
                            <td>
                                <input id="productCost{{ ap.id }}" data-id="{{ ap.id }}" data-task-id="{{t_id}}" data-standard-cost="standardCost{{ ap.id }}" type="text" class="form-control vendor-quoted-cost" value="{{ap.vendor_quoted_cost|default:''}}" onchange="checkCostEquality('standardCost{{ ap.id }}', 'productCost{{ ap.id }}')" onkeyup="checkCostEquality('standardCost{{ ap.id }}', 'productCost{{ ap.id }}')">
                            </td>
                            <td>
                                <select data-id="{{ap.id}}" class="select2-vendor form-control">
                                    <option selected disabled>{{ap.vendor|default:'Select Vendor Name'}}</option>
                                </select>
                            </td>
                            <td>
                                <input type="text" id="comment-{{ap.id}}" data-id="{{ ap.id }}" class="form-control comment" placeholder="Enter Item Note" value="{{ ap.comment|default:'' }}">
                            </td>
                            <td><span class="cost-total">{{ ap.vendor_quoted_cost|default:ap.standard_cost|multiply:ap.quantity|round_value:"2" }}</span></td>
                            <td class="mapping-prod-sell">{{ ap.sell }}</td>
                            <td class="mapping-prod-sell">{{ ap.sell }}</td>
                            <td class="mapping-prod-gross-profit">{{ ap.gross_profit }}</td>
                            <td class="mapping-prod-gross-percentage">{{ ap.gross_profit_percentage }}</td>
                            <td class="d-flex">
                                {% if t_info.task.code %}
                                <button type="button" class="btn btn-danger assign-prod-delete-btn remove-row-btn mr-2" data-task-id={{t_id}} data-id="{{ap.id}}" data-title="{{ap.description}} - {{ t_info.task.code }}" data-url="{% url   'proposal_app:opportunity:assign-prod-delete-ajax' %}"><em class="fa fa-trash"></em></button>
                                <button type="button" data-id="{{t_id}}" class="btn btn-primary add-row-btn" style="display: none;"><i class="fa fa-plus"></i></button>
                                {% else %}
                                <button type="button" class="btn btn-danger assign-prod-delete-btn remove-row-btn mr-2" data-task-id={{t_id}} data-id="{{ap.id}}" data-title="{{ap.description}} - {{ t_info.task.task.name }}" data-url="{% url   'proposal_app:opportunity:assign-prod-delete-ajax' %}"><em class="fa fa-trash"></em></button>
                                <button type="button" data-id="{{t_id}}" class="btn btn-primary add-row-btn" style="display: none;"><i class="fa fa-plus"></i></button>
                            {% endif %}
                            </td>
                        </tr>

                        {% endfor %}

                        <!-- Genarate dynamic rows -->
                        <tr id="row-template-{{ t_id }}" class="new_prod">
                            <td class="d-none"><input type="hidden" class="task_id" value="{{ t_id }}"></td>
                            <td class="sr-no" id="sr-no">{{ t_info.assigned_products.count|add:1 }}</td>
                            <td class="text-nowrap"><input type="text" class="form-control quantity" data-id="quantity-{{t_id}}" placeholder="Enter Quantity"></td>
                            <td class="text-nowrap">
                                <select data-id="{{ t_id }}" class="select2-item-code js-example-programmatic form-control">
                                    <!-- Data will apper here -->
                                </select>
                            </td>
                            <td>
                                <select data-id="{{ t_id }}" class="select2-item-description js-example-programmatic form-control" >
                                    <!-- Data will apper here -->
                                </select>
                            </td>
                            <td>
                                <input type="text" id="standardCost{{ t_id }}" data-task-id="{{t_id}}" class="form-control standard-cost" data-id="{{ t_id }}" placeholder="Enter Standard Cost" value="0">
                            </td>
                            <td>
                                <input id="productCost{{ t_id }}" data-id="{{ t_id }}" data-task-id="{{t_id}}" data-standard-cost="standardCost{{ t_id }}" type="text" class="form-control quoted-cost" onchange="checkCostEquality('standardCost{{ t_id }}', 'productCost{{ t_id }}')" onkeyup="checkCostEquality('standardCost{{ t_id }}', 'productCost{{ t_id }}')" placeholder="Enter Quoted Cost" value="0">
                            </td>
                            <td>
                                <select data-id="{{ t_id }}" class="select2-vendor vendor form-control">
                                <option selected disabled>Select Vendor Name</option>
                                </select>
                            </td>
                            <td><input type="text" class="form-control comment" placeholder="Enter Item Note"></td>
                            <td class="total" data-id="{{t_id}}"></td>
                            <td class="sell" data-id="{{t_id}}"></td>
                            <td class="sell-total" data-id="{{t_id}}"></td>
                            <td class="gross" data-id="{{t_id}}"></td>
                            <td class="gross-p" data-id="{{t_id}}"></td>
                            <td class="d-flex">
                                <button type="button" data-id="{{t_id}}" class="btn btn-danger mr-2 remove-row-btn" data-task-id="{{t_id}}"><i class="fa fa-trash"></i></button>
                                <button type="button" data-id="{{t_id}}" class="btn btn-primary add-row-btn"><i class="fa fa-plus"></i></button>
                            </td>
                        </tr>

                </tbody>
            </table>
        </div>
    </td>
</tr>
{% endfor %}
<!-- Task End-->

<!--Task Total -->
{% if task_mapping_list %}
<tr>
    <th></th>
    <th>Total</th>
    <th class="mapping-grand-total">${{grand_total.grand_total_price}}</th>
    <th></th>
    <th class="mapping-grand-total-quantity">{{grand_total.grand_total_quantity}}</th>
    <th></th>
    <th></th>
    <th></th>
</tr>
{% endif %}
<!--Task Total -->