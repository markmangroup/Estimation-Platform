<div class="modal-header">
    <h4 class="modal-title" id="myModalLabel5">
        Products of <span class="font-italic">{{ task_mapping.code }}</span>
    </h4>
        <button type="button" class="close" data-dismiss="modal" aria-label="Close">
            <span aria-hidden="true"><i class="ft-x font-medium-2 text-bold-700"></i></span>
        </button>
</div>
<!-- Showing products of Task Mapping -->
    <div class="modal-body">
        <div class="table-responsive">
            <table class="table table-striped table-bordered">
                <thead>
                    <tr class="text-center">
                        <th colspan="1"></th>
                        <th colspan="5" class="align-top">
                        Project Product Information
                        </th>
                        <th colspan="1" class="align-top">Cost</th>
                        <th colspan="2" class="align-top">Sell</th>
                        <th colspan="2" class="align-top">Gross Profit</th>
                        <th colspan="1" class="align-top"></th>
                    </tr>
                    <tr>
                        <th>Sr No</th>

                        <th class="text-nowrap">Labor task</th>
                        <th >Description</th>
                        <th class="text-nowrap">Quantity</th>
                        <th>Standard Cost</th>
                        <th>Vendor Quoted cost</th>
                        <th>Total</th>
                        <th>Sell</th>
                        <th>Total</th>
                        <th>$</th>
                        <th>%</th>
                        <td></td>
                    </tr>
                </thead>
                <tbody>
                    {% for l in labors %}
                        <tr class="prod">
                            <td>
                                {{forloop.counter}}
                                <input type="hidden" class="assign-pro-id" value="{{l.id}}">
                            </td>
                            <td class="text-nowrap">{{ l.labor_task }}</td>
                            <td class="text-nowrap">{{ l.description }}</td>
                            <td><input type="text" class="form-control quantity" value="{{ l.quantity }}"></td>
                            <td><input type="text" class="form-control standard_cost" value="{{ l.standard_cost }}"></td>
                            <td>
                                <input type="text" class="form-control vendor_quoted_cost" value="{{ l.vendor_quoted_cost }}" onchange="" onkeyup=""/>
                            </td>
                            <td>
                                {% if l.vendor_quoted_cost %}
                                    {{ l.vendor_quoted_cost }}
                                {% else %}
                                    {{ l.standard_cost }}
                                {% endif %}
                            </td>

                            <td>{{l.sell}}</td>
                            <td>{{l.sell}}</td>

                            <td>{{l.gross_profit}}</td>
                            <td>{{l.gross_profit_percentage}}</td>
                            <td>
                                <button type="button" class="btn btn-danger labor-task-delete-btn" data-id="{{ l.id }}" data-title="{{ l.description }} - {{ l.labor_task }}" data-url="{% url   'proposal_app:opportunity:assign-prod-delete-ajax' %}"><em class="fa fa-trash"></em></button>
                            </td>
                        </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>
    <div class="modal-footer">
        <button type="button" class="btn bg-light-secondary" data-dismiss="modal">Close</button>
        <button type="button" class="btn btn-primary ok-btn" data-dismiss="modal">OK</button>
        <button type="button" class="btn btn-success save-btn">Save</button>
    </div>

<!-- Delete Assigned Product -->
<script>
    $(document).ready(function(e){
        $(".save-btn").hide();
    });

    $(document).on('click', '.labor-task-delete-btn', function (e) {
        var id = $(this).data("id")
        var prod_name = $(this).data("title")
        if (prod_name == "None") {
            prod_name = ""
        }
        var url = $(this).data("url")
        var delete_ele = $(this)

        Swal.fire({
            html: `Are you sure you want to delete <b>${prod_name}</b>?`,
            icon: 'question',
            showCloseButton: true,
            showCancelButton: true,
            confirmButtonColor: "#7442DB",

        }).then((result) => {

            if (result.isConfirmed) {
            $(this).closest('tr').remove();
            $.ajax({
                type: "POST",
                url: url,
                data: {
                "id": id,
                "csrfmiddlewaretoken": '{{ csrf_token }}'
                },
                success: function (data) {
                // console.log("", data);
                toastr.info(data.message, 'Info', {
                    closeButton: true,
                    progressBar: true,
                    positionClass: 'toast-bottom-right',
                    timeOut: 6000
                });
                }
            });
            }else {
                Swal.fire("Cancel delete", "", "info");
            }
        });
    });

    $(document).on('input', '.quantity, .standard_cost, .vendor_quoted_cost', function (e) {
        $(".save-btn").show();
        $(".ok-btn").hide();
    });

    $(document).on('click', '.save-btn', function (e){
        // console.log("Clicked..............")
        var rowsData = [];
        $('tr.prod').each(function() {
            var $row = $(this);

            var rowData = {
                assign_prod_id: $row.find('.assign-pro-id').val(),
                quantity: $row.find('.quantity').val(),
                standard_cost: $row.find('.standard_cost').val(),
                vendor_quoted_cost: $row.find('.vendor_quoted_cost').val()
            };

            rowsData.push(rowData);
        });

        // console.log("rowData", rowsData)

        $.ajax({
            url: '{% url "proposal_app:opportunity:assign-prod-update-ajax" %}',
            type: 'POST',
            data: {
                type: 'bulk_update',
                rows: rowsData,
                document_number: "{{ document_number }}"
            },
            headers: {
                'X-CSRFToken': "{{ csrf_token }}",
            },
            success: function(response) {
                // console.log('API call success:', response);
                if (response.type){
                    window.location.reload();
                }else{
                    toastr.success(response.message, 'Success', {
                        closeButton: true,
                        progressBar: true,
                        positionClass: 'toast-bottom-right',
                        timeOut: 6000
                    });
                }

            },
            error: function(xhr, status, error) {
                console.error('API call error:', status, error);
                toastr.error(xhr.responseJSON.message, 'Error', {
                    closeButton: true,
                    progressBar: true,
                    positionClass: 'toast-bottom-right',
                    timeOut: 6000
                });
            }
        });
    });
</script>