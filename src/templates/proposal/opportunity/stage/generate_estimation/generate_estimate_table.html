{% load static %}
{% load custom_filters %}
<style>
  .dataTables_filter label input[type="search"] {
    margin-right: 75px;
  }

  tr.selected-estimate-row td{
    background: #d6e1f3;
  }

</style>
<!--
NOTE : For adding border lines into table add "table-bordered" class into table tag.
-->
<div class="table-responsive">
  <table class="table table-bordered custom-configuration" id="enstimate-table" style="width: 100% !important;">
    <thead>
        <tr style="border: 1px solid red">
          <th colspan="2"></th>
          <th colspan="5" class="align-top">Labor</th>
          <th colspan="6" class="align-top">Materials</th>
          <th colspan="2" class="align-top">Summary Info</th>
        </tr>
        <tr class="bg-white" style="z-index: 10">
            <th> Task Code </th>
            <th> Bid Item Description </th>
            <th>LABOR COST	</th>
            <th>LABOR GP%	</th>
            <th>LABOR GP $	</th>
            <th>LABOR SELL	</th>
            <th>MAT. COST	</th>
            <th>MAT.GP%	</th>
            <th>MAT. GP $	</th>
            <th>MAT. + MU	</th>
            <th>SALES TAX	</th>
            <th>S & H	</th>
            <th>MAT. SELL	</th>
            <th>MAT, TAX, LABOR	</th>
            <th>COMB GP% </th>
        </tr>
    </thead>
    <tbody class="align-center">

      {% for et in estimation_table %}
        <tr>
          {% if et.code %}
            <td class="text-nowrap labor">
              <a hx-get="{% url 'proposal_app:opportunity:update-estimation-products-ajax' et.id %}"
              data-url="{% url 'proposal_app:opportunity:update-estimation-products-ajax' et.id %}"
              class="htmx-trigger-btn-task-prod" hx-target="#task-content" hx-trigger="click" data-toggle="modal" data-target="#showProduct" data-backdrop="false">
                <ins> {{ et.code }} </ins>
              </a>
            </td>
            <td class="text-nowrap">
              <a hx-get="{% url 'proposal_app:opportunity:update-estimation-products-ajax' et.id %}"
              data-url="{% url 'proposal_app:opportunity:update-estimation-products-ajax' et.id %}"
              class="htmx-trigger-btn-task-prod" hx-target="#task-content" hx-trigger="click" data-toggle="modal" data-target="#showProduct" data-backdrop="false">
                <ins> {{ et.code }} : {{ et.description }} </ins>
              </a>
            </td>
          {% else %}
            <td class="text-nowrap labor">
              <a hx-get="{% url 'proposal_app:opportunity:update-estimation-products-ajax' et.id %}"
              data-url="{% url 'proposal_app:opportunity:update-estimation-products-ajax' et.id %}"
              class="htmx-trigger-btn-task-prod" hx-target="#task-content" hx-trigger="click" data-toggle="modal" data-target="#showProduct" data-backdrop="false">
                <ins> {{ et.task.name }} </ins>
              </a>
            </td>
            <td class="text-nowrap">
              <a hx-get="{% url 'proposal_app:opportunity:update-estimation-products-ajax' et.id %}"
              data-url="{% url 'proposal_app:opportunity:update-estimation-products-ajax' et.id %}"
              class="htmx-trigger-btn-task-prod" hx-target="#task-content" hx-trigger="click" data-toggle="modal" data-target="#showProduct" data-backdrop="false">
                <ins> {{ et.task.name }} : {{ et.task.description }} </ins>
              </a>
            </td>
          {% endif %}
          <input type="hidden" class="task_mapping" value={{ et.id }}>
          <td class="labor_cost">{{ et.labor_cost }}</td>
          <td>
            <input type="text" class="form-control btn-outline-warning labor_gp_percent" value="{{ et.labor_gp_percent }}">
          </td>
          <td class="labor_gp">{{ et.labor_gp }}</td>
          <td class="labor_sell">{{ et.labor_sell }}</td>
          <td class="mat_cost">{{ et.mat_cost }}</td>
          <td>
            <input type="text" class="form-control btn-outline-warning mat_gp_percent" value="{{ et.mat_gp_percent }}">
          </td>
          <td class="mat_gp">{{ et.mat_gp }}</td>
          <td class="mat_plus_mu">{{ et.mat_plus_mu }}</td>
          <td class="sales_tax">{{ et.sales_tax }}</td>
          <td>
            <input type="text" class="form-control btn-outline-warning s_and_h" value="{{ et.s_and_h }}">
          </td>
          <td class="mat_sell">{{ et.mat_sell }}</td>
          <td class="mat_tax_labor">{{ et.mat_tax_labor }}</td>
          <td class="comb_gp">{{ et.comb_gp }}</td>

        </tr>
      {% endfor %}

      <!-- Labor Removed -->
      {% comment %} {% for et_labor in task_labor_list %}
        <!-- Labor -->
        <tr class="selected-estimate-row">
          <input type="hidden" class="task_mapping" value={{ et_labor.id }}>
          <td class="text-nowrap">
            <a hx-get="{% url 'proposal_app:opportunity:update-estimation-labor-ajax' et_labor.id %}"
            data-url="{% url 'proposal_app:opportunity:update-estimation-labor-ajax' et_labor.id %}"
            hx-target="#task-labor-content" class="htmx-trigger-btn-task-labor" hx-trigger="click" data-toggle="modal" data-target="#showLabor" data-backdrop="false">
              <ins> {{ et_labor.task.name }} </ins>
            </a>
          </td>
          <td class="text-nowrap">
            <a hx-get="{% url 'proposal_app:opportunity:update-estimation-labor-ajax' et_labor.id %}"
            data-url="{% url 'proposal_app:opportunity:update-estimation-labor-ajax' et_labor.id %}"  hx-target="#task-labor-content" class="htmx-trigger-btn-task-labor" hx-trigger="click" data-toggle="modal" data-target="#showLabor" data-backdrop="false">
              <ins> {{ et_labor.task.name }}:{{ et_labor.task.description }} </ins>
            </a>
          </td>
          <td class="labor_cost">{{ et_labor.labor_cost }}</td>
          <td>
            <input type="text" class="form-control btn-outline-warning labor_gp_percent" value="{{ et_labor.labor_gp_percent }}">
          </td>
          <td class="labor_gp">{{ et_labor.labor_gp }}</td>
          <td class="labor_sell">{{ et_labor.labor_sell }}</td>
          <td class="mat_cost">{{ et_labor.mat_cost }}</td>
          <td>
            <input type="text" class="form-control btn-outline-warning mat_gp_percent" value="{{ et_labor.mat_gp_percent }}">
          </td>
          <td class="mat_gp">{{ et_labor.mat_gp }}</td>
          <td class="mat_plus_mu">{{ et_labor.mat_plus_mu }}</td>
          <td class="sales_tax">{{ et_labor.sales_tax }}</td>
          <td>
            <input type="text" class="form-control btn-outline-warning s_and_h" value="{{ et_labor.s_and_h }}">
          </td>
          <td class="mat_sell">{{ et_labor.mat_sell }}</td>
          <td class="mat_tax_labor">{{ et_labor.mat_tax_labor }}</td>
          <td class="comb_gp">{{ et_labor.comb_gp }}</td>

        </tr>
      {% endfor %} {% endcomment %}
      <tr>
        <td class="text-nowrap">FRT</td>
        <td class="text-nowrap">FRT: Freight</td>
        <td></td>
        <td></td>

        <td></td>
        <td></td>
        <td></td>
        <td></td>

        <td></td>
        <td></td>
        <td></td>
        <td>500.00</td>
        <td></td>

        <td></td>
        <td></td>

      </tr>
    </tbody>

    <!-- Overall Calculation -->
    <tfoot>
      <tr>
        <th></th>
        <th></th>
        <th id="total_labor_cost">${{ total.total_labor_cost }}</th>
        <th id="total_labor_gp_percent">{{ total.total_labor_gp_percent }}%</th>
        <th id="total_labor_gp">${{ total.total_labor_gp }}</th>
        <th id="total_labor_sell">${{ total.total_labor_sell }}</th>
        <th id="total_mat_cost">${{ total.total_mat_cost }}</th>
        <th id="total_mat_gp_percent">{{ total.total_mat_gp_percent }}%</th>
        <th id="total_mat_gp">${{ total.total_mat_gp }}</th>
        <th id="total_mat_mu">${{ total.total_mat_mu }}</th>
        <th id="total_sales_tax">${{ total.total_sales_tax }}</th>
        <th id="total_s_and_h">${{ total.total_s_and_h }}</th>
        <th id="total_mat_sell">${{ total.total_mat_sell }}</th>
        <th id="total_mat_tax_labor">${{ total.total_mat_tax_labor }}</th>
        <th></th>
      </tr>
    </tfoot>

  </table>
</div>

<div
  class="modal fade text-left"
  id="showProduct"
  tabindex="-1"
  role="dialog"
  aria-labelledby="myModalLabel33"
  aria-hidden="true"
  data-backdrop="false">
  <div class="modal-dialog modal-lg modal-dialog-centered" role="document" style="max-width: 1200px">
      <div class="modal-content">
          <div id="modalContent">
              <!-- Form content will be dynamically inserted here by HTMX -->
          </div>
      </div>
  </div>
</div>


<script src="{% static 'app/js/jquery.min.js' %}"></script>
<script>

  // New Version Code
  $(".labor_gp_percent, .mat_gp_percent, .s_and_h").on("input", function(e) {
    // Find the row of the element that was changed
    var $row = $(this).closest("tr");

    // Get the updated values for the row
    var laborGpPercent = parseFloat($row.find(".labor_gp_percent").val());
    var matGpPercent = parseFloat($row.find(".mat_gp_percent").val());
    var s_and_h = parseFloat($row.find(".s_and_h").val());

    $(".labor_gp_percent").val(laborGpPercent);
    $(".mat_gp_percent").val(matGpPercent);
    $(".s_and_h").val(s_and_h);

    // Loop through each row to update calculations for all rows
    $("table tbody tr").each(function() {
        var $row = $(this);

        // Get the values for this row
        var laborGpPercent = parseFloat($row.find(".labor_gp_percent").val()) / 100;
        var matGpPercent = parseFloat($row.find(".mat_gp_percent").val()) / 100;
        var s_and_h = parseFloat($row.find(".s_and_h").val()) / 100;

        // Calculate Labor Sell
        var laborCost = parseFloat($row.find(".labor_cost").text()) || 0;
        var laborSell = laborCost / (1 - laborGpPercent);
        $row.find(".labor_sell").text(laborSell.toFixed(2));

        // Calculate Labor GP $
        var laborGp = laborSell - laborCost;
        $row.find(".labor_gp").text(laborGp.toFixed(2));

        // Calculate Material values
        var matCost = parseFloat($row.find(".mat_cost").text()) || 0;
        var matPlusMu = matCost / (1 - matGpPercent);
        $row.find(".mat_plus_mu").text(matPlusMu.toFixed(2));

        // Calculate Material GP $
        var matGp = matPlusMu - matCost;
        $row.find(".mat_gp").text(matGp.toFixed(2));

        // Calculate Sales Tax for Material
        var salesTax = matPlusMu * 0.25;
        $row.find(".sales_tax").text(salesTax.toFixed(2));

        // Calculate Material Sell
        var matSell = matPlusMu + salesTax;
        $row.find(".mat_sell").text(matSell.toFixed(2));

        // Calculate MAT Tax Labor
        var matTaxLabor = matSell + laborSell;
        $row.find(".mat_tax_labor").text(matTaxLabor.toFixed(2));

        // Calculate Combined GP % for Labor and Material
        var combGp = ((laborGpPercent * 100) + (matGpPercent * 100)) / (laborSell + matPlusMu);
        $row.find(".comb_gp").text(combGp.toFixed(3));

        // Calculate $/Acre
        var acre = matTaxLabor / matGpPercent;
        $row.find(".acre").text((isNaN(acre) ? 0 : acre).toFixed(2));
    });

    // Update overall totals after modifying the row
    updateOverallTotals();

  });

  // Function to update overall totals
  function updateOverallTotals() {
      // Initialize totals
      var totalLaborCost = 0;
      var totalLaborGp = 0;
      var totalLaborSell = 0;
      var totalMatCost = 0;
      var totalMatGp = 0;
      var totalMatPlusMu = 0;
      var totalSalesTax = 0;
      var totalMatSell = 0;
      var totalMatTaxLabor = 0;
      var totalCombGp = 0;
      var totalAcre = 0;
      var totalSAndH = 0;
      var totalLaborGpPercent = 0;
      var totalMatGpPercent = 0;

      // Loop through all rows and accumulate totals
      $("table tbody tr").each(function() {
          var $row = $(this);

          var laborCost = parseFloat($row.find(".labor_cost").text()) || 0;
          var laborGp = parseFloat($row.find(".labor_gp").text()) || 0;
          var laborGpPercent = parseFloat($row.find(".labor_gp_percent").val()) || 0;
          var laborSell = parseFloat($row.find(".labor_sell").text()) || 0;
          var matCost = parseFloat($row.find(".mat_cost").text()) || 0;
          var matGp = parseFloat($row.find(".mat_gp").text()) || 0;
          var matGpPercent = parseFloat($row.find(".mat_gp_percent").val()) || 0;
          var matPlusMu = parseFloat($row.find(".mat_plus_mu").text()) || 0;
          var salesTax = parseFloat($row.find(".sales_tax").text()) || 0;
          var matSell = parseFloat($row.find(".mat_sell").text()) || 0;
          var matTaxLabor = parseFloat($row.find(".mat_tax_labor").text()) || 0;
          var combGp = parseFloat($row.find(".comb_gp").text()) || 0;
          var acre = parseFloat($row.find(".acre").text()) || 0;
          var s_and_h = parseFloat($row.find(".s_and_h").val()) || 0;

          totalLaborCost += laborCost;
          totalLaborGp += laborGp;
          totalLaborGpPercent += laborGpPercent;
          totalLaborSell += laborSell;
          totalMatCost += matCost;
          totalMatGp += matGp;
          totalMatGpPercent += matGpPercent;
          totalMatPlusMu += matPlusMu;
          totalSalesTax += salesTax;
          totalMatSell += matSell;
          totalMatTaxLabor += matTaxLabor;
          totalCombGp += combGp;
          totalAcre += acre;
          totalSAndH += s_and_h;
      });

      var total_cost = totalLaborCost + totalMatCost;
      var total_sale = totalLaborSell + totalMatSell;
      var total_gp = total_sale - total_cost;
      var total_gp_percent = total_gp / total_sale * 100;

      // Update totals in <tfoot>
      $("#total_labor_cost").text(`$ ${totalLaborCost.toFixed(2)}`);
      $("#total_labor_gp_percent").text(`${totalLaborGpPercent.toFixed(2)}%`);
      $("#total_labor_gp").text(`$ ${totalLaborGp.toFixed(2)}`);
      $("#total_labor_sell").text(`$ ${totalLaborSell.toFixed(2)}`);
      $("#total_mat_cost").text(`$ ${totalMatCost.toFixed(2)}`);
      $("#total_mat_gp_percent").text(`${totalMatGpPercent.toFixed(2)}%`);
      $("#total_mat_gp").text(`$ ${totalMatGp.toFixed(2)}`);
      $("#total_mat_mu").text(`$ ${totalMatPlusMu.toFixed(2)}`);
      $("#total_sales_tax").text(`$ ${totalSalesTax.toFixed(2)}`);
      $("#total_s_and_h").text(`$${totalSAndH.toFixed(2)}`);
      $("#total_mat_sell").text(`$ ${totalMatSell.toFixed(2)}`);
      $("#total_mat_tax_labor").text(`$ ${totalMatTaxLabor.toFixed(2)}`);
      $("#total_comb_gp").text(`${totalCombGp.toFixed(2)}%`);
      $("#total_acre").text(`${(isNaN(totalAcre) ? 0 : totalAcre).toFixed(2)}`);

      $("#total_cost").text(`$ ${total_cost.toFixed(2)}`);
      $("#total_sale").text(`$ ${total_sale.toFixed(2)}`);
      $(".total_gp").text(`$ ${total_gp.toFixed(2)}`);
      $("#total_gp_percent").text(`${total_gp_percent.toFixed(2)}%`);
  }

  // Save changed value.
  $(".labor_gp_percent, .mat_gp_percent, .s_and_h").on("change", function(e){

      var $row = $(this).closest("tr");
      var $input = $(e.target);
      var document_number = "{{ document_number }}"

      var taskMappingId = $row.find(".task_mapping").val();
      var laborGpPercent = $row.find(".labor_gp_percent").val();
      var matGpPercent = $row.find(".mat_gp_percent").val();
      var s_and_h = $row.find(".s_and_h").val();

      if ($input.hasClass("labor_gp_percent")){
          data = {
            task_mapping_id: taskMappingId,
            document_number: document_number,
            labor_gp_percent: laborGpPercent,
          }
      } else if ($input.hasClass("mat_gp_percent")){
          data = {
            task_mapping_id: taskMappingId,
            document_number: document_number,
            mat_gp_percent: matGpPercent,
          }
      } else if ($input.hasClass("s_and_h")){
          data = {
            task_mapping_id: taskMappingId,
            document_number: document_number,
            s_and_h: s_and_h,
          }
      }

      // Call Ajax
      $.ajax({
        url: '{% url "proposal_app:opportunity:update-estimation-table-ajax" %}',
        type: 'POST',
        data: data,
        headers: {
          'X-CSRFToken': "{{ csrf_token }}",
        },
        success: function(response) {
          // console.error('API Response:', response);
          if (response.code == "200"){
            toastr.success(response.message, 'Success', {
              closeButton: true,
              progressBar: true,
              positionClass: 'toast-bottom-right',
              timeOut: 6000
            });
          } else if (response.code == "400"){
            toastr.error(response.message, 'Error', {
              closeButton: true,
              progressBar: true,
              positionClass: 'toast-bottom-right',
              timeOut: 6000
            });
          }
        },
        error: function(xhr, status, error) {
          // console.error('API call error:', status, error);
          toastr.error(xhr.responseJSON.message, 'Error', {
            closeButton: true,
            progressBar: true,
            positionClass: 'toast-bottom-right',
            timeOut: 6000
          });
        }
      });

  });

</script>