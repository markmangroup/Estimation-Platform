{% load static %}

<!-- Loader HTML -->
<div id="loader-container" style="display: none;">
    <div id="loader">
        <div class="spinner-border" role="status">
            <span class="sr-only">Loading...</span>
        </div>
        <p>Customer Import...</p>
    </div>
</div>

<div class="modal-header">
    <h4 class="modal-title" id="myModalLabel5">
        Import Customer
    </h4>
    <button
        type="button"
        class="close"
        data-dismiss="modal"
        aria-label="Close"
    >
        <span aria-hidden="true">
            <i class="ft-x font-medium-2 text-bold-700"></i>
        </span>
    </button>
</div>
<form id="importCustomerForm" hx-post="{% url 'proposal_app:customer:import-customer' %}" hx-target="#modalContent" hx-swap="#inlineForm" enctype="multipart/form-data" novalidate>
    {% csrf_token %}
    <div class="modal-body">
        <label>Upload File </label>
        <div class="form-group">
            <div class="custom-file">
                <input
                    type="file"
                    name="csv_file"
                    class="custom-file-input"
                    id="inputGroupFile02"
                    accept=".xlsx, .xls"
                    required
                    onchange="updateFileName(this)"
                />
                <label class="custom-file-label" for="inputGroupFile02">Choose file</label>
                {% if form.csv_file.errors %}
                    {% for error in form.csv_file.errors %}
                        <p style="color: red;">{{ error }}</p>
                    {% endfor %}
                {% endif %}
                <small class="form-text text-muted">{{ form.csv_file.help_text }}</small>
            </div>
        </div>
    </div>
    <div class="modal-footer">
        <button type="submit"  class="btn btn-primary">Upload</button>
    </div>
</form>

<script>
    function updateFileName(input) {
        var fileName = input.files[0] ? input.files[0].name : 'Choose file';
        var label = input.nextElementSibling;
        label.textContent = fileName;
    }
</script>

<script>
    $(document).ready(function() {
        $('#importCustomerForm').on('submit', function(event) {
            event.preventDefault();

            var $form = $(this);
            var formData = new FormData(this);
            var $loader = $('#loader-container');

            $loader.show();

            $.ajax({
                url: "{% url 'proposal_app:customer:import-customer' %}",
                type: 'POST',
                data: formData,
                processData: false,
                contentType: false,
                headers: {
                    'X-CSRFToken': $form.find('[name=csrfmiddlewaretoken]').val()
                },
                success: function(response) {
                    if(response.status == "success" || response.code == 200) {
                        $loader.hide();
                        $("#inlineForm").modal('hide');
                        $("#inlineForm .modal-body").html('');
                        $("#customer-table").DataTable().ajax.reload(null, false);
                        toastr.success(response.message, 'Success', {
                            closeButton: true,
                            progressBar: true,
                            positionClass: 'toast-bottom-right',
                            timeOut: 6000
                        });
                    }
                },
                error: function(e) {
                    $loader.hide();
                }
            });
        });
    });
</script>