{% load static %}

<div class="d-flex justify-content-end">
  <button
    type="button"
    class="btn bg-light-secondary htmx-trigger-btn mb-2"
    hx-get="{% url 'opportunity:select-task-model' opportunity.document_number %}"
    hx-target="#selectTaskModal"
    hx-trigger="click"
    data-toggle="modal"
    data-target="#selectTaskModal"
  >
    <em class="ft-plus font-medium-5"></em> Add Tasks
  </button>
</div>

<!-- Select Task Modal Start -->
<div class="modal fade text-left" id="selectTaskModal" tabindex="-1" role="dialog" aria-labelledby="myModalLabel33" aria-hidden="true" data-backdrop="false">
  <div class="modal-dialog modal-dialog-centered" role="document">
      <div class="modal-content">
          <div id="modelSelectTask">
              <!-- Content loaded by htmx will appear here -->
          </div>
      </div>
  </div>
</div>
<!-- Select Task Modal End -->

<div class="table-responsive">
  <table id= "selected-task-table" class="table table-striped table-bordered">
    <thead>
        <tr>
            <th>Internal ID</th>
            <th>Name</th>
            <th>Description</th>
        </tr>
    </thead>
  </table>
</div>

<!-- Htmx -->
<script>
  $(document).on('click', '.htmx-trigger-btn' , function (e) {
    url = "{% url 'opportunity:select-task-model' opportunity.document_number %}"
    htmx.ajax('GET',
        url,
        {
          target:'#modelSelectTask',
          swap:'innerHTML',
    }).then(() => {
        $('#selectTaskModal').toggleClass('hidden');
    })
  })
</script>
<!-- Htmx -->

<!-- Datatabele -->
<script>
  var table_task = initializeDataTable();

  function initializeDataTable() {
      return $('#selected-task-table').DataTable({
          processing: true,
          serverSide: true,
          destroy: true,
          ajax: {
              url: "{% url 'opportunity:ajax-selected-task-list' opportunity.document_number %}",
              type: 'GET',
          },
          columns: [
          { data: 'task__internal_id', name: 'task__internal_id' },
          { data: 'task__name', name: 'task__name' },
          { data: 'task__description', name: 'task__description' }
        ],

      });
  }
</script>
<!-- Datatabele -->


<!-- Go to Current Stage -->
<script>
  $(document).ready(function() {
    var foundElements = $(".steps li").find(".current a");

  });
</script>
<!-- Go to Current Stage -->

<!-- Update Stages -->
<script>
  $(document).ready(function() {
    $("a[href='#next']").on("click", function(e) {
      console.log("Next Clicked");
      var foundElements = $(".steps li").find(".current");
      if (foundElements){
        value = $(".current a span.step").text();
        $.ajax({
          url: '{% url "opportunity:update-stages" %}',
          type: 'POST',
          contentType: 'application/json',
          data: JSON.stringify({
            document_number: "{{opportunity.document_number}}",
            stage: `STAGE_${value}`,
          }),
          headers: {
              'X-CSRFToken': "{{ csrf_token }}",
          },
          success: function(response) {
              if (response.error) {
                console.log("Error!!",response.error);
              } else {
                  console.log("Success!!");
              }
          },
          error: function(xhr, status, error) {
              console.error('Error:', error);
          }
        });
      }
      else{
        console.log("Not found elements:");
      }
    });

    $("a[href='#previous']").on("click", function(e) {
      console.log("Previous Clicked");
      var foundElements = $(".steps li").find(".current");
      if (foundElements){
        value = $(".current a span.step").text();
      }
      else{
        console.log("Not found elements:");
      }
    });
  });
</script>
<!-- Update Stages -->